import*as c from"three";import{Color as V,SphereGeometry as Ge,MeshBasicMaterial as Je,Mesh as Ke,Vector3 as v,MathUtils as wi,Texture as Ve,RepeatWrapping as Le,Vector2 as Ce,ShaderMaterial as bi,DoubleSide as vi,UniformsLib as Te,Curve as qt,Vector4 as k,Raycaster as et,Plane as lt,EquirectangularReflectionMapping as Pi,NearestFilter as Ci,Group as yi}from"three";import{OrbitControls as Be,TransformControls as Ue,LineGeometry as De,LineMaterial as Mi,Line2 as xi,EXRLoader as Ei,EffectComposer as Si,RenderPass as Oi,OutputPass as Hi,OBJExporter as Ii,STLExporter as ji,GLTFExporter as Vi}from"three/examples/jsm/Addons.js";import{TextureElement as _,Vec2Element as ye,ButtonSelectElement as $e,SliderElement as j,LaceElement as Li,LabelElement as D,TextElement as ct,Vec3Element as A,ColorElement as J,BooleanElement as Zt,TextSelectElement as Ut,SeperatorElement as Qt,ButtonElement as Re,NumberSelectElement as Gt,Lace as Ti}from"lacery";import{registerIconLibrary as Bi}from"@shoelace-style/shoelace";class Me{data;width;height;texture;columnConnectionVisuals;rowConnectionVisuals;connectionParentMesh=null;connectionMaterial;constructor(t=4,e=4,i=1.25){this.width=t,this.height=e,this.data=new Float32Array(this.width*this.height*4),this.texture=new c.DataTexture(this.data,this.width,this.height,c.RGBAFormat,c.FloatType),this.texture.minFilter=this.texture.magFilter=c.NearestFilter,this.texture.generateMipmaps=!1,this.texture.needsUpdate=!0,this.connectionMaterial=new c.LineBasicMaterial({color:R(),depthTest:!1,transparent:!0}),this.columnConnectionVisuals=[];for(let n=0;n<this.width;n++){const s=new c.BufferGeometry().setFromPoints(this.getColumn(n)),r=new c.Line(s,this.connectionMaterial);r.renderOrder=1e3,r.castShadow=!0,this.columnConnectionVisuals.push(r)}this.rowConnectionVisuals=[];for(let n=0;n<this.height;n++){const s=new c.BufferGeometry().setFromPoints(this.getRow(n)),r=new c.Line(s,this.connectionMaterial);r.renderOrder=1e3,r.castShadow=!0,this.rowConnectionVisuals.push(r)}}getTexture(){return this.texture}getWidth(){return this.width}getHeight(){return this.height}toString(){let t=`DynamicVec3Grid: ${this.width}x${this.height}
`;for(let e=0;e<this.height;e++){for(let i=0;i<this.width;i++){const n=(e*this.width+i)*4;t+=`(${this.data[n].toFixed(2)}, ${this.data[n+1].toFixed(2)}, ${this.data[n+2].toFixed(2)}, ${this.data[n+3].toFixed(2)}) `}t+=`
`}return t}addVisuals(t){if(this.connectionParentMesh===null){this.connectionParentMesh=t;for(let e=0;e<this.width;e++)this.columnConnectionVisuals[e].visible=!1,t.add(this.columnConnectionVisuals[e]);for(let e=0;e<this.height;e++)this.rowConnectionVisuals[e].visible=!1,t.add(this.rowConnectionVisuals[e])}}showVisuals(){for(let t=0;t<this.width;t++)this.columnConnectionVisuals[t].visible=!0;for(let t=0;t<this.height;t++)this.rowConnectionVisuals[t].visible=!0}hideVisuals(){for(let t=0;t<this.width;t++)this.columnConnectionVisuals[t].visible=!1;for(let t=0;t<this.height;t++)this.rowConnectionVisuals[t].visible=!1}getPoint4(t,e){if(t<0||t>=this.height||e<0||e>=this.width)throw new Error("Index out of bounds");const i=(t*this.width+e)*4;return new c.Vector4(this.data[i],this.data[i+1],this.data[i+2],this.data[i+3])}getPoint(t,e){if(t<0||t>=this.height||e<0||e>=this.width)throw new Error("Index out of bounds");const i=(t*this.width+e)*4;return new c.Vector3(this.data[i],this.data[i+1],this.data[i+2])}getPoints4(){const t=[];for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){const n=(e*this.width+i)*4;t.push(new c.Vector4(this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]))}return t}getPoints(){const t=[];for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){const n=(e*this.width+i)*4;t.push(new c.Vector3(this.data[n],this.data[n+1],this.data[n+2]))}return t}setPoint4(t,e,i){if(t<0||t>=this.height||e<0||e>=this.width)throw new Error("Index out of bounds");const n=(t*this.width+e)*4;this.data[n]=i.x,this.data[n+1]=i.y,this.data[n+2]=i.z,this.data[n+3]=i.w,this.texture.needsUpdate=!0;const s=new c.BufferGeometry().setFromPoints(this.getColumn(e));this.columnConnectionVisuals[e].geometry.dispose(),this.columnConnectionVisuals[e].geometry=s;const r=new c.BufferGeometry().setFromPoints(this.getRow(t));this.rowConnectionVisuals[t].geometry.dispose(),this.rowConnectionVisuals[t].geometry=r}setPoint(t,e,i){this.setPoint4(t,e,new c.Vector4(i.x,i.y,i.z,1))}getColumn4(t){if(t<0||t>=this.width)throw new Error("Index out of bounds");const e=[];for(let i=0;i<this.height;i++){const n=(i*this.width+t)*4;e.push(new c.Vector4(this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]))}return e}getColumn(t){if(t<0||t>=this.width)throw new Error("Index out of bounds");const e=[];for(let i=0;i<this.height;i++){const n=(i*this.width+t)*4;e.push(new c.Vector3(this.data[n],this.data[n+1],this.data[n+2]))}return e}getRow4(t){if(t<0||t>=this.height)throw new Error("Index out of bounds");const e=[];for(let i=0;i<this.width;i++){const n=(t*this.width+i)*4;e.push(new c.Vector4(this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]))}return e}getRow(t){if(t<0||t>=this.height)throw new Error("Index out of bounds");const e=[];for(let i=0;i<this.width;i++){const n=(t*this.width+i)*4;e.push(new c.Vector3(this.data[n],this.data[n+1],this.data[n+2]))}return e}addColumn(t,e=!1){this.resizeBuffer(this.width+1,this.height),e&&this.shiftColumnRight();const i=e?0:this.width-1,n=e?1:this.width-2,s=new c.BufferGeometry().setFromPoints(this.getColumn(i)),r=new c.Line(s,this.connectionMaterial);r.renderOrder=1e3,r.castShadow=!0,e?this.columnConnectionVisuals.unshift(r):this.columnConnectionVisuals.push(r),this.connectionParentMesh?.add(this.columnConnectionVisuals[i]);const a=this.getColumn(n);for(let h=0;h<this.height;h++){const d=a[h].clone().sub(t);this.setPoint(h,i,d)}}removeColumn(t=!1){if(!(this.width<=2)){t&&this.shiftColumnLeft(),this.resizeBuffer(this.width-1,this.height),t?(this.connectionParentMesh?.remove(this.columnConnectionVisuals[0]),this.columnConnectionVisuals.shift()):(this.connectionParentMesh?.remove(this.columnConnectionVisuals[this.width]),this.columnConnectionVisuals.pop());for(let e=0;e<this.height;e++){const i=new c.BufferGeometry().setFromPoints(this.getRow(e));this.rowConnectionVisuals[e].geometry.dispose(),this.rowConnectionVisuals[e].geometry=i}}}addRow(t,e=!1){this.resizeBuffer(this.width,this.height+1),e&&this.shiftRowDown();const i=e?0:this.height-1,n=e?1:this.height-2,s=new c.BufferGeometry().setFromPoints(this.getRow(i)),r=new c.Line(s,this.connectionMaterial);r.renderOrder=1e3,r.castShadow=!0,e?this.rowConnectionVisuals.unshift(r):this.rowConnectionVisuals.push(r),this.connectionParentMesh?.add(this.rowConnectionVisuals[i]);const a=this.getRow(n);for(let h=0;h<this.width;h++){const d=a[h].clone().sub(t);this.setPoint(i,h,d)}}removeRow(t=!1){if(!(this.height<=2)){t&&this.shiftRowUp(),this.resizeBuffer(this.width,this.height-1),t?(this.connectionParentMesh?.remove(this.rowConnectionVisuals[0]),this.rowConnectionVisuals.shift()):(this.connectionParentMesh?.remove(this.rowConnectionVisuals[this.height]),this.rowConnectionVisuals.pop());for(let e=0;e<this.width;e++){const i=new c.BufferGeometry().setFromPoints(this.getColumn(e));this.columnConnectionVisuals[e].geometry.dispose(),this.columnConnectionVisuals[e].geometry=i}}}shiftColumnRight(){for(let t=0;t<this.height;t++)for(let e=this.width-1;e>0;e--){const i=(t*this.width+e)*4,n=(t*this.width+(e-1))*4;this.data.set(this.data.slice(n,n+4),i)}}shiftColumnLeft(){for(let t=0;t<this.height;t++)for(let e=0;e<this.width-1;e++){const i=(t*this.width+e)*4,n=(t*this.width+(e+1))*4;this.data.set(this.data.slice(n,n+4),i)}}shiftRowDown(){for(let t=this.height-1;t>0;t--)for(let e=0;e<this.width;e++){const i=(t*this.width+e)*4,n=((t-1)*this.width+e)*4;this.data.set(this.data.slice(n,n+4),i)}}shiftRowUp(){for(let t=0;t<this.height-1;t++)for(let e=0;e<this.width;e++){const i=(t*this.width+e)*4,n=((t+1)*this.width+e)*4;this.data.set(this.data.slice(n,n+4),i)}}resizeBuffer(t,e){const i=new Float32Array(t*e*4);for(let n=0;n<this.height&&!(n>=e);n++)for(let s=0;s<this.width&&!(s>=t);s++){const r=(n*this.width+s)*4,a=(n*t+s)*4;i.set(this.data.slice(r,r+4),a)}this.width=t,this.height=e,this.data=i,this.texture.dispose(),this.texture=new c.DataTexture(this.data,t,e,c.RGBAFormat,c.FloatType),this.texture.minFilter=this.texture.magFilter=c.NearestFilter,this.texture.generateMipmaps=!1,this.texture.needsUpdate=!0}}const M={allEvents:new Map,generalEvents:new Map,viewportEvents:new Map,inspectorEvents:new Map,hierarchyEvents:new Map,subscribe(o,t,e){let i;switch(t){case"all":i=this.allEvents;break;case"general":i=this.generalEvents;break;case"viewport":i=this.viewportEvents;break;case"inspector":i=this.inspectorEvents;break;case"hierarchy":i=this.hierarchyEvents;break}i.has(o)||i.set(o,[]),i.get(o).push(e)},unsubscribe(o,t,e){let i;switch(t){case"all":i=this.allEvents;break;case"general":i=this.generalEvents;break;case"viewport":i=this.viewportEvents;break;case"inspector":i=this.inspectorEvents;break;case"hierarchy":i=this.hierarchyEvents;break}if(i.has(o)){const n=i.get(o).indexOf(e);n!==-1&&i.get(o).splice(n,1)}},notify(o,t,e){let i;switch(t){case"all":{for(const n of[this.allEvents,this.generalEvents,this.viewportEvents,this.inspectorEvents,this.hierarchyEvents])if(n.has(o))for(const s of n.get(o))s(e);return}case"general":i=this.generalEvents;break;case"viewport":i=this.viewportEvents;break;case"inspector":i=this.inspectorEvents;break;case"hierarchy":i=this.hierarchyEvents;break}if(i.has(o))for(const n of i.get(o))n(e);if(this.allEvents.has(o))for(const n of this.allEvents.get(o))n(e)}};var y=(o=>(o.ALL="all",o.GENERAL="general",o.VIEWPORT="viewport",o.INSPECTOR="inspector",o.HIERARCHY="hierarchy",o))(y||{});class l{static app;static scene;static pCamera;static oCamera;static renderer;static effectComposer;static orbitControls;static oOrbitControls;static transformControls;static oTransformControls;static ambientLight;static directionalLight;static grid;static plane;static tooltip;static objectManager;static creationManager;static selectionManager;static editManager;static effectManager;static ioManager;static interactionsManager;static exportManager;static inspector;static hierarchy;static toolbar;static controls;static sceneProxy;static isOrbitingBool=!1;static isDraggingBool=!1;static is2D=!1;static isDarkMode=!1;static dimension2D(){return this.is2D}static switchDimension(){this.is2D?(this.is2D=!1,this.oTransformControls.detach(),this.orbitControls.enabled=!0,this.oOrbitControls.enabled=!1,this.directionalLight.position.set(10,25,0),this.directionalLight.target.position.set(0,0,0)):(this.is2D=!0,this.transformControls.detach(),this.orbitControls.enabled=!1,this.oOrbitControls.enabled=!0,this.directionalLight.position.set(0,100,0),this.directionalLight.target.position.set(0,0,0)),l.getEffectManager().setupRenderPass(),l.getSelectionManager().doResetSelectedEditHandle(),M.notify("dimensionSwitched",y.ALL,this.is2D)}static darkMode(){return this.isDarkMode}static setMode(t=!1){t?(this.isDarkMode=!0,this.app.classList.remove("sl-theme-light"),this.app.classList.add("sl-theme-dark")):(this.isDarkMode=!1,this.app.classList.add("sl-theme-light"),this.app.classList.remove("sl-theme-dark")),l.getScene().background=new V(be()),l.getIOManager().setFlagCache("darkMode",this.isDarkMode),M.notify("modeSwitched",y.ALL,this.isDarkMode)}static getApp(){return this.app}static setApp(t){this.app=t}static getScene(){return this.scene}static getCamera(){return this.is2D?this.oCamera:this.pCamera}static getPerspectiveCamera(){return this.pCamera}static getOrthographicCamera(){return this.oCamera}static getRenderer(){return this.renderer}static getOrbitControls(){return this.is2D?this.oOrbitControls:this.orbitControls}static onOrbitControlsChange(t){this.orbitControls.addEventListener("change",()=>{this.is2D||t()}),this.oOrbitControls.addEventListener("change",()=>{this.is2D&&t()})}static onTransformControlsChange(t){this.transformControls.addEventListener("change",()=>{this.is2D||t()}),this.oTransformControls.addEventListener("change",()=>{this.is2D&&t()})}static onControlsChange(t){this.onOrbitControlsChange(t),this.onTransformControlsChange(t),M.subscribe("dimensionSwitched",y.ALL,()=>{t()})}static noScroll(){this.orbitControls.enableZoom=!1,this.oOrbitControls.enableZoom=!1}static scroll(){this.orbitControls.enableZoom=!0,this.oOrbitControls.enableZoom=!0}static getTransformControls(){return this.is2D?this.oTransformControls:this.transformControls}static getAmbientLight(){return this.ambientLight}static getDirectionalLight(){return this.directionalLight}static setupScene(t,e,i,n,s,r,a,h,d,u){this.scene=t,this.pCamera=e,this.oCamera=i,this.renderer=n,this.orbitControls=s,this.orbitControls.addEventListener("start",()=>this.isOrbitingBool=!0),this.orbitControls.addEventListener("end",()=>this.isOrbitingBool=!1),this.oOrbitControls=r,this.oOrbitControls.addEventListener("start",()=>this.isOrbitingBool=!0),this.oOrbitControls.addEventListener("end",()=>this.isOrbitingBool=!1),this.transformControls=a,this.transformControls.addEventListener("dragging-changed",m=>{this.orbitControls.enabled=!m.value,this.isDraggingBool=m.value}),this.scene.add(this.transformControls.getHelper()),this.oTransformControls=h,this.oTransformControls.addEventListener("dragging-changed",m=>{this.oOrbitControls.enabled=!m.value,this.isDraggingBool=m.value}),this.scene.add(this.oTransformControls.getHelper()),this.ambientLight=d,this.directionalLight=u}static getEffectComposer(){return this.effectComposer}static setEffectComposer(t){this.effectComposer=t}static getGrid(){return this.grid}static getPlane(){return this.plane}static setupGrid(t,e){this.grid=t,this.plane=e}static getTooltip(){return this.tooltip}static setTooltip(t){this.tooltip=t}static getObjectManager(){return this.objectManager}static setObjectManager(t){this.objectManager=t}static getCreationManager(){return this.creationManager}static setCreationManager(t){this.creationManager=t}static getSelectionManager(){return this.selectionManager}static setSelectionManager(t){this.selectionManager=t}static getEditManager(){return this.editManager}static setEditManager(t){this.editManager=t}static getEffectManager(){return this.effectManager}static setEffectManager(t){this.effectManager=t}static getIOManager(){return this.ioManager}static setIOManager(t){this.ioManager=t}static getInteractionsManager(){return this.interactionsManager}static setInteractionsManager(t){this.interactionsManager=t}static getExportManager(){return this.exportManager}static setExportManager(t){this.exportManager=t}static getInspector(){return this.inspector}static setInspector(t){this.inspector=t}static getHierarchy(){return this.hierarchy}static setHierarchy(t){this.hierarchy=t}static getToolbar(){return this.toolbar}static setToolbar(t){this.toolbar=t}static getControls(){return this.controls}static setControls(t){this.controls=t}static getSceneProxy(){return this.sceneProxy}static setSceneProxy(t){this.sceneProxy=t}static isOrbiting(){return this.isOrbitingBool}static isDragging(){return this.isDraggingBool}static getDefaultImage(){const t=new Image;t.width=1,t.height=1;const e=document.createElement("canvas");e.width=1,e.height=1;const i=e.getContext("2d");return i&&(i.fillStyle="#FFFFFF",i.fillRect(0,0,1,1),t.src=e.toDataURL()),t}}const Q=async(o,t)=>{const e=`textures/${o}/${t}`,i=await fetch(e);if(!i.ok)return null;const n=await i.blob();return n.size===0||n.type==="text/html"?null:n};class _e{parentObject;index;radius;mesh;material;constructor(t,e,i=.2){this.parentObject=t,this.index=e,this.radius=i;const n=new Ge(this.radius);this.material=new Je({color:Jt(),depthTest:!1,transparent:!0}),this.mesh=new Ke(n,this.material),this.mesh.castShadow=!0,this.mesh.renderOrder=1001,this.adjustScale(),l.onControlsChange(this.adjustScale.bind(this)),M.subscribe("modeSwitched",y.ALL,()=>{this.material.color.set(Jt())})}getMesh(){return this.mesh}getParentObject(){return this.parentObject}getIndex(){return this.index}getPosition(){return this.mesh.position.clone()}getWorldPosition(){return this.mesh.getWorldPosition(new v)}setPosition(t){this.mesh.position.set(t.x,t.y,t.z)}highlight(){this.material.color.set(it())}resetHighlight(){this.material.color.set(Jt())}select(){this.material.color.set(R())}resetSelect(){this.material.color.set(Jt())}hide(){this.mesh.visible=!1}show(){this.mesh.visible=!0}getActive(){return this.mesh.visible}adjustScale(){if(l.dimension2D()){this.mesh.scale.set(1,1,1);return}const t=this.mesh.position.distanceTo(l.getCamera().position),i=Math.abs(t)/10,n=Math.max(1,Math.min(i,20));this.mesh.scale.set(n,n,n)}}class q{name;mesh;uuid;type;export;color=new V(0);editHandles;constructor(t,e,i=new v(0,0,0)){this.name=t,this.mesh=e,this.mesh.position.set(i.x,i.y,i.z),this.mesh.castShadow=!0,this.mesh.frustumCulled=!1,this.uuid=wi.generateUUID(),this.type="VisualObject",this.export=null,this.editHandles=new Map}getName(){return this.name}setName(t){this.name=t}getColor(){return this.color.clone()}setColor(t){this.color.set(t)}getUUID(){return this.uuid}getType(){return this.type}getExport(){return this.export}getMesh(){return this.mesh}getPosition(){const t=new v;return t.copy(this.mesh.position),t}setPosition(t){this.mesh.position.set(t.x,t.y,t.z)}move(t,e,i){var n=this.getPosition();n&&(n.x+=t,n.y+=e,n.z+=i,this.setPosition(n))}moveX(t){this.move(t,0,0)}moveY(t){this.move(0,t,0)}moveZ(t){this.move(0,0,t)}edit(){return console.warn("VisualObject: Edit not implemented!"),()=>{console.error("VisualObject: Edit not implemented!")}}createEditHandle(t,e=.2){const i=new _e(this,t,e);this.editHandles.set(t,i),l.getObjectManager().addEditHandle(i)}hasEditHandle(t){return this.editHandles.has(t)}setEditHandlePosition(t,e){if(!this.editHandles.has(t)){console.error("VisualObject:setEditHandlePosition: Edit handle not found!");return}const i=this.editHandles.get(t);i&&i.setPosition(e)}getEditHandlePosition(t){if(!this.editHandles.has(t))return console.error("VisualObject:getEditHandlePosition: Edit handle not found!"),null;const e=this.editHandles.get(t);return e?e.getPosition():null}removeEditHandle(t){if(!this.editHandles.has(t)){console.error("VisualObject:removeEditHandle: Edit handle not found!");return}const e=this.editHandles.get(t);e&&(l.getObjectManager().removeEditHandle(e),this.editHandles.delete(t))}removeEditHandles(){this.editHandles.forEach((t,e)=>{l.getObjectManager().removeEditHandle(t)}),this.editHandles.clear()}hideEditHandle(t){if(!this.editHandles.has(t)){console.error("VisualObject:hideEditHandle: Edit handle not found!");return}const e=this.editHandles.get(t);e&&e.hide()}showEditHandle(t){if(!this.editHandles.has(t)){console.error("VisualObject:showEditHandle: Edit handle not found!");return}const e=this.editHandles.get(t);e&&e.show()}hideEditHandles(){this.editHandles.forEach((t,e)=>{t.hide()})}showEditHandles(){this.editHandles.forEach((t,e)=>{t.show()})}unedit(){console.warn("VisualObject: Unedit not implemented!")}}function Ui(){return`
    uniform sampler2D controlPointsTexture;
    uniform int controlPointsWidth;
    uniform int controlPointsHeight;
    uniform vec3 color;

    varying vec3 vColor;
    varying vec3 vNormal;
    varying vec3 vPosition;
    varying vec2 vUV;
    varying vec3 vViewPosition;
    varying mat3 vTBN;
    varying vec3 vWorldNormal;

    float binomial(int n, int k){
        if(k > n) return 0.0;
        if(k == 0 || k == n) return 1.0;
        float res = 1.0;
        for(int i = 0; i < k; i++){
            res *= float(n - i) / float(i + 1);
        }
        return res;
    }

    float bernstein(int n, int i, float t){
        return binomial(n, i) * pow(t, float(i)) * pow(1.0 - t, float(n - i));
    }

    // Derivative of the Bernstein polynomial with respect to t
    float bernsteinDerivative(int n, int i, float t) {
        if (i == 0) return -float(n) * bernstein(n - 1, i, t);
        if (i == n) return float(n) * bernstein(n - 1, i - 1, t);
        return float(n) * (bernstein(n - 1, i - 1, t) - bernstein(n - 1, i, t));
    }

    vec3 getControlPoint(int i, int j){
        vec2 texCoord = vec2(float(i) / float(controlPointsWidth - 1), float(j) / float(controlPointsHeight - 1));
        return texture2D(controlPointsTexture, texCoord).xyz;
    }

    void main(){
        vec2 uvClamped = clamp(uv, 0.0001, 0.9999);
        float u = uvClamped.x;
        float v = uvClamped.y;

        vec3 bezierPoint = vec3(0.0);
        vec3 tangentU = vec3(0.0);
        vec3 tangentV = vec3(0.0);

        for(int i = 0; i < controlPointsWidth; i++){
            float bernsteinU = bernstein(controlPointsWidth - 1, i, u);
            float bernsteinUDerivative = bernsteinDerivative(controlPointsWidth - 1, i, u);
            for(int j = 0; j < controlPointsHeight; j++){
                vec3 controlPoint = getControlPoint(i, j);
                float bernsteinV = bernstein(controlPointsHeight - 1, j, v);
                float bernsteinVDerivative = bernsteinDerivative(controlPointsHeight - 1, j, v);
                bezierPoint += controlPoint * bernsteinU * bernsteinV;
                tangentU += controlPoint * bernsteinUDerivative * bernsteinV;
                tangentV += controlPoint * bernsteinU * bernsteinVDerivative;
            }
        }

        vColor = color;
        vec3 normal = normalize(cross(tangentU, tangentV));
        vNormal = - normalize(normalMatrix * normal);
        vWorldNormal = normalize(mat3(modelMatrix) * normal);
        vPosition = (modelMatrix * vec4(bezierPoint, 1.0)).xyz;
        vUV = uvClamped;
        vec4 mvPosition = modelViewMatrix * vec4(bezierPoint, 1.0);
        vViewPosition = -mvPosition.xyz;
        gl_Position = projectionMatrix * mvPosition;

        mat3 TBN = mat3(
            normalize(normalMatrix * tangentU),
            normalize(normalMatrix * tangentV),
            vNormal
        );
        
        vTBN = TBN;
    }
`}function tt(o,t,e){if(o.length!==t*e)throw console.error("Invalid points array length:",o.length,"Expected:",t*e,t,e),new Error("Points array length must match width * height");const i=new c.BufferGeometry,n=[],s=[];for(const r of o)n.push(r.x,r.y,r.z);for(let r=0;r<e-1;r++)for(let a=0;a<t-1;a++){const h=r*t+a,d=h+1,u=h+t,m=u+1;s.push(h,u,d),s.push(d,u,m)}return i.setAttribute("position",new c.Float32BufferAttribute(n,3)),i.setIndex(s),i.computeVertexNormals(),i}const yt={};function Di(o,t){if(t===0||t===o)return 1;if(yt[o]&&yt[o][t])return yt[o][t];for(var e=1,i=1;i<=t;i++)e*=(o-i+1)/i;return yt[o]||(yt[o]={}),yt[o][t]=e,e}function Xe(o,t,e){return new c.Vector3(ce(o.x,t.x,e),ce(o.y,t.y,e),ce(o.z,t.z,e))}function Ri(o,t,e){return Xe(o.position,t.position,e)}function ce(o,t,e){return o+(t-o)*e}function Ye(o,t,e,i,n){return i+(o-t)*(n-i)/(e-t)}function G(o,t,e){return(o<0||t<0||t>o)&&console.log("berstein: Invalid arguments for n or i: ",o,t),(e<0||e>1)&&console.log("berstein: Invalid arguments for t: ",e),Di(o,t)*Math.pow(e,t)*Math.pow(1-e,o-t)}function Ne(o,t,e){return(o<0||t<0||t>o)&&console.log("bersteinDerivative: Invalid arguments for n or i: ",o,t),(e<0||e>1)&&console.log("bersteinDerivative: Invalid arguments for t: ",e),t===0?-o*G(o-1,t,e):t===o?o*G(o-1,t-1,e):o*(G(o-1,t-1,e)-G(o-1,t,e))}function he(o,t,e){const i=[];for(let n=0;n<e;n++){const s=n/(e-1);for(let r=0;r<t;r++){const a=r/(t-1);i.push(Ni(o,a,s))}}return i}function Ni(o,t,e){const i=new v(0,0,0);for(let n=0;n<o.getWidth();n++){const s=G(o.getWidth()-1,n,t);for(let r=0;r<o.getHeight();r++){const a=o.getPoint(r,n),h=G(o.getHeight()-1,r,e);i.add(a.clone().multiplyScalar(s*h))}}return i}class qe{uniforms;constructor(){this.uniforms=new Map}add(t){const e=this.uniforms.get(t.getName());if(e&&e.getType()===t.getType()){e.value=t.value;return}this.uniforms.set(t.getName(),t)}has(t){return this.uniforms.has(t)}get(t){return this.uniforms.get(t)}getAll(){return Array.from(this.uniforms.values())}mergeFrom(t){t.getAll().forEach(e=>{this.add(e)})}getTHREEUniforms(){const t={};return this.uniforms.forEach(e=>{t[e.getName()]={value:e.value}}),t}}class xe{uniforms;enviroment;updateCallback=void 0;constructor(){this.uniforms=new qe,this.enviroment=!1}getUniforms(){return this.uniforms}setUpdateCallback(t){this.updateCallback=t}removeUpdateCallback(){this.updateCallback=void 0}}class te{name;type;value;constructor(t,e,i){this.name=t,this.type=e,this.value=i}getName(){return this.name}getType(){return this.type}}class Vt extends te{constructor(t,e){super(t,1,e)}}class X extends te{constructor(t,e){super(t,2,e)}}class Ee extends te{constructor(t,e){super(t,3,e)}}class Y extends te{blob;image;constructor(t,e){const i=new Ve;i.wrapS=i.wrapT=Le,super(t,7,i),e!==null?(this.image=new Image,this.image.src=URL.createObjectURL(e),this.image.onload=()=>{i.image=this.image,i.needsUpdate=!0}):(this.image=null,this.value.image=l.getDefaultImage(),i.needsUpdate=!0),this.blob=e}update(){this.image!==null&&this.image.src&&URL.revokeObjectURL(this.image.src),this.value.dispose();const t=new Ve;t.wrapS=t.wrapT=Le,this.value=t,this.blob!==null?(this.image===null&&(this.image=new Image),this.image.src=URL.createObjectURL(this.blob),this.image.onload=()=>{this.value.image=this.image,this.value.needsUpdate=!0}):(this.image=null,this.value.image=l.getDefaultImage(),this.value.needsUpdate=!0)}}class zi extends xe{tiling;useMainTexture;mainTexture;mainElement;constructor(){super(),this.tiling=new Ee("tiling",new Ce(1,1)),this.useMainTexture=new X("useMainTexture",!1),this.mainTexture=new Y("mainTexture",null),this.uniforms.add(this.tiling),this.uniforms.add(this.useMainTexture),this.uniforms.add(this.mainTexture);const t=new _("Texture",this.mainTexture,"blob");t.onChange(()=>{this.useMainTexture.value=t.hasTexture(),this.mainTexture.update()}),this.mainElement=t}getName(){return"Diffuse"}getFragmentShader(){return ki()}buildUI(t){const e=new ye("Tiling",this.tiling.value,"x","y",{xStep:.1,yStep:.1});t.add(e.onChange(()=>{this.tiling.value.x<.1&&(this.tiling.value.x=.1),this.tiling.value.y<.1&&(this.tiling.value.y=.1),e.update()})),t.add(this.mainElement)}toJSON(){return{tiling:[this.tiling.value.x,this.tiling.value.y]}}fromJSON(t){this.tiling.value.x=t.tiling[0],this.tiling.value.y=t.tiling[1]}dispose(){this.mainTexture.blob=null,this.mainTexture.update(),this.mainElement.updateBlob()}}function ki(){return`
        uniform vec2 tiling;

        uniform bool useMainTexture;
        uniform sampler2D mainTexture;

        varying vec3 vColor;
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec2 vUV;
        varying vec3 vViewPosition;
        varying mat3 vTBN;

        #include <common>
        #include <lights_pars_begin>
    
        void main(){
            // Get the tilied UV
            vec2 uv = vUV * tiling;

            // Get the base color
            vec3 color = useMainTexture ? texture2D(mainTexture, uv).rgb : vColor;

            // Calculate the normal
            vec3 normal = normalize(vNormal);

            // Calculate the light direction
            vec3 lightDir = directionalLights[0].direction;

            // Calculate the diffuse part
            float diff = max(dot(lightDir, normal), 0.0);

            // Calculate the components
            vec3 lightColor = directionalLights[0].color;
            vec3 ambient = ambientLightColor;
            vec3 diffuse = diff * lightColor;

            vec3 finalColor = (ambient + diffuse) * color;

            // Final output
            gl_FragColor = vec4(finalColor, 1.0);
        }
    `}class ee extends xe{tiling;useMainTexture;mainTexture;useRoughnessMap;roughnessMap;shininess;useNormalMap;normalMap;normalStrength;useAOMap;aoMap;mainElement;roughnessElement;normalElement;aoElement;constructor(){super(),this.tiling=new Ee("tiling",new Ce(1,1)),this.useMainTexture=new X("useMainTexture",!1),this.mainTexture=new Y("mainTexture",null),this.useRoughnessMap=new X("useRoughnessMap",!1),this.roughnessMap=new Y("roughnessMap",null),this.shininess=new Vt("shininess",.5),this.useNormalMap=new X("useNormalMap",!1),this.normalMap=new Y("normalMap",null),this.normalStrength=new Vt("normalStrength",1),this.useAOMap=new X("useAOMap",!1),this.aoMap=new Y("aoMap",null),this.uniforms.add(this.tiling),this.uniforms.add(this.useMainTexture),this.uniforms.add(this.mainTexture),this.uniforms.add(this.roughnessMap),this.uniforms.add(this.useRoughnessMap),this.uniforms.add(this.shininess),this.uniforms.add(this.useNormalMap),this.uniforms.add(this.normalMap),this.uniforms.add(this.normalStrength),this.uniforms.add(this.useAOMap),this.uniforms.add(this.aoMap);const t=new _("Albedo",this.mainTexture,"blob");t.onChange(()=>{this.useMainTexture.value=t.hasTexture(),this.mainTexture.update()}),this.mainElement=t;const e=new _("Roughness",this.roughnessMap,"blob");e.onChange(()=>{this.useRoughnessMap.value=e.hasTexture(),this.roughnessMap.update()}),this.roughnessElement=e;const i=new _("Normal",this.normalMap,"blob");i.onChange(()=>{this.useNormalMap.value=i.hasTexture(),this.normalMap.update()}),this.normalElement=i;const n=new _("Ambient Occlusion",this.aoMap,"blob");n.onChange(()=>{this.useAOMap.value=n.hasTexture(),this.aoMap.update()}),this.aoElement=n}getName(){return"Blinn-Phong"}getFragmentShader(){return Wi()}buildUI(t){t.add(new $e("Load a preset...",{rock:"Rock",mossyrock:"Mossy Rock",bark:"Bark",onyx:"Onyx"},this.presetSelect.bind(this),{previews:["textures/rock/albedo.jpg","textures/mossyrock/albedo.jpg","textures/bark/albedo.jpg","textures/onyx/albedo.jpg"],previewSize:64}));const e=new ye("Tiling",this.tiling.value,"x","y",{xStep:.1,yStep:.1});t.add(e.onChange(()=>{this.tiling.value.x<.1&&(this.tiling.value.x=.1),this.tiling.value.y<.1&&(this.tiling.value.y=.1),e.update()})),t.add(this.mainElement),t.add(this.roughnessElement),t.add(new j("Shininess",this.shininess,"value",{min:.01,max:1,step:.01})),t.add(this.normalElement),t.add(new j("Normal Strength",this.normalStrength,"value",{min:0,max:1,step:.01})),t.add(this.aoElement)}toJSON(){return{tiling:[this.tiling.value.x,this.tiling.value.y],shininess:this.shininess.value,normalStrength:this.normalStrength.value}}fromJSON(t){this.tiling.value.x=t.tiling[0],this.tiling.value.y=t.tiling[1],this.shininess.value=t.shininess,this.normalStrength.value=t.normalStrength}dispose(){this.mainTexture.blob=null,this.mainTexture.update(),this.roughnessMap.blob=null,this.roughnessMap.update(),this.normalMap.blob=null,this.normalMap.update(),this.aoMap.blob=null,this.aoMap.update(),this.mainElement.updateBlob(),this.roughnessElement.updateBlob(),this.normalElement.updateBlob(),this.aoElement.updateBlob()}async presetSelect(t){const e={albedo:"albedo.jpg",ambientocclusion:"ao.jpg",normal:"normal.jpg",roughness:"roughness.jpg"};try{const[i,n,s,r]=await Promise.all([Q(t,e.albedo),Q(t,e.ambientocclusion),Q(t,e.normal),Q(t,e.roughness)]);this.mainTexture.blob=i,this.useMainTexture.value=!0,this.mainTexture.update(),this.roughnessMap.blob=r,this.useRoughnessMap.value=!0,this.roughnessMap.update(),this.normalMap.blob=s,this.useNormalMap.value=!0,this.normalMap.update(),this.aoMap.blob=n,this.useAOMap.value=!0,this.aoMap.update(),this.mainElement.updateBlob(),this.roughnessElement.updateBlob(),this.normalElement.updateBlob(),this.aoElement.updateBlob(),this.updateCallback?.()}catch(i){console.error("Error loading textures",i);return}}}function Wi(){return`
        uniform vec2 tiling;

        uniform bool useMainTexture;
        uniform sampler2D mainTexture;
        
        uniform bool useRoughnessMap;
        uniform sampler2D roughnessMap;
        uniform float shininess;
        
        uniform bool useNormalMap;
        uniform sampler2D normalMap;
        uniform float normalStrength;

        uniform bool useAOMap;
        uniform sampler2D aoMap;

        varying vec3 vColor;
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec2 vUV;
        varying vec3 vViewPosition;
        varying mat3 vTBN;
        varying vec3 vWorldNormal;

        #include <common>
        #include <lights_pars_begin>
    
        void main(){
            // Get the tilied UV
            vec2 uv = vUV * tiling;

            // Get the base color
            vec3 albedo = useMainTexture ? texture2D(mainTexture, uv).rgb : vColor;

            // Get the normal (one minus as a weird fix beacause the vertex shader flips the sides)
            vec3 normal = normalize(vNormal);
            if(useNormalMap){
                vec3 tangentNormal = texture2D(normalMap, uv).xyz * 2.0 - 1.0;
                float nrmStrength = normalStrength;
                vec3 worldNormal = normalize(vTBN * tangentNormal);
                normal = normalize(mix(normal, worldNormal, nrmStrength));
            }

            // Calculate the ambient occlusion
            float ao = useAOMap ? texture2D(aoMap, uv).r : 1.0;

            // Calculate the light direction
            vec3 lightDir = directionalLights[0].direction;

            // Calculate the view direction
            vec3 viewDir = normalize(vViewPosition);

            // Calculate the half vector
            vec3 halfDir = normalize(lightDir + viewDir);

            // Calculate the diffuse part
            float diff = max(dot(lightDir, normal), 0.0);

            // Calculate the specular part
            float spec = pow(max(dot(halfDir, normal), 0.0), 200.0 * shininess);

            // Calculate the roughness
            float roughness = useRoughnessMap ? texture2D(roughnessMap, uv).r : 0.0;
            spec *= (1.0 - roughness);

            // Calculate the Blinn-Phong components
            vec3 lightColor = directionalLights[0].color;
            vec3 ambient = ambientLightColor * ao;
            vec3 diffuse = diff * lightColor;
            vec3 specular = spec * lightColor;

            vec3 blinnPhong = (ambient + diffuse + specular) * albedo;

            // Final output
            gl_FragColor = vec4(blinnPhong, 1.0);
        }
    `}class Fi extends xe{tiling;useMainTexture;mainTexture;useRoughnessMap;roughnessMap;roughness;useNormalMap;normalMap;normalStrength;useMetallicMap;metallicMap;metallic;useAOMap;aoMap;mainElement;roughnessElement;metallicElement;normalElement;aoElement;constructor(){super(),this.enviroment=!0,this.tiling=new Ee("tiling",new Ce(1,1)),this.useMainTexture=new X("useMainTexture",!1),this.mainTexture=new Y("mainTexture",null),this.useRoughnessMap=new X("useRoughnessMap",!1),this.roughnessMap=new Y("roughnessMap",null),this.roughness=new Vt("roughness",.5),this.useMetallicMap=new X("useMetallicMap",!1),this.metallicMap=new Y("metallicMap",null),this.metallic=new Vt("metallic",.5),this.useNormalMap=new X("useNormalMap",!1),this.normalMap=new Y("normalMap",null),this.normalStrength=new Vt("normalStrength",1),this.useAOMap=new X("useAOMap",!1),this.aoMap=new Y("aoMap",null),this.uniforms.add(this.tiling),this.uniforms.add(this.useMainTexture),this.uniforms.add(this.mainTexture),this.uniforms.add(this.roughnessMap),this.uniforms.add(this.useRoughnessMap),this.uniforms.add(this.roughness),this.uniforms.add(this.useMetallicMap),this.uniforms.add(this.metallicMap),this.uniforms.add(this.metallic),this.uniforms.add(this.useNormalMap),this.uniforms.add(this.normalMap),this.uniforms.add(this.normalStrength),this.uniforms.add(this.useAOMap),this.uniforms.add(this.aoMap);const t=new _("Albedo",this.mainTexture,"blob");t.onChange(()=>{this.useMainTexture.value=t.hasTexture(),this.mainTexture.update()}),this.mainElement=t;const e=new _("Roughness",this.roughnessMap,"blob");e.onChange(()=>{this.useRoughnessMap.value=e.hasTexture(),this.roughnessMap.update()}),this.roughnessElement=e;const i=new _("Metallic",this.metallicMap,"blob");i.onChange(()=>{this.useMetallicMap.value=i.hasTexture(),this.metallicMap.update()}),this.metallicElement=i;const n=new _("Normal",this.normalMap,"blob");n.onChange(()=>{this.useNormalMap.value=n.hasTexture(),this.normalMap.update()}),this.normalElement=n;const s=new _("Ambient Occlusion",this.aoMap,"blob");s.onChange(()=>{this.useAOMap.value=s.hasTexture(),this.aoMap.update()}),this.aoElement=s}getName(){return"PBR"}getFragmentShader(){return Ai()}buildUI(t){t.add(new $e("Load a preset...",{metal:"Metal",rustymetal:"Rusty Metal",facade:"Facade",onyx:"Onyx",rock:"Rock",mossyrock:"Mossy Rock",bark:"Bark"},this.presetSelect.bind(this),{previews:["textures/metal/albedo.jpg","textures/rustymetal/albedo.jpg","textures/facade/albedo.jpg","textures/onyx/albedo.jpg","textures/rock/albedo.jpg","textures/mossyrock/albedo.jpg","textures/bark/albedo.jpg"],previewSize:64}));const e=new ye("Tiling",this.tiling.value,"x","y",{xStep:.1,yStep:.1});t.add(e.onChange(()=>{this.tiling.value.x<.1&&(this.tiling.value.x=.1),this.tiling.value.y<.1&&(this.tiling.value.y=.1),e.update()})),t.add(this.mainElement),t.add(this.roughnessElement),t.add(new j("Roughness",this.roughness,"value",{min:.04,max:1,step:.01})),t.add(this.metallicElement),t.add(new j("Metallic Strength",this.metallic,"value",{min:0,max:1,step:.01})),t.add(this.normalElement),t.add(new j("Normal Strength",this.normalStrength,"value",{min:0,max:1,step:.01})),t.add(this.aoElement)}toJSON(){return{tiling:[this.tiling.value.x,this.tiling.value.y],roughness:this.roughness.value,normalStrength:this.normalStrength.value,metallic:this.metallic.value}}fromJSON(t){this.tiling.value.x=t.tiling[0],this.tiling.value.y=t.tiling[1],this.roughness.value=t.roughness,this.normalStrength.value=t.normalStrength,this.metallic.value=t.metallic}dispose(){this.mainTexture.blob=null,this.mainTexture.update(),this.roughnessMap.blob=null,this.roughnessMap.update(),this.metallicMap.blob=null,this.metallicMap.update(),this.normalMap.blob=null,this.normalMap.update(),this.aoMap.blob=null,this.aoMap.update(),this.mainElement.updateBlob(),this.roughnessElement.updateBlob(),this.metallicElement.updateBlob(),this.normalElement.updateBlob(),this.aoElement.updateBlob()}async presetSelect(t){const e={albedo:"albedo.jpg",ambientocclusion:"ao.jpg",metallic:"metallic.jpg",normal:"normal.jpg",roughness:"roughness.jpg"};try{const[i,n,s,r,a]=await Promise.all([Q(t,e.albedo),Q(t,e.ambientocclusion),Q(t,e.metallic),Q(t,e.normal),Q(t,e.roughness)]);this.mainTexture.blob=i,this.useMainTexture.value=!0,this.mainTexture.update(),this.roughnessMap.blob=a,this.useRoughnessMap.value=!0,this.roughnessMap.update(),this.metallicMap.blob=s,this.useMetallicMap.value=!0,this.metallicMap.update(),this.normalMap.blob=r,this.useNormalMap.value=!0,this.normalMap.update(),this.aoMap.blob=n,this.useAOMap.value=!0,this.aoMap.update(),this.mainElement.updateBlob(),this.roughnessElement.updateBlob(),this.metallicElement.updateBlob(),this.normalElement.updateBlob(),this.aoElement.updateBlob(),this.updateCallback?.()}catch(i){console.error("Error loading textures",i);return}}}function Ai(){return`
        uniform vec2 tiling;

        uniform bool useMainTexture;
        uniform sampler2D mainTexture;
        
        uniform bool useRoughnessMap;
        uniform sampler2D roughnessMap;
        uniform float roughness;

        uniform bool useMetallicMap;
        uniform sampler2D metallicMap;
        uniform float metallic;
        
        uniform bool useNormalMap;
        uniform sampler2D normalMap;
        uniform float normalStrength;

        uniform bool useAOMap;
        uniform sampler2D aoMap;

        uniform sampler2D envMap;
        uniform float envMapIntensity;

        varying vec3 vColor;
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec2 vUV;
        varying vec3 vViewPosition;
        varying mat3 vTBN;
        varying vec3 vWorldNormal;

        #include <common>
        #include <lights_pars_begin>

        vec3 getEnvColor(){
            vec3 envReflect = reflect(normalize(vPosition - cameraPosition), vWorldNormal);

            vec2 uv = vec2(atan(envReflect.z, envReflect.x) / (2.0 * PI) + 0.5, 
                   asin(envReflect.y) / PI + 0.5);
    
            vec3 envColor = texture2D(envMap, uv).rgb;

            return envColor;
        }

        vec3 fresnelSchlick(vec3 F0, float VdotH){
            return F0 + (1.0 - F0) * pow(1.0 - VdotH, 5.0);
        }

        float GSchlick(float dot, float k){
            return dot / (dot * (1.0 - k) + k);
        }

        float DGGX(float NdotH, float roughness){
            float alpha = roughness * roughness;
            float a2 = alpha * alpha;
            float inDenom = NdotH * NdotH * (a2 - 1.0) + 1.0;
            return a2 / (PI * inDenom * inDenom);
        }

        float SmithGGX(float NdotV, float NdotL, float roughness){
            float roughness1 = roughness + 1.0;
            float k = roughness1 * roughness1 / 8.0;
            return GSchlick(NdotV, k) * GSchlick(NdotL, k);
        }

        void main() {
            vec2 uv = vUV * tiling;

            vec3 albedo = useMainTexture ? texture2D(mainTexture, uv).rgb : vColor;
            
            vec3 normal = normalize(vNormal);
            if(useNormalMap){
                vec3 tangentNormal = texture2D(normalMap, uv).xyz * 2.0 - 1.0;
                float nrmStrength = normalStrength;
                vec3 worldNormal = normalize(vTBN * tangentNormal);
                normal = normalize(mix(normal, worldNormal, nrmStrength));
            }

            float rough = useRoughnessMap ? texture2D(roughnessMap, uv).r * roughness : roughness;

            float ao = useAOMap ? texture2D(aoMap, uv).r : 1.0;

            float metal = useMetallicMap ? texture2D(metallicMap, uv).r * metallic : metallic;

            vec3 lightColor = directionalLights[0].color;
            vec3 ambientColor = ambientLightColor;
            vec3 envColor = getEnvColor();

            vec3 ambient = ambientColor * albedo * ao;

            vec3 N = normal;
            vec3 L = directionalLights[0].direction;
            vec3 V = normalize(vViewPosition);
            vec3 H = normalize(L + V);

            float NdotL = max(dot(N, L), 0.0);
            float NdotV = max(dot(N, V), 0.0);
            float NdotH = max(dot(N, H), 0.0);
            float VdotH = max(dot(V, H), 0.0);

            vec3 F0 = mix(vec3(0.04), albedo, metal);
            vec3 F = fresnelSchlick(F0, VdotH);
            float D = DGGX(NdotH, rough);
            float G = SmithGGX(NdotV, NdotL, rough);

            float denom = 4.0 * NdotV * NdotL + 0.001;
            vec3 specular = (D * F * G) / denom;

            vec3 kS = F;
            vec3 kD = (1.0 - kS) * (1.0 - metal);
            vec3 diffuse = kD * albedo / PI;

            vec3 Lo = (diffuse + specular) * lightColor * NdotL;

            vec3 reflection = envColor * F * envMapIntensity;

            vec3 finalColor = Lo + ambient + reflection * (1.0 - rough) * metal;

            gl_FragColor = vec4(finalColor, 1.0);
        }
    `}function mt(){return{Diffuse:{name:"Diffuse",create:()=>new zi},"Blinn-Phong":{name:"Blinn-Phong",create:()=>new ee},PBR:{name:"PBR",create:()=>new Fi}}}class Se{vertexShader;controlPoints;color;shadingModel;uniformSet;material;group=void 0;constructor(t,e,i,n,s={}){this.vertexShader=t,this.controlPoints=e,this.color=i.clone(),this.shadingModel=n,this.shadingModel.setUpdateCallback(this.updateUniforms.bind(this)),this.uniformSet=new qe,this.uniformSet.mergeFrom(n.getUniforms()),this.material=new bi({vertexShader:this.vertexShader,fragmentShader:this.shadingModel.getFragmentShader(),uniforms:{...this.getUniforms(),...this.getEnviromentUniforms(),...Te.common,...Te.lights,...s},side:vi,lights:!0}),M.subscribe("enviromentChanged",y.ALL,this.updateEnviroment.bind(this)),M.subscribe("enviromentIntensityChanged",y.ALL,this.updateEnviromentIntensity.bind(this))}update(){this.updateUniforms()}updateControlPoints(){this.material.uniforms.controlPointsTexture.value=this.controlPoints.getTexture(),this.material.uniforms.controlPointsWidth.value=this.controlPoints.getWidth(),this.material.uniforms.controlPointsHeight.value=this.controlPoints.getHeight()}getMaterial(){return this.material}setColor(t){this.color.set(t),this.material.uniforms.color.value.set(t)}setShadingModel(t){this.shadingModel.removeUpdateCallback(),this.shadingModel.dispose(),this.shadingModel=t,this.shadingModel.setUpdateCallback(this.updateUniforms.bind(this)),this.uniformSet.mergeFrom(t.getUniforms()),this.material.fragmentShader=t.getFragmentShader(),this.updateUniforms(),this.updateEnviroment(),this.material.needsUpdate=!0,this.group!==void 0&&(this.group.reset(),this.shadingModel.buildUI(this.group))}getShadingModelName(){return this.shadingModel.getName()}getShadingModelJSON(){return this.shadingModel.toJSON()}buildUI(t){this.group=t,this.group.onChange(this.updateUniforms.bind(this)),this.shadingModel.buildUI(this.group)}setCustomUniform(t,e){this.material.uniforms[t]?this.material.uniforms[t].value=e:this.material.uniforms[t]={value:e}}dispose(){this.shadingModel.removeUpdateCallback(),this.shadingModel.dispose(),this.material.dispose()}updateUniforms(){const t=this.getUniforms();for(const e in t)this.material.uniforms[e]&&this.material.uniforms[e].value!==t[e].value?this.material.uniforms[e].value=t[e].value:this.material.uniforms[e]=t[e]}updateEnviroment(){this.shadingModel.enviroment&&(this.material.uniforms.envMap.value=l.getScene().environment,this.material.uniforms.envMapIntensity.value=l.getScene().environmentIntensity)}updateEnviromentIntensity(){this.shadingModel.enviroment&&(this.material.uniforms.envMapIntensity.value=l.getScene().environmentIntensity)}getUniforms(){const t=this.shadingModel.getUniforms().getTHREEUniforms();return t.controlPointsTexture={value:this.controlPoints.getTexture()},t.controlPointsWidth={value:this.controlPoints.getWidth()},t.controlPointsHeight={value:this.controlPoints.getHeight()},t.color={value:this.color},t}getEnviromentUniforms(){return{envMap:{value:null},envMapIntensity:{value:1}}}}var Ze=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.SHADING=2]="SHADING",o[o.INFO=3]="INFO",o))(Ze||{});class gt extends q{mode;controlPoints;geometry;material;collisionGeometry;collisionMesh;radius=.1;reflectivity=0;constructor(t,e,i,n,s=new c.Color(0),r=new c.Vector3(0,0,0),a=1,h=new ee){const d=new Me(i,n);for(let w=0;w<i;w++)for(let P=0;P<n;P++){const b=w+P*i;d.setPoint(P,w,e[b])}const u=new c.PlaneGeometry(0,0,100,100),m=new Se(Ui(),d,s,h),p=new c.Mesh(u,m.getMaterial());super(t,p,r),this.controlPoints=d,this.geometry=u,this.material=m,this.mode=a,this.color=s,this.type="BezierPatchObject",this.export=this.exportMesh.bind(this);for(let w=0;w<i;w++)for(let P=0;P<n;P++){const b=w+P*i;this.createEditHandle(b,this.radius),this.setEditHandlePosition(b,e[b])}this.hideEditHandles(),this.controlPoints.addVisuals(this.mesh);const g=this.controlPoints.getWidth()+1,f=this.controlPoints.getHeight()+1;this.collisionGeometry=tt(he(this.controlPoints,f,g),f,g),this.collisionMesh=new c.Mesh(this.collisionGeometry,new c.MeshBasicMaterial({transparent:!0,opacity:0,visible:!1,side:c.DoubleSide})),this.collisionMesh.userData.collision=!0,this.collisionMesh.userData.object=this,this.mesh.add(this.collisionMesh)}getMode(){return this.mode}setMode(t){this.mode=t,this.mode===0?(this.hideEditHandles(),this.controlPoints.hideVisuals()):this.mode===1?(this.showEditHandles(),this.controlPoints.showVisuals()):this.mode===2?(this.hideEditHandles(),this.controlPoints.hideVisuals()):this.mode===3&&(this.hideEditHandles(),this.controlPoints.hideVisuals())}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.getPoints().map(t=>({x:t.x,y:t.y,z:t.z})),controlPointsWidth:this.controlPoints.getWidth(),controlPointsHeight:this.controlPoints.getHeight(),color:this.color.getHex(),mode:this.mode,shadingModel:{name:this.material.getShadingModelName(),params:this.material.getShadingModelJSON()},reflectivity:this.reflectivity}}static fromJSON(t){const e=t.controlPoints.map(d=>new c.Vector3(d.x,d.y,d.z)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(Ze[s]===void 0)throw new Error("Invalid BezierPatchObjectMode mode");const a=mt()[t.shadingModel.name??"Blinn-Phong"].create();a.fromJSON(t.shadingModel.params);const h=new gt(t.name,e,t.controlPointsWidth,t.controlPointsHeight,i,n,s,a);return h.setReflectivity(t.reflectivity??0),h}edit(){return this.collisionMesh.userData.collision=!1,this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint(t,e)}}unedit(){this.hideEditHandles(),this.controlPoints.hideVisuals(),this.collisionMesh.userData.collision=!0}updateColor(t){super.setColor(t),this.material.setColor(t)}getMaterial(){return this.material}dispose(){this.material.dispose()}addControlPoint(t,e){if(!this.hasEditHandle(t))return;const i=this.getEditHandlePosition(t);if(i===null)return;const n=Math.floor(t/this.controlPoints.getWidth()),s=t%this.controlPoints.getWidth(),r=i.clone().sub(e),a=new c.Vector3(0,r.y,r.z),h=new c.Vector3(r.x,r.y,0);n===0&&s===0?(this.addControlPointRowCol(n,-1,a),this.addControlPointRowCol(-1,s,h)):n===0&&s===this.controlPoints.getWidth()-1?(this.addControlPointRowCol(n,-1,a),this.addControlPointRowCol(-1,s,h)):n===this.controlPoints.getHeight()-1&&s===0?(this.addControlPointRowCol(-1,s,h),this.addControlPointRowCol(n,-1,a)):n===this.controlPoints.getHeight()-1&&s===this.controlPoints.getWidth()-1?(this.addControlPointRowCol(-1,s,h),this.addControlPointRowCol(n,-1,a)):this.addControlPointRowCol(n,s,r);for(let d=0;d<this.controlPoints.getWidth();d++)for(let u=0;u<this.controlPoints.getHeight();u++){const m=d+u*this.controlPoints.getWidth();this.setEditHandlePosition(m,this.controlPoints.getPoint(u,d))}this.material.updateControlPoints(),this.updateCollisionGeometry()}addControlPointRowCol(t,e,i){var n=0,s=0;t===0?(this.controlPoints.addRow(i,!0),n=this.controlPoints.getWidth(),s=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1)):t===this.controlPoints.getHeight()-1?(this.controlPoints.addRow(i,!1),n=this.controlPoints.getWidth(),s=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1)):e===0?(this.controlPoints.addColumn(i,!0),n=this.controlPoints.getHeight(),s=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight()):e===this.controlPoints.getWidth()-1&&(this.controlPoints.addColumn(i,!1),n=this.controlPoints.getHeight(),s=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight());for(let r=0;r<n;r++)this.createEditHandle(s+r,this.radius)}removeControlPoint(t){if(this.controlPoints.getWidth()<=2||this.controlPoints.getHeight()<=2||!this.hasEditHandle(t))return;const e=Math.floor(t/this.controlPoints.getWidth()),i=t%this.controlPoints.getWidth();e===0||i===0||e===this.controlPoints.getHeight()-1||i===this.controlPoints.getWidth()-1?(this.removeControlPointRowCol(e,-1),this.removeControlPointRowCol(-1,i)):this.removeControlPointRowCol(e,i);for(let n=0;n<this.controlPoints.getWidth();n++)for(let s=0;s<this.controlPoints.getHeight();s++){const r=n+s*this.controlPoints.getWidth();this.setEditHandlePosition(r,this.controlPoints.getPoint(s,n))}this.material.updateControlPoints(),this.updateCollisionGeometry()}removeControlPointRowCol(t,e){var i=0,n=0;t===0?(i=this.controlPoints.getWidth(),n=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1),this.controlPoints.removeRow(!0)):t===this.controlPoints.getHeight()-1?(i=this.controlPoints.getWidth(),n=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1),this.controlPoints.removeRow(!1)):e===0?(i=this.controlPoints.getHeight(),n=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight(),this.controlPoints.removeColumn(!0)):e===this.controlPoints.getWidth()-1&&(i=this.controlPoints.getHeight(),n=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight(),this.controlPoints.removeColumn(!1));for(let s=0;s<i;s++)this.removeEditHandle(n+s)}updateControlPoint(t,e){const i=Math.floor(t/this.controlPoints.getWidth()),n=t%this.controlPoints.getWidth();this.controlPoints.setPoint(i,n,e),this.hasEditHandle(t)&&this.setEditHandlePosition(t,e),this.updateCollisionGeometry()}getControlPoint(t){const e=Math.floor(t/this.controlPoints.getWidth()),i=t%this.controlPoints.getWidth();return this.controlPoints.getPoint(e,i)}highlight(){this.material.setColor(it())}resetHighlight(){this.resetColor()}select(){this.resetColor()}resetSelect(){this.resetColor()}resetColor(){this.material.setColor(this.color)}updateCollisionGeometry(){this.collisionGeometry.dispose();const t=this.controlPoints.getWidth()+1,e=this.controlPoints.getHeight()+1;this.collisionGeometry=tt(he(this.controlPoints,t,e),t,e),this.collisionMesh.geometry=this.collisionGeometry}exportMesh(){const t=he(this.controlPoints,100,100),e=tt(t,100,100),i=new c.MeshStandardMaterial({color:this.color,side:c.DoubleSide}),n=new c.Mesh(e,i);return n.position.copy(this.mesh.position),n.rotation.copy(this.mesh.rotation),n.scale.copy(this.mesh.scale),n}getReflectivity(){return this.reflectivity}setReflectivity(t){this.reflectivity=t}}function Gi(){return[-5,10,5]}function Ji(){return[0,100,0]}function Ki(){return 15528177}function $i(){return 3092528}function be(){return l.darkMode()?$i():Ki()}function it(){return 15105570}function R(){return 15158332}function Jt(){return l.darkMode()?11321297:3426654}function Lt(o){const t=[1752220,3066993,3447003,10181046,3426654,15844367,13849600,15158332];return t[o%t.length]}function Dt(o,t){var e=new v;return e.set(o.x+(o.x-t.x),o.y-(o.y-t.y),o.z+(o.z-t.z)),e}function Qe(o){switch(o){case"LinearCurveObject":return{name:"waypoints",lucide:!0};case"BezierCurveObject":return{name:"bezier2",lucide:!1};case"BezierSplineObject":return{name:"bezier",lucide:!1};case"UniformBSplineObject":return{name:"spline",lucide:!0};case"UniformRationBSplineObject":return{name:"diameter",lucide:!0};case"BezierPatchObject":return{name:"grid-2x2",lucide:!0};case"UniformBSplineSurfaceObject":return{name:"grid-3x3",lucide:!0};case"UniformRationalBSplineSurfaceObject":return{name:"ratio",lucide:!0};default:return{name:"circle-help",lucide:!0}}}const _i=`32
3 3
1.4 0.0 2.4
1.4 -0.784 2.4
0.784 -1.4 2.4
0.0 -1.4 2.4
1.3375 0.0 2.53125
1.3375 -0.749 2.53125
0.749 -1.3375 2.53125
0.0 -1.3375 2.53125
1.4375 0.0 2.53125
1.4375 -0.805 2.53125
0.805 -1.4375 2.53125
0.0 -1.4375 2.53125
1.5 0.0 2.4
1.5 -0.84 2.4
0.84 -1.5 2.4
0.0 -1.5 2.4
3 3
0.0 -1.4 2.4
-0.784 -1.4 2.4
-1.4 -0.784 2.4
-1.4 0.0 2.4
0.0 -1.3375 2.53125
-0.749 -1.3375 2.53125
-1.3375 -0.749 2.53125
-1.3375 0.0 2.53125
0.0 -1.4375 2.53125
-0.805 -1.4375 2.53125
-1.4375 -0.805 2.53125
-1.4375 0.0 2.53125
0.0 -1.5 2.4
-0.84 -1.5 2.4
-1.5 -0.84 2.4
-1.5 0.0 2.4
3 3
-1.4 0.0 2.4
-1.4 0.784 2.4
-0.784 1.4 2.4
0.0 1.4 2.4
-1.3375 0.0 2.53125
-1.3375 0.749 2.53125
-0.749 1.3375 2.53125
0.0 1.3375 2.53125
-1.4375 0.0 2.53125
-1.4375 0.805 2.53125
-0.805 1.4375 2.53125
0.0 1.4375 2.53125
-1.5 0.0 2.4
-1.5 0.84 2.4
-0.84 1.5 2.4
0.0 1.5 2.4
3 3
0.0 1.4 2.4
0.784 1.4 2.4
1.4 0.784 2.4
1.4 0.0 2.4
0.0 1.3375 2.53125
0.749 1.3375 2.53125
1.3375 0.749 2.53125
1.3375 0.0 2.53125
0.0 1.4375 2.53125
0.805 1.4375 2.53125
1.4375 0.805 2.53125
1.4375 0.0 2.53125
0.0 1.5 2.4
0.84 1.5 2.4
1.5 0.84 2.4
1.5 0.0 2.4
3 3
1.5 0.0 2.4
1.5 -0.84 2.4
0.84 -1.5 2.4
0.0 -1.5 2.4
1.75 0.0 1.875
1.75 -0.98 1.875
0.98 -1.75 1.875
0.0 -1.75 1.875
2.0 0.0 1.35
2.0 -1.12 1.35
1.12 -2.0 1.35
0.0 -2.0 1.35
2.0 0.0 0.9
2.0 -1.12 0.9
1.12 -2.0 0.9
0.0 -2.0 0.9
3 3
0.0 -1.5 2.4
-0.84 -1.5 2.4
-1.5 -0.84 2.4
-1.5 0.0 2.4
0.0 -1.75 1.875
-0.98 -1.75 1.875
-1.75 -0.98 1.875
-1.75 0.0 1.875
0.0 -2.0 1.35
-1.12 -2.0 1.35
-2.0 -1.12 1.35
-2.0 0.0 1.35
0.0 -2.0 0.9
-1.12 -2.0 0.9
-2.0 -1.12 0.9
-2.0 0.0 0.9
3 3
-1.5 0.0 2.4
-1.5 0.84 2.4
-0.84 1.5 2.4
0.0 1.5 2.4
-1.75 0.0 1.875
-1.75 0.98 1.875
-0.98 1.75 1.875
0.0 1.75 1.875
-2.0 0.0 1.35
-2.0 1.12 1.35
-1.12 2.0 1.35
0.0 2.0 1.35
-2.0 0.0 0.9
-2.0 1.12 0.9
-1.12 2.0 0.9
0.0 2.0 0.9
3 3
0.0 1.5 2.4
0.84 1.5 2.4
1.5 0.84 2.4
1.5 0.0 2.4
0.0 1.75 1.875
0.98 1.75 1.875
1.75 0.98 1.875
1.75 0.0 1.875
0.0 2.0 1.35
1.12 2.0 1.35
2.0 1.12 1.35
2.0 0.0 1.35
0.0 2.0 0.9
1.12 2.0 0.9
2.0 1.12 0.9
2.0 0.0 0.9
3 3
2.0 0.0 0.9
2.0 -1.12 0.9
1.12 -2.0 0.9
0.0 -2.0 0.9
2.0 0.0 0.45
2.0 -1.12 0.45
1.12 -2.0 0.45
0.0 -2.0 0.45
1.5 0.0 0.225
1.5 -0.84 0.225
0.84 -1.5 0.225
0.0 -1.5 0.225
1.5 0.0 0.15
1.5 -0.84 0.15
0.84 -1.5 0.15
0.0 -1.5 0.15
3 3
0.0 -2.0 0.9
-1.12 -2.0 0.9
-2.0 -1.12 0.9
-2.0 0.0 0.9
0.0 -2.0 0.45
-1.12 -2.0 0.45
-2.0 -1.12 0.45
-2.0 0.0 0.45
0.0 -1.5 0.225
-0.84 -1.5 0.225
-1.5 -0.84 0.225
-1.5 0.0 0.225
0.0 -1.5 0.15
-0.84 -1.5 0.15
-1.5 -0.84 0.15
-1.5 0.0 0.15
3 3
-2.0 0.0 0.9
-2.0 1.12 0.9
-1.12 2.0 0.9
0.0 2.0 0.9
-2.0 0.0 0.45
-2.0 1.12 0.45
-1.12 2.0 0.45
0.0 2.0 0.45
-1.5 0.0 0.225
-1.5 0.84 0.225
-0.84 1.5 0.225
0.0 1.5 0.225
-1.5 0.0 0.15
-1.5 0.84 0.15
-0.84 1.5 0.15
0.0 1.5 0.15
3 3
0.0 2.0 0.9
1.12 2.0 0.9
2.0 1.12 0.9
2.0 0.0 0.9
0.0 2.0 0.45
1.12 2.0 0.45
2.0 1.12 0.45
2.0 0.0 0.45
0.0 1.5 0.225
0.84 1.5 0.225
1.5 0.84 0.225
1.5 0.0 0.225
0.0 1.5 0.15
0.84 1.5 0.15
1.5 0.84 0.15
1.5 0.0 0.15
3 3
-1.6 0.0 2.025
-1.6 -0.3 2.025
-1.5 -0.3 2.25
-1.5 0.0 2.25
-2.3 0.0 2.025
-2.3 -0.3 2.025
-2.5 -0.3 2.25
-2.5 0.0 2.25
-2.7 0.0 2.025
-2.7 -0.3 2.025
-3.0 -0.3 2.25
-3.0 0.0 2.25
-2.7 0.0 1.8
-2.7 -0.3 1.8
-3.0 -0.3 1.8
-3.0 0.0 1.8
3 3
-1.5 0.0 2.25
-1.5 0.3 2.25
-1.6 0.3 2.025
-1.6 0.0 2.025
-2.5 0.0 2.25
-2.5 0.3 2.25
-2.3 0.3 2.025
-2.3 0.0 2.025
-3.0 0.0 2.25
-3.0 0.3 2.25
-2.7 0.3 2.025
-2.7 0.0 2.025
-3.0 0.0 1.8
-3.0 0.3 1.8
-2.7 0.3 1.8
-2.7 0.0 1.8
3 3
-2.7 0.0 1.8
-2.7 -0.3 1.8
-3.0 -0.3 1.8
-3.0 0.0 1.8
-2.7 0.0 1.575
-2.7 -0.3 1.575
-3.0 -0.3 1.35
-3.0 0.0 1.35
-2.5 0.0 1.125
-2.5 -0.3 1.125
-2.65 -0.3 0.9375
-2.65 0.0 0.9375
-2.0 0.0 0.9
-2.0 -0.3 0.9
-1.9 -0.3 0.6
-1.9 0.0 0.6
3 3
-3.0 0.0 1.8
-3.0 0.3 1.8
-2.7 0.3 1.8
-2.7 0.0 1.8
-3.0 0.0 1.35
-3.0 0.3 1.35
-2.7 0.3 1.575
-2.7 0.0 1.575
-2.65 0.0 0.9375
-2.65 0.3 0.9375
-2.5 0.3 1.125
-2.5 0.0 1.125
-1.9 0.0 0.6
-1.9 0.3 0.6
-2.0 0.3 0.9
-2.0 0.0 0.9
3 3
1.7 0.0 1.425
1.7 -0.66 1.425
1.7 -0.66 0.6
1.7 0.0 0.6
2.6 0.0 1.425
2.6 -0.66 1.425
3.1 -0.66 0.825
3.1 0.0 0.825
2.3 0.0 2.1
2.3 -0.25 2.1
2.4 -0.25 2.025
2.4 0.0 2.025
2.7 0.0 2.4
2.7 -0.25 2.4
3.3 -0.25 2.4
3.3 0.0 2.4
3 3
1.7 0.0 0.6
1.7 0.66 0.6
1.7 0.66 1.425
1.7 0.0 1.425
3.1 0.0 0.825
3.1 0.66 0.825
2.6 0.66 1.425
2.6 0.0 1.425
2.4 0.0 2.025
2.4 0.25 2.025
2.3 0.25 2.1
2.3 0.0 2.1
3.3 0.0 2.4
3.3 0.25 2.4
2.7 0.25 2.4
2.7 0.0 2.4
3 3
2.7 0.0 2.4
2.7 -0.25 2.4
3.3 -0.25 2.4
3.3 0.0 2.4
2.8 0.0 2.475
2.8 -0.25 2.475
3.525 -0.25 2.49375
3.525 0.0 2.49375
2.9 0.0 2.475
2.9 -0.15 2.475
3.45 -0.15 2.5125
3.45 0.0 2.5125
2.8 0.0 2.4
2.8 -0.15 2.4
3.2 -0.15 2.4
3.2 0.0 2.4
3 3
3.3 0.0 2.4
3.3 0.25 2.4
2.7 0.25 2.4
2.7 0.0 2.4
3.525 0.0 2.49375
3.525 0.25 2.49375
2.8 0.25 2.475
2.8 0.0 2.475
3.45 0.0 2.5125
3.45 0.15 2.5125
2.9 0.15 2.475
2.9 0.0 2.475
3.2 0.0 2.4
3.2 0.15 2.4
2.8 0.15 2.4
2.8 0.0 2.4
3 3
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
0.8 0.0 3.15
0.8 -0.45 3.15
0.45 -0.8 3.15
0.0 -0.8 3.15
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
0.2 0.0 2.7
0.2 -0.112 2.7
0.112 -0.2 2.7
0.0 -0.2 2.7
3 3
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
0.0 -0.8 3.15
-0.45 -0.8 3.15
-0.8 -0.45 3.15
-0.8 0.0 3.15
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
0.0 -0.2 2.7
-0.112 -0.2 2.7
-0.2 -0.112 2.7
-0.2 0.0 2.7
3 3
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
-0.8 0.0 3.15
-0.8 0.45 3.15
-0.45 0.8 3.15
0.0 0.8 3.15
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
-0.2 0.0 2.7
-0.2 0.112 2.7
-0.112 0.2 2.7
0.0 0.2 2.7
3 3
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.0 3.15
0.0 0.8 3.15
0.45 0.8 3.15
0.8 0.45 3.15
0.8 0.0 3.15
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.0 2.85
0.0 0.2 2.7
0.112 0.2 2.7
0.2 0.112 2.7
0.2 0.0 2.7
3 3
0.2 0.0 2.7
0.2 -0.112 2.7
0.112 -0.2 2.7
0.0 -0.2 2.7
0.4 0.0 2.55
0.4 -0.224 2.55
0.224 -0.4 2.55
0.0 -0.4 2.55
1.3 0.0 2.55
1.3 -0.728 2.55
0.728 -1.3 2.55
0.0 -1.3 2.55
1.3 0.0 2.4
1.3 -0.728 2.4
0.728 -1.3 2.4
0.0 -1.3 2.4
3 3
0.0 -0.2 2.7
-0.112 -0.2 2.7
-0.2 -0.112 2.7
-0.2 0.0 2.7
0.0 -0.4 2.55
-0.224 -0.4 2.55
-0.4 -0.224 2.55
-0.4 0.0 2.55
0.0 -1.3 2.55
-0.728 -1.3 2.55
-1.3 -0.728 2.55
-1.3 0.0 2.55
0.0 -1.3 2.4
-0.728 -1.3 2.4
-1.3 -0.728 2.4
-1.3 0.0 2.4
3 3
-0.2 0.0 2.7
-0.2 0.112 2.7
-0.112 0.2 2.7
0.0 0.2 2.7
-0.4 0.0 2.55
-0.4 0.224 2.55
-0.224 0.4 2.55
0.0 0.4 2.55
-1.3 0.0 2.55
-1.3 0.728 2.55
-0.728 1.3 2.55
0.0 1.3 2.55
-1.3 0.0 2.4
-1.3 0.728 2.4
-0.728 1.3 2.4
0.0 1.3 2.4
3 3
0.0 0.2 2.7
0.112 0.2 2.7
0.2 0.112 2.7
0.2 0.0 2.7
0.0 0.4 2.55
0.224 0.4 2.55
0.4 0.224 2.55
0.4 0.0 2.55
0.0 1.3 2.55
0.728 1.3 2.55
1.3 0.728 2.55
1.3 0.0 2.55
0.0 1.3 2.4
0.728 1.3 2.4
1.3 0.728 2.4
1.3 0.0 2.4
3 3
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
1.425 0.0 0.0
1.425 0.798 0.0
0.798 1.425 0.0
0.0 1.425 0.0
1.5 0.0 0.075
1.5 0.84 0.075
0.84 1.5 0.075
0.0 1.5 0.075
1.5 0.0 0.15
1.5 0.84 0.15
0.84 1.5 0.15
0.0 1.5 0.15
3 3
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
0.0 1.425 0.0
-0.798 1.425 0.0
-1.425 0.798 0.0
-1.425 0.0 0.0
0.0 1.5 0.075
-0.84 1.5 0.075
-1.5 0.84 0.075
-1.5 0.0 0.075
0.0 1.5 0.15
-0.84 1.5 0.15
-1.5 0.84 0.15
-1.5 0.0 0.15
3 3
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
-1.425 0.0 0.0
-1.425 -0.798 0.0
-0.798 -1.425 0.0
0.0 -1.425 0.0
-1.5 0.0 0.075
-1.5 -0.84 0.075
-0.84 -1.5 0.075
0.0 -1.5 0.075
-1.5 0.0 0.15
-1.5 -0.84 0.15
-0.84 -1.5 0.15
0.0 -1.5 0.15
3 3
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
0.0 0.0 0.0
0.0 -1.425 0.0
0.798 -1.425 0.0
1.425 -0.798 0.0
1.425 0.0 0.0
0.0 -1.5 0.075
0.84 -1.5 0.075
1.5 -0.84 0.075
1.5 0.0 0.075
0.0 -1.5 0.15
0.84 -1.5 0.15
1.5 -0.84 0.15
1.5 0.0 0.15`;function de(o,t,e=0){const i=_i.split(`
`),n=parseInt(i[0]);var s=1;for(let r=0;r<n;r++){const a=i[s++].split(" "),h=parseInt(a[0]),d=parseInt(a[1]),u=[];for(let g=0;g<=h;g++)for(let f=0;f<=d;f++){const w=i[s++].split(" "),P=new v(parseFloat(w[0]),parseFloat(w[2]),parseFloat(w[1]));P.multiplyScalar(o),u.push(P)}const m=t?Lt(r):8359053,p=new gt(`Teapot ${r+1}`,u,h+1,d+1,new V(m));p.setReflectivity(e),l.getObjectManager().addObject(p)}}function Xi(o){const t=new c.Scene;t.background=new c.Color(255);const e=new c.PerspectiveCamera(75,o.clientWidth/o.clientHeight,.1,1e3);e.position.set(...Gi());const i=100,n=new c.OrthographicCamera(o.clientWidth/-100,o.clientWidth/i,o.clientHeight/i,o.clientHeight/-100,.1,1e3);n.position.set(...Ji());const s=new c.WebGLRenderer;s.setSize(o.clientWidth,o.clientHeight),s.setPixelRatio(window.devicePixelRatio),s.shadowMap.enabled=!0,o.appendChild(s.domElement);const r=new Be(e,s.domElement);r.enableDamping=!0,r.dampingFactor=.25;const a=new Be(n,s.domElement);a.enableDamping=!0,a.dampingFactor=.25,a.enableRotate=!1,a.mouseButtons={LEFT:c.MOUSE.PAN,MIDDLE:c.MOUSE.DOLLY,RIGHT:c.MOUSE.PAN};const h=new Ue(e,s.domElement);h.setTranslationSnap(.01),h.addEventListener("objectChange",()=>M.notify("transformMoved",y.VIEWPORT));const d=new Ue(n,s.domElement);d.setTranslationSnap(.01),d.addEventListener("objectChange",()=>M.notify("transformMoved",y.VIEWPORT)),d.showY=!1;const u=new c.AmbientLight(15790320,.2);t.add(u);const m=new c.DirectionalLight(16777215,1);m.position.set(15,20,0),m.castShadow=!0,m.shadow.mapSize.width=2048,m.shadow.mapSize.height=2048,m.shadow.camera.far=50,m.shadow.camera.near=.5,m.shadow.camera.left=-10,m.shadow.camera.right=10,m.shadow.camera.top=10,m.shadow.camera.bottom=-10,t.add(m),window.addEventListener("resize",()=>Qi(o,e,n,i,s)),window.addEventListener("beforeunload",()=>l.getIOManager().saveSceneToCache()),l.setupScene(t,e,n,s,r,a,h,d,u,m);const p=document.createElement("div");p.style.position="absolute",p.style.bottom="1rem",p.style.right="23%",p.style.display="flex",p.style.flexDirection="column",p.style.alignItems="center",p.style.gap="0.5rem";const g=document.createElement("img");g.src="/icons/eth.svg",g.style.width="5rem",g.style.opacity="0.6",g.style.cursor="pointer",g.onclick=()=>window.open("https://inf.ethz.ch/","_blank"),p.appendChild(g);const f=document.createElement("img");f.src="/icons/cgl.svg",f.style.width="8rem",f.style.cursor="pointer",f.onclick=()=>window.open("https://www.cgl.ethz.ch/","_blank"),p.appendChild(f);const w=document.createElement("p");w.innerText="Made by Simon Wadsack",w.style.fontSize="0.7rem",w.style.color="var(--sl-color-neutral-400)",w.style.cursor="pointer",w.onclick=()=>window.open("https://github.com/SimonWadsack/","_blank"),p.appendChild(w),o.appendChild(p)}function Yi(){const o=new c.GridHelper(20,40);o.material.opacity=.75,o.material.transparent=!0,o.position.set(0,-.5,0);const t=new c.PlaneGeometry(20,20);t.rotateX(-Math.PI/2);const e=new c.ShadowMaterial({color:0,opacity:.2}),i=new c.Mesh(t,e);i.receiveShadow=!0,i.position.set(0,-.51,0),l.getScene().add(o),l.getScene().add(i),l.setupGrid(o,i)}function qi(o){const t=document.createElement("div");t.style.position="absolute",t.style.backgroundColor="var(--sl-color-neutral-100)",t.style.color="var(--sl-input-color)",t.style.fontFamily="var(--sl-font-sans)",t.style.fontSize="var(--sl-font-size-small)",t.style.padding="0.5em",t.style.borderRadius="var(--sl-border-radius-small)",t.style.border="solid",t.style.borderWidth="1px",t.style.borderColor="var(--sl-color-neutral-300)",t.style.pointerEvents="none",t.style.display="none",t.style.zIndex="1000",t.innerText="TEST",o.appendChild(t),l.setTooltip(t)}function Zi(){const o=l.getIOManager().getFlagCache("darkMode");l.setMode(o)}function Qi(o,t,e,i,n){t.aspect=o.clientWidth/o.clientHeight,t.updateProjectionMatrix(),e.left=o.clientWidth/-100,e.right=o.clientWidth/i,e.top=o.clientHeight/i,e.bottom=o.clientHeight/-100,e.updateProjectionMatrix(),n.setSize(o.clientWidth,o.clientHeight)}class tn{objects;meshLookup;editHandleLookup;constructor(){this.objects=new Map,this.meshLookup=new Map,this.editHandleLookup=new Map}addObject(t){const e=t.getMesh();if(!e){console.error(`addObject: Object with id ${t.getUUID()} has no mesh!`);return}l.getScene().add(e),this.objects.set(t.getUUID(),t),this.meshLookup.set(e,t),M.notify("objectAdded",y.GENERAL,t)}addEditHandle(t){const i=t.getParentObject().getMesh();if(!i){console.error("addEditHandle: Parent has no mesh!");return}const n=t.getMesh();i.add(n),this.editHandleLookup.set(n,t),M.notify("editHandleAdded",y.GENERAL,t)}getObjectByUUID(t){return this.objects.has(t)?this.objects.get(t):(console.error(`getObjectById: Object with uuid ${t} not found!`),null)}selectable(t){return t.userData.collision&&t.userData.object?!0:this.meshLookup.has(t)}isEditHandle(t){if(this.editHandleLookup.has(t)){const e=this.editHandleLookup.get(t);if(e&&e.getActive())return!0}return!1}isVisualObject(t){return t.userData.collision&&t.userData.object?!0:this.meshLookup.has(t)}getVisualObjectByMesh(t){return this.meshLookup.has(t)?this.meshLookup.get(t):t.userData.collision&&t.userData.object?t.userData.object:(console.error(`getVisualObjectByMesh: Object with mesh ${t} not found!`),null)}getEditHandleByMesh(t){return this.editHandleLookup.has(t)?this.editHandleLookup.get(t):(console.error(`getEditHandleByMesh: Edit handle with mesh ${t} not found!`),null)}removeObject(t){const e=this.getObjectByUUID(t);if(!e){console.error(`removeObject: Object with id ${t} not found!`);return}const i=e.getMesh();if(!i){console.error(`removeObject: Object with id ${t} has no mesh!`);return}e.dispose(),l.getScene().remove(i),this.objects.delete(t),this.meshLookup.delete(i),M.notify("objectRemoved",y.ALL,e)}removeObjects(){this.objects.forEach((t,e)=>{this.removeObject(e)}),this.objects.clear(),this.meshLookup.clear(),this.editHandleLookup.clear()}removeEditHandle(t){if(!t){console.error(`removeEditHandle: Edit handle ${t} not found!`);return}const i=t.getParentObject().getMesh();if(!i){console.error("removeEditHandle: Parent has no mesh!");return}const n=t.getMesh();i.remove(n),this.editHandleLookup.delete(n),M.notify("editHandleRemoved",y.ALL,t)}getObjects(){return Array.from(this.objects.values())}isGrid(t){return t===l.getGrid()}isPlane(t){return t===l.getPlane()}}function en(o,t){if(!o||!Array.isArray(o)||o.length<2)return console.error("bezier: Invalid points array!"),null;if(t<0||t>1)return console.error("bezier: Invalid t value!"),null;const e=o.length-1;let i=new v(0,0,0);for(let n=0;n<=e;n++){const s=G(e,n,t);i.addScaledVector(o[n],s)}return i}function nn(o,t,e,i,n){if(n<0||n>1+.05)return console.error("cubicBezier: Invalid t value!",n),null;const s=1-n,r=s*s,a=r*s,h=n*n,d=h*n,u=new v(0,0,0);return u.addScaledVector(o,a),u.addScaledVector(t,3*r*n),u.addScaledVector(e,3*s*h),u.addScaledVector(i,d),u}class ie extends qt{controlPoints;constructor(t=[]){super(),this.controlPoints=t}getPoint(t,e=new v){const i=e;if(this.controlPoints.length<2)return console.log("BezierCurve: Not enough control points!"),i;const n=en(this.controlPoints,t);return n===null?(console.log("BezierCurve:getPoint: Bezier calculation failed!"),i):(i.copy(n),i)}setPoints(t){this.controlPoints=t}copy(t){return t instanceof ie?(super.copy(t),this.controlPoints=t.controlPoints.map(e=>e.clone()),this):(console.log("BezierCurve:copy: Source is not an instance of BezierCurve!"),this)}}var ti=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.DE_CASTELJAU=2]="DE_CASTELJAU",o[o.INFO=3]="INFO",o))(ti||{});class pt extends q{mode;controlPoints;segments;radius;radialSegments;geometry;material;curve;connectionVisual;deCasteljauT;deCasteljauVisuals;deCasteljauCollisionMesh;constructor(t,e=[new c.Vector3(-5,0,0),new c.Vector3(0,5,0),new c.Vector3(5,0,0)],i=new c.Color(0),n=100,s=new c.Vector3(0,0,0),r=1){const a=new ie(e),h=.05,d=8,u=new c.TubeGeometry(a,n,h,d,!1),m=new c.MeshBasicMaterial({color:i});m.side=c.DoubleSide;const p=new c.Mesh(u,m);super(t,p,s),this.curve=a,this.geometry=u,this.material=m,this.controlPoints=e,this.color=i,this.segments=n,this.mode=r,this.radius=h,this.radialSegments=d,this.type="BezierCurveObject";for(let b=0;b<this.controlPoints.length;b++)this.createEditHandle(b),this.setEditHandlePosition(b,this.controlPoints[b]);const g=new c.BufferGeometry().setFromPoints(this.controlPoints),f=new c.LineBasicMaterial({color:R()});this.connectionVisual=new c.Line(g,f),this.connectionVisual.castShadow=!0,p.add(this.connectionVisual),this.connectionVisual.visible=!1,this.hideEditHandles(),this.deCasteljauT=.5,this.deCasteljauVisuals=[];const w=new c.TubeGeometry(this.curve,n,this.radius*10,this.radialSegments,!1),P=new c.MeshBasicMaterial({transparent:!0,opacity:0,visible:!1});this.deCasteljauCollisionMesh=new c.Mesh(w,P),p.add(this.deCasteljauCollisionMesh)}getMode(){return this.mode}setMode(t){this.mode=t,t===0?(this.connectionVisual.visible=!1,this.hideEditHandles(),this.disableDeCasteljau()):t===1?(this.connectionVisual.visible=!0,this.showEditHandles(),this.disableDeCasteljau()):t===2?(this.connectionVisual.visible=!1,this.hideEditHandles(),this.enableDeCasteljau()):t===3&&(this.connectionVisual.visible=!1,this.hideEditHandles(),this.disableDeCasteljau())}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.map(t=>({x:t.x,y:t.y,z:t.z})),color:this.color.getHex(),segments:this.segments,mode:this.mode,deCasteljauT:this.deCasteljauT}}static fromJSON(t){const e=t.controlPoints.map(a=>new c.Vector3(a.x,a.y,a.z)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(ti[s]===void 0)throw new Error("Invalid BezierCurveObject mode");const r=new pt(t.name,e,i,t.segments,n,s);return s===2&&(r.enableDeCasteljau(),r.updateDeCasteljauT(t.deCasteljauT!==void 0?t.deCasteljauT:.5)),r}edit(){return this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint(t,e),this.updateConnectionVisual()}}unedit(){this.connectionVisual.visible=!1,this.hideEditHandles()}enableDeCasteljau(){if(this.deCasteljauVisuals.length>0)return;const t=this.controlPoints.length;var e=[];const i=[],n=[];for(let h=0;h<t;h++){const d=new c.SphereGeometry(.1),u=new c.MeshBasicMaterial({color:Lt(0)}),m=new c.Mesh(d,u);m.position.set(this.controlPoints[h].x,this.controlPoints[h].y,this.controlPoints[h].z),this.mesh.add(m),e.push(this.controlPoints[h]),i.push(m),n.push(this.controlPoints[h])}const s=new c.BufferGeometry().setFromPoints(n),r=new c.LineBasicMaterial({color:Lt(0)}),a=new c.Line(s,r);this.mesh.add(a),this.deCasteljauVisuals[0]={points:i,line:a};for(let h=0;h<t-1;h++){const d=[],u=[],m=h===t-2?.25:.1,p=h===t-2?this.getColor():Lt(h+1);for(let P=0;P<t-h-1;P++){const b=Xe(e[P],e[P+1],this.deCasteljauT),E=new c.SphereGeometry(m),x=new c.MeshBasicMaterial({color:p}),C=new c.Mesh(E,x);C.position.set(b.x,b.y,b.z),d.push(b),u.push(C),this.mesh.add(C)}e=d.slice();const g=new c.BufferGeometry().setFromPoints(d),f=new c.LineBasicMaterial({color:p}),w=new c.Line(g,f);this.deCasteljauVisuals[h+1]={points:u,line:w},this.mesh.add(w)}}disableDeCasteljau(){this.deCasteljauVisuals.forEach(t=>{t.points.forEach(e=>{this.mesh.remove(e)}),this.mesh.remove(t.line)}),this.deCasteljauVisuals=[]}getDeCasteljauT(){return this.deCasteljauT}updateDeCasteljauT(t){this.deCasteljauT=t,this.recomputeDeCasteljau()}getCollisionMesh(){return this.deCasteljauCollisionMesh}updateDeCasteljauFromNearestPoint(t,e=500){const i=this.curve.getPoints(e);let n=Number.MAX_VALUE,s=0;for(let r=0;r<i.length;r++){const a=i[r].distanceToSquared(t);a<n&&(n=a,s=r)}this.updateDeCasteljauT(s/500)}recomputeDeCasteljau(){if(this.mode===2){for(let t=0;t<this.deCasteljauVisuals[0].points.length;t++)this.deCasteljauVisuals[0].points[t].position.set(this.controlPoints[t].x,this.controlPoints[t].y,this.controlPoints[t].z);this.deCasteljauVisuals[0].line.geometry.setFromPoints(this.controlPoints);for(let t=0;t<this.deCasteljauVisuals.length-1;t++){const e=this.deCasteljauVisuals[t].points,i=this.deCasteljauVisuals[t+1].points;for(let n=0;n<e.length-1;n++){const s=Ri(e[n],e[n+1],this.deCasteljauT);i[n].position.set(s.x,s.y,s.z)}this.deCasteljauVisuals[t+1].line.geometry.setFromPoints(i.map(n=>n.position))}}}updateSegments(t){this.segments=t,this.recompute()}updateColor(t){super.setColor(t),this.material.color.set(t)}dispose(){this.material.dispose()}addControlPoint(t,e=!1){if(e?this.controlPoints.unshift(t):this.controlPoints.push(t),this.recompute(),this.updateConnectionVisual(),e){this.createEditHandle(this.controlPoints.length-1);for(let i=0;i<this.controlPoints.length;i++)this.setEditHandlePosition(i,this.controlPoints[i])}else this.createEditHandle(this.controlPoints.length-1),this.setEditHandlePosition(this.controlPoints.length-1,t);this.controlPoints.length>100?this.updateSegments(1e3):this.controlPoints.length>40&&this.updateSegments(500)}removeControlPoint(t=!1){if(!(this.controlPoints.length<=2)){if(t?this.controlPoints.shift():this.controlPoints.pop(),this.recompute(),this.updateConnectionVisual(),t){this.removeEditHandle(this.controlPoints.length);for(let e=0;e<this.controlPoints.length;e++)this.setEditHandlePosition(e,this.controlPoints[e])}else this.removeEditHandle(this.controlPoints.length);this.controlPoints.length<40?this.updateSegments(100):this.controlPoints.length<100&&this.updateSegments(500)}}updateControlPoint(t,e){this.controlPoints[t].set(e.x,e.y,e.z),this.recompute(),this.updateConnectionVisual(),this.mode===2&&this.recomputeDeCasteljau(),this.hasEditHandle(t)&&this.setEditHandlePosition(t,e)}getControlPoint(t){return this.controlPoints[t]}getControlPoints(){return this.controlPoints.slice()}highlight(){this.material.color.set(it())}resetHighlight(){this.resetColor()}select(){this.material.color.set(R())}resetSelect(){this.resetColor()}resetColor(){this.material.color.set(this.color)}updateConnectionVisual(){this.connectionVisual!==null&&(this.connectionVisual.geometry.dispose(),this.connectionVisual.geometry=new c.BufferGeometry().setFromPoints(this.controlPoints))}recompute(){this.curve.setPoints(this.controlPoints),this.geometry&&this.geometry.dispose(),this.geometry=new c.TubeGeometry(this.curve,this.segments,this.radius,this.radialSegments,!1),this.mesh.geometry=this.geometry,this.deCasteljauCollisionMesh.geometry.dispose(),this.deCasteljauCollisionMesh.geometry=new c.TubeGeometry(this.curve,this.segments,this.radius*10,this.radialSegments,!1)}}var ei=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.INFO=2]="INFO",o))(ei||{});class Bt extends q{mode;controlPoints;geometry;material;constructor(t,e=[new c.Vector3(-5,0,0),new c.Vector3(0,5,0),new c.Vector3(5,0,0)],i=new c.Color(0),n=new c.Vector3(0,0,0),s=1){const r=new De().setPositions(e.map(d=>[d.x,d.y,d.z]).flat()),a=new Mi({color:i,linewidth:5});a.side=c.DoubleSide;const h=new xi(r,a);super(t,h,n),this.geometry=r,this.material=a,this.controlPoints=e,this.color=i,this.mode=s,this.type="LinearCurveObject";for(let d=0;d<this.controlPoints.length;d++)this.createEditHandle(d),this.setEditHandlePosition(d,this.controlPoints[d]);this.hideEditHandles()}getMode(){return this.mode}setMode(t){this.mode=t,t===0?this.hideEditHandles():t===1?this.showEditHandles():t===2&&this.hideEditHandles()}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.map(t=>({x:t.x,y:t.y,z:t.z})),color:this.color.getHex(),mode:this.mode}}static fromJSON(t){const e=t.controlPoints.map(r=>new c.Vector3(r.x,r.y,r.z)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(ei[s]===void 0)throw new Error(`Invalid LinearCurveObjectMode: ${s}`);return new Bt(t.name,e,i,n,s)}edit(){return this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint(t,e)}}unedit(){this.hideEditHandles()}updateColor(t){super.setColor(t),this.material.color.set(t)}dispose(){this.material.dispose()}addControlPoint(t,e=!1){if(e?this.controlPoints.unshift(t):this.controlPoints.push(t),this.recompute(),e){this.createEditHandle(this.controlPoints.length-1);for(let i=0;i<this.controlPoints.length;i++)this.setEditHandlePosition(i,this.controlPoints[i])}else this.createEditHandle(this.controlPoints.length-1),this.setEditHandlePosition(this.controlPoints.length-1,t)}removeControlPoint(t=!1){if(!(this.controlPoints.length<=2))if(t?this.controlPoints.shift():this.controlPoints.pop(),this.recompute(),t){this.removeEditHandle(this.controlPoints.length);for(let e=0;e<this.controlPoints.length;e++)this.setEditHandlePosition(e,this.controlPoints[e])}else this.removeEditHandle(this.controlPoints.length)}updateControlPoint(t,e){this.controlPoints[t].set(e.x,e.y,e.z),this.recompute(),this.hasEditHandle(t)&&this.setEditHandlePosition(t,e)}getControlPoint(t){return this.controlPoints[t]}getControlPoints(){return this.controlPoints.slice()}highlight(){this.material.color.set(it())}resetHighlight(){this.resetColor()}select(){this.material.color.set(R())}resetSelect(){this.resetColor()}resetColor(){this.material.color.set(this.color)}recompute(){this.geometry&&this.geometry.dispose(),this.geometry=new De().setPositions(this.controlPoints.map(t=>[t.x,t.y,t.z]).flat()),this.mesh.geometry=this.geometry}}function at(o,t,e,i){if((e<i[0]||e>i[i.length-1])&&console.log("basis: Invalid arguments for t: ",e),o===0)return i[t]<=e&&e<i[t+1]?1:0;let n=i[t+o]-i[t],s=i[t+o+1]-i[t+1],r=n===0?0:(e-i[t])/n*at(o-1,t,e,i),a=s===0?0:(i[t+o+1]-e)/s*at(o-1,t+1,e,i);return r+a}function F(o,t){let e=[];for(let i=0;i<=t+o+1;i++)e.push(i);return e}function on(o,t,e,i,n=!1){if(!o||!Array.isArray(o)||o.length<2)return console.error("bspline: Invalid points array!"),null;if(t<i[0]||t>i[i.length-1])return console.error("bspline: Invalid t value!"),null;let s=o.length-1+(n?e:0);if(i.length!==s+e+2)return console.error("bspline: Invalid knots array!"),null;let r=new v(0,0,0);for(let a=0;a<=s;a++){const h=at(e,a,t,i);r.addScaledVector(o[a%o.length],h)}return r}class ne extends qt{controlPoints;degree;knots;closed=!1;constructor(t=[],e=2,i=!1){super(),this.controlPoints=t,this.degree=e,this.closed=i;const n=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+n)}getPoint(t,e=new v){const i=e;if(this.controlPoints.length<2)return console.log("UniformBSplineCurve: Not enough control points!"),i;if(this.degree<2||this.degree>this.controlPoints.length-1)return console.log("UniformBSplineCurve: Degree is out of range!"),i;t=sn(t,this.degree,this.knots);const n=on(this.controlPoints,t,this.degree,this.knots,this.closed);return n===null?(console.log("UniformBSplineCurve:getPoint: BSpline calculation failed!"),i):(i.copy(n),i)}setPoints(t){this.controlPoints=t;const e=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+e)}setDegree(t){if(this.degree===t)return;this.degree=t;const e=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+e)}setClosed(t){if(this.closed===t)return;this.closed=t;const e=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+e)}copy(t){return t instanceof ne?(super.copy(t),this.controlPoints=t.controlPoints.map(e=>e.clone()),this.degree=t.degree,this.knots=t.knots.slice(),this.closed=t.closed,this):(console.log("UniformBSplineCurve:copy: Source is not an instance of UniformBSplineCurve!"),this)}}function sn(o,t,e){return e[t]+o*(e[e.length-t-1]-e[t])}var ii=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.INFO=2]="INFO",o))(ii||{});class xt extends q{mode;controlPoints;degree;segments;radius;radialSegments;geometry;material;curve;connectionVisual;closed=!1;constructor(t,e=[new c.Vector3(-5,0,0),new c.Vector3(0,5,0),new c.Vector3(5,0,0)],i=2,n=new c.Color(0),s=100,r=new c.Vector3(0,0,0),a=1,h=!1){const d=new ne(e,i,h),u=.05,m=8,p=new c.TubeGeometry(d,s,u,m,!1),g=new c.MeshBasicMaterial({color:n});g.side=c.DoubleSide;const f=new c.Mesh(p,g);super(t,f,r),this.curve=d,this.geometry=p,this.material=g,this.controlPoints=e,this.degree=i,this.color=n,this.segments=s,this.mode=a,this.closed=h,this.radius=u,this.radialSegments=m,this.type="UniformBSplineObject";for(let b=0;b<this.controlPoints.length;b++)this.createEditHandle(b),this.setEditHandlePosition(b,this.controlPoints[b]);const w=new c.BufferGeometry().setFromPoints(this.controlPoints),P=new c.LineBasicMaterial({color:R()});this.connectionVisual=new c.Line(w,P),this.connectionVisual.castShadow=!0,f.add(this.connectionVisual),this.connectionVisual.visible=!1,this.hideEditHandles()}getMode(){return this.mode}setMode(t){this.mode=t,t===0?(this.connectionVisual.visible=!1,this.hideEditHandles()):t===1?(this.connectionVisual.visible=!0,this.showEditHandles()):t===2&&(this.connectionVisual.visible=!1,this.hideEditHandles())}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.map(t=>({x:t.x,y:t.y,z:t.z})),degree:this.degree,color:this.color.getHex(),segments:this.segments,mode:this.mode,closed:this.closed}}static fromJSON(t){const e=t.controlPoints.map(r=>new c.Vector3(r.x,r.y,r.z)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(ii[s]===void 0)throw new Error("Invalid UniformBSplineObject mode");return new xt(t.name,e,t.degree??2,i,t.segments??100,n,s,t.closed??!1)}edit(){return this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint(t,e),this.updateConnectionVisual()}}unedit(){this.connectionVisual.visible=!1,this.hideEditHandles()}addControlPoint(t,e=!1){if(e?this.controlPoints.unshift(t):this.controlPoints.push(t),this.recompute(),this.updateConnectionVisual(),e){this.createEditHandle(this.controlPoints.length-1);for(let i=0;i<this.controlPoints.length;i++)this.setEditHandlePosition(i,this.controlPoints[i])}else this.createEditHandle(this.controlPoints.length-1),this.setEditHandlePosition(this.controlPoints.length-1,t);this.controlPoints.length>100?this.updateSegments(1e3):this.controlPoints.length>30&&this.updateSegments(500)}removeControlPoint(t=!1){if(!(this.controlPoints.length<=3)){if(t?this.controlPoints.shift():this.controlPoints.pop(),this.controlPoints.length-1<this.degree&&(this.degree=this.controlPoints.length-1,this.curve.setDegree(this.degree)),this.recompute(),this.updateConnectionVisual(),t){this.removeEditHandle(this.controlPoints.length);for(let e=0;e<this.controlPoints.length;e++)this.setEditHandlePosition(e,this.controlPoints[e])}else this.removeEditHandle(this.controlPoints.length);this.controlPoints.length<30?this.updateSegments(100):this.controlPoints.length<100&&this.updateSegments(500)}}updateControlPoint(t,e){this.controlPoints[t].set(e.x,e.y,e.z),this.recompute(),this.updateConnectionVisual(),this.hasEditHandle(t)&&this.setEditHandlePosition(t,e)}getControlPoint(t){return this.controlPoints[t]}getControlPoints(){return this.controlPoints.slice()}getDegree(){return this.degree}setDegree(t){this.degree=t,this.curve.setDegree(t),this.recompute()}isClosed(){return this.closed}setClosed(t){this.closed=t,this.curve.setClosed(t),this.recompute()}updateSegments(t){this.segments=t,this.recompute()}updateColor(t){super.setColor(t),this.material.color.set(t)}dispose(){this.material.dispose()}highlight(){this.material.color.set(it())}resetHighlight(){this.resetColor()}select(){this.material.color.set(R())}resetSelect(){this.resetColor()}resetColor(){this.material.color.set(this.color)}updateConnectionVisual(){this.connectionVisual!==null&&(this.connectionVisual.geometry.dispose(),this.connectionVisual.geometry=new c.BufferGeometry().setFromPoints(this.controlPoints))}recompute(){this.curve.setPoints(this.controlPoints),this.geometry&&this.geometry.dispose(),this.geometry=new c.TubeGeometry(this.curve,this.segments,this.radius,this.radialSegments,!1),this.mesh.geometry=this.geometry}}function rn(o,t,e,i,n=!1){if(!o||!Array.isArray(o)||o.length<2)return console.error("bspline: Invalid points array!"),null;if(t<i[0]||t>i[i.length-1])return console.error("bspline: Invalid t value!"),null;let s=o.length-1+(n?e:0);if(i.length!==s+e+2)return console.error("bspline: Invalid knots array!"),null;let r=new v(0,0,0),a=0;for(let h=0;h<=s;h++){const d=at(e,h,t,i),u=h%o.length,m=new v(o[u].x,o[u].y,o[u].z),p=o[u].w*d;r.addScaledVector(m,p),a+=p}return a===0?null:r.divideScalar(a)}class oe extends qt{controlPoints;degree;knots;closed;constructor(t=[],e=2,i=!1){super(),this.controlPoints=t,this.degree=e,this.closed=i;const n=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+n)}getPoint(t,e=new v){const i=e;if(this.controlPoints.length<3)return console.log("UniformRationalBSplineCurve: Not enough control points!"),i;if(this.degree<2||this.degree>this.controlPoints.length-1)return console.log("UniformRationalBSplineCurve: Degree is out of range!"),i;t=this.knots[this.degree]+t*(this.knots[this.knots.length-this.degree-1]-this.knots[this.degree]);const n=rn(this.controlPoints,t,this.degree,this.knots,this.closed);return n===null?(console.log("UniformRationalBSplineCurve:getPoint: BSpline calculation failed!"),i):(i.copy(n),i)}setPoints(t){this.controlPoints=t;const e=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+e)}setDegree(t){if(this.degree===t)return;this.degree=t;const e=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+e)}setClosed(t){if(this.closed===t)return;this.closed=t;const e=this.closed?this.degree:0;this.knots=F(this.degree,this.controlPoints.length-1+e)}copy(t){return t instanceof oe?(super.copy(t),this.controlPoints=t.controlPoints.map(e=>e.clone()),this.degree=t.degree,this.knots=t.knots.slice(),this.closed=t.closed,this):(console.log("UniformRationalBSplineCurve:copy: Source is not an instance of UniformBSplineCurve!"),this)}}var ni=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.INFO=2]="INFO",o))(ni||{});class Et extends q{mode;controlPoints;degree;segments;radius;radialSegments;geometry;material;curve;connectionVisual;weightEditIndex=-1;weightEditRing;closed=!1;constructor(t,e=[new c.Vector4(-5,0,0,1),new c.Vector4(0,5,0,1),new c.Vector4(5,0,0,1)],i=2,n=new c.Color(0),s=100,r=new c.Vector3(0,0,0),a=1,h=!1){const d=new oe(e,i,h),u=.05,m=8,p=new c.TubeGeometry(d,s,u,m,!1),g=new c.MeshBasicMaterial({color:n});g.side=c.DoubleSide;const f=new c.Mesh(p,g);super(t,f,r),this.curve=d,this.geometry=p,this.material=g,this.controlPoints=e,this.degree=i,this.color=n,this.segments=s,this.mode=a,this.closed=h,this.radius=u,this.radialSegments=m,this.type="UniformRationBSplineObject";for(let x=0;x<this.controlPoints.length;x++){this.createEditHandle(x);const C=new c.Vector3(this.controlPoints[x].x,this.controlPoints[x].y,this.controlPoints[x].z);this.setEditHandlePosition(x,C)}const w=new c.BufferGeometry().setFromPoints(this.controlPoints.map(x=>new c.Vector3(x.x,x.y,x.z))),P=new c.LineBasicMaterial({color:R()});this.connectionVisual=new c.Line(w,P),this.connectionVisual.castShadow=!0,f.add(this.connectionVisual),this.connectionVisual.visible=!1,this.hideEditHandles();const b=new c.RingGeometry(.05,.06,32),E=new c.MeshBasicMaterial({color:R()});this.weightEditRing=new c.Mesh(b,E),f.add(this.weightEditRing),this.weightEditRing.visible=!1,l.onOrbitControlsChange(()=>{this.weightEditIndex!==-1&&this.weightEditRing.lookAt(l.getCamera().position)}),window.addEventListener("wheel",x=>{if(this.weightEditIndex!==-1){const C=this.controlPoints[this.weightEditIndex];C.w+=x.deltaY*.01,C.w<1&&(C.w=1),C.w>10&&(C.w=10),this.updateControlPoint(this.weightEditIndex,C),M.notify("objectChanged",y.VIEWPORT,this)}})}getMode(){return this.mode}setMode(t){this.mode=t,t===0?(this.connectionVisual.visible=!1,this.hideWeightEditRing(),this.hideEditHandles()):t===1?(this.connectionVisual.visible=!0,this.showEditHandles()):t===2&&(this.connectionVisual.visible=!1,this.hideWeightEditRing(),this.hideEditHandles())}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.map(t=>({x:t.x,y:t.y,z:t.z,w:t.w})),degree:this.degree,color:this.color.getHex(),segments:this.segments,mode:this.mode,closed:this.closed}}static fromJSON(t){const e=t.controlPoints.map(r=>new c.Vector4(r.x,r.y,r.z,r.w)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(ni[s]===void 0)throw new Error("Invalid UniformBSplineObject mode");return new Et(t.name,e,t.degree??2,i,t.segments??100,n,s,t.closed??!1)}edit(){return this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint3(t,e),this.updateConnectionVisual()}}unedit(){this.connectionVisual.visible=!1,this.hideWeightEditRing(),this.hideEditHandles()}showWeightEditRing(t){this.weightEditIndex=t,this.updateWeightEditRing(),this.weightEditRing.visible=!0,l.noScroll()}hideWeightEditRing(){this.weightEditIndex=-1,this.weightEditRing.visible=!1,l.scroll()}updateWeightEditRing(){if(this.weightEditIndex===-1)return;const t=this.controlPoints[this.weightEditIndex];this.weightEditRing.position.set(t.x,t.y,t.z);const e=Ye(t.w,1,10,8,20);this.weightEditRing.scale.set(e,e,e),this.weightEditRing.lookAt(l.getCamera().position)}addControlPoint(t,e=!1){if(e?this.controlPoints.unshift(t):this.controlPoints.push(t),this.recompute(),this.updateConnectionVisual(),e){this.createEditHandle(this.controlPoints.length-1);for(let i=0;i<this.controlPoints.length;i++){const n=new c.Vector3(this.controlPoints[i].x,this.controlPoints[i].y,this.controlPoints[i].z);this.setEditHandlePosition(i,n)}}else{this.createEditHandle(this.controlPoints.length-1);const i=this.controlPoints.length-1,n=new c.Vector3(this.controlPoints[i].x,this.controlPoints[i].y,this.controlPoints[i].z);this.setEditHandlePosition(this.controlPoints.length-1,n)}this.controlPoints.length>60?this.updateSegments(1e3):this.controlPoints.length>30&&this.updateSegments(500)}removeControlPoint(t=!1){if(!(this.controlPoints.length<=3)){if(t?this.controlPoints.shift():this.controlPoints.pop(),this.controlPoints.length-1<this.degree&&(this.degree=this.controlPoints.length-1,this.curve.setDegree(this.degree)),this.recompute(),this.updateConnectionVisual(),t){this.removeEditHandle(this.controlPoints.length);for(let e=0;e<this.controlPoints.length;e++){const i=new c.Vector3(this.controlPoints[e].x,this.controlPoints[e].y,this.controlPoints[e].z);this.setEditHandlePosition(e,i)}}else this.removeEditHandle(this.controlPoints.length);this.controlPoints.length<30?this.updateSegments(100):this.controlPoints.length<60&&this.updateSegments(500)}}updateControlPoint3(t,e){this.updateControlPoint(t,new c.Vector4(e.x,e.y,e.z,this.getControlPoint(t).w))}updateControlPoint(t,e){if(this.controlPoints[t].set(e.x,e.y,e.z,e.w),this.recompute(),this.updateConnectionVisual(),this.hasEditHandle(t)){const i=new c.Vector3(this.controlPoints[t].x,this.controlPoints[t].y,this.controlPoints[t].z);this.setEditHandlePosition(t,i)}this.weightEditIndex===t&&this.updateWeightEditRing()}getControlPoint(t){return this.controlPoints[t]}getControlPoints(){return this.controlPoints.slice()}getDegree(){return this.degree}setDegree(t){this.degree=t,this.curve.setDegree(t),this.recompute()}isClosed(){return this.closed}setClosed(t){this.closed=t,this.curve.setClosed(t),this.recompute()}updateSegments(t){this.segments=t,this.recompute()}updateColor(t){super.setColor(t),this.material.color.set(t)}dispose(){this.material.dispose()}highlight(){this.material.color.set(it())}resetHighlight(){this.resetColor()}select(){this.material.color.set(R())}resetSelect(){this.resetColor()}resetColor(){this.material.color.set(this.color)}updateConnectionVisual(){this.connectionVisual!==null&&(this.connectionVisual.geometry.dispose(),this.connectionVisual.geometry=new c.BufferGeometry().setFromPoints(this.controlPoints.map(t=>new c.Vector3(t.x,t.y,t.z))))}recompute(){this.curve.setPoints(this.controlPoints),this.geometry&&this.geometry.dispose(),this.geometry=new c.TubeGeometry(this.curve,this.segments,this.radius,this.radialSegments,!1),this.mesh.geometry=this.geometry}}class se extends qt{controlPoints;constructor(t=[]){super(),this.controlPoints=t}getPoint(t,e=new v){const i=e;if((this.controlPoints.length-1)%3!==0)return console.log("BezierSplineCurve: Not 3p+1 control points!"),i;const n=(this.controlPoints.length-1)/3,s=Math.min(Math.floor(t*n),n-1),r=(t-s/n)*n,a=s*3,h=nn(this.controlPoints[a],this.controlPoints[a+1],this.controlPoints[a+2],this.controlPoints[a+3],r);return h===null?(console.log("BezierSplineCurve:getPoint: Bezier calculation failed!"),i):(i.copy(h),i)}setPoints(t){this.controlPoints=t}copy(t){return t instanceof se?(super.copy(t),this.controlPoints=t.controlPoints.map(e=>e.clone()),this):(console.log("BezierSplineCurve:copy: Source is not an instance of BezierCurve!"),this)}}var oi=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.INFO=2]="INFO",o))(oi||{});class St extends q{mode;controlPoints;segments;radius;radialSegments;geometry;material;curve;connectionVisuals;constructor(t,e=[new c.Vector3(-5,0,0),new c.Vector3(0,5,0),new c.Vector3(5,0,0)],i=new c.Color(0),n=100,s=new c.Vector3(0,0,0),r=1){const a=new se(e),h=.05,d=8,u=new c.TubeGeometry(a,n,h,d,!1),m=new c.MeshBasicMaterial({color:i});m.side=c.DoubleSide;const p=new c.Mesh(u,m);super(t,p,s),this.curve=a,this.geometry=u,this.material=m,this.controlPoints=e,this.color=i,this.segments=n,this.mode=r,this.radius=h,this.radialSegments=d,this.type="BezierSplineObject";for(let w=0;w<this.controlPoints.length;w++)w%3===0?this.createEditHandle(w,.3):this.createEditHandle(w,.15),this.setEditHandlePosition(w,this.controlPoints[w]);this.connectionVisuals=[];const g=new c.LineBasicMaterial({color:R()});this.connectionVisuals.push(new c.Line(new c.BufferGeometry().setFromPoints([this.controlPoints[0],this.controlPoints[1]]),g));const f=Math.floor((this.controlPoints.length-1)/3)+1;for(let w=1;w<f-1;w++){const P=2+(w-1)*3,b=[this.controlPoints[P],this.controlPoints[P+1],this.controlPoints[P+2]];this.connectionVisuals.push(new c.Line(new c.BufferGeometry().setFromPoints(b),g))}this.connectionVisuals.push(new c.Line(new c.BufferGeometry().setFromPoints([this.controlPoints[this.controlPoints.length-2],this.controlPoints[this.controlPoints.length-1]]),g)),this.connectionVisuals.forEach(w=>this.mesh.add(w)),this.hideConnectionVisuals(),this.hideEditHandles()}getMode(){return this.mode}setMode(t){this.mode=t,t===0?(this.hideConnectionVisuals(),this.hideEditHandles()):t===1?(this.showConnectionVisuals(),this.showEditHandles()):t===2&&(this.hideConnectionVisuals(),this.hideEditHandles())}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.map(t=>({x:t.x,y:t.y,z:t.z})),color:this.color.getHex(),segments:this.segments,mode:this.mode}}static fromJSON(t){const e=t.controlPoints.map(r=>new c.Vector3(r.x,r.y,r.z)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(oi[s]===void 0)throw new Error("Invalid BezierCurveObject mode");return new St(t.name,e,i,t.segments,n,s)}edit(){return this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint(t,e)}}unedit(){this.hideConnectionVisuals(),this.hideEditHandles()}updateSegments(t){this.segments=t,this.recompute()}updateColor(t){super.setColor(t),this.material.color.set(t)}dispose(){this.material.dispose()}addControlPoint(t,e=!1){if(e){const i=this.controlPoints.length-1;this.controlPoints.unshift(new c.Vector3(0,0,0)),this.createEditHandle(i+1,.15);const n=t.clone().add(this.controlPoints[1].clone().sub(t).setLength(3));this.controlPoints.unshift(n),this.createEditHandle(i+2,.15),this.controlPoints.unshift(t.clone()),this.createEditHandle(i+3,.3);for(let r=0;r<this.controlPoints.length;r++)this.setEditHandlePosition(r,this.controlPoints[r]);this.updateControlPoint(4,this.controlPoints[4]),this.updateControlPoint(0,this.controlPoints[0]);const s=new c.Line(new c.BufferGeometry().setFromPoints([this.controlPoints[0],this.controlPoints[1]]),new c.LineBasicMaterial({color:R()}));this.connectionVisuals.unshift(s),this.mesh.add(s)}else{const i=this.controlPoints.length-1;this.controlPoints.push(new c.Vector3(0,0,0)),this.createEditHandle(i+1,.15);const n=t.clone().add(this.controlPoints[i].clone().sub(t).setLength(3));this.controlPoints.push(n),this.createEditHandle(i+2,.15),this.controlPoints.push(t.clone()),this.createEditHandle(i+3,.3),this.updateControlPoint(i-1,this.controlPoints[i-1]),this.updateControlPoint(i+3,this.controlPoints[i+3]);const s=new c.Line(new c.BufferGeometry().setFromPoints([this.controlPoints[this.controlPoints.length-2],this.controlPoints[this.controlPoints.length-1]]),new c.LineBasicMaterial({color:R()}));this.connectionVisuals.push(s),this.mesh.add(s)}this.recompute(),this.updateConnectionVisuals(),this.controlPoints.length>100?this.updateSegments(1e3):this.controlPoints.length>40&&this.updateSegments(500)}removeControlPoint(t=!1){if(!(this.controlPoints.length<=6)){if(t){this.controlPoints.shift(),this.removeEditHandle(this.controlPoints.length),this.controlPoints.shift(),this.removeEditHandle(this.controlPoints.length),this.controlPoints.shift(),this.removeEditHandle(this.controlPoints.length);for(let i=0;i<this.controlPoints.length;i++)this.setEditHandlePosition(i,this.controlPoints[i]);const e=this.connectionVisuals.shift();e&&this.mesh.remove(e)}else{this.controlPoints.pop(),this.removeEditHandle(this.controlPoints.length),this.controlPoints.pop(),this.removeEditHandle(this.controlPoints.length),this.controlPoints.pop(),this.removeEditHandle(this.controlPoints.length);const e=this.connectionVisuals.pop();e&&this.mesh.remove(e)}this.recompute(),this.updateConnectionVisuals(),this.controlPoints.length<40?this.updateSegments(100):this.controlPoints.length<100&&this.updateSegments(500)}}updateControlPoint(t,e){if(t===0){const i=e.clone().sub(this.controlPoints[0]);this.controlPoints[0].set(e.x,e.y,e.z),this.setEditHandle(0),this.controlPoints[1].add(i),this.setEditHandle(1)}else if(t===1)this.controlPoints[1].set(e.x,e.y,e.z),this.setEditHandle(1);else if(t===this.controlPoints.length-1){const i=e.clone().sub(this.controlPoints[this.controlPoints.length-1]);this.controlPoints[this.controlPoints.length-1].set(e.x,e.y,e.z),this.setEditHandle(this.controlPoints.length-1),this.controlPoints[this.controlPoints.length-2].add(i),this.setEditHandle(this.controlPoints.length-2)}else if(t===this.controlPoints.length-2)this.controlPoints[this.controlPoints.length-2].set(e.x,e.y,e.z),this.setEditHandle(this.controlPoints.length-2);else if(t%3===0){const i=e.clone().sub(this.controlPoints[t]);this.controlPoints[t].set(e.x,e.y,e.z),this.setEditHandle(t),this.controlPoints[t-1].add(i),this.setEditHandle(t-1),this.controlPoints[t+1].add(i),this.setEditHandle(t+1)}else if(t%3===1){this.controlPoints[t].set(e.x,e.y,e.z),this.setEditHandle(t);const n=this.controlPoints[t-1].clone().multiplyScalar(2).sub(e);this.controlPoints[t-2].set(n.x,n.y,n.z),this.setEditHandle(t-2)}else if(t%3===2){this.controlPoints[t].set(e.x,e.y,e.z),this.setEditHandle(t);const n=this.controlPoints[t+1].clone().multiplyScalar(2).sub(e);this.controlPoints[t+2].set(n.x,n.y,n.z),this.setEditHandle(t+2)}this.recompute(),this.updateConnectionVisuals()}setEditHandle(t){this.hasEditHandle(t)&&this.setEditHandlePosition(t,this.controlPoints[t])}getControlPoint(t){return this.controlPoints[t]}getControlPoints(){return this.controlPoints.slice()}highlight(){this.material.color.set(it())}resetHighlight(){this.resetColor()}select(){this.material.color.set(R())}resetSelect(){this.resetColor()}resetColor(){this.material.color.set(this.color)}hideConnectionVisuals(){this.connectionVisuals!==null&&this.connectionVisuals.forEach(t=>t.visible=!1)}showConnectionVisuals(){this.connectionVisuals!==null&&this.connectionVisuals.forEach(t=>t.visible=!0)}updateConnectionVisuals(){if(this.connectionVisuals===null)return;this.connectionVisuals[0].geometry.dispose(),this.connectionVisuals[0].geometry=new c.BufferGeometry().setFromPoints([this.controlPoints[0],this.controlPoints[1]]);const t=Math.floor((this.controlPoints.length-1)/3)+1;for(let e=1;e<t-1;e++){const i=2+(e-1)*3,n=[this.controlPoints[i],this.controlPoints[i+1],this.controlPoints[i+2]];this.connectionVisuals[e].geometry.dispose(),this.connectionVisuals[e].geometry=new c.BufferGeometry().setFromPoints(n)}this.connectionVisuals[this.connectionVisuals.length-1].geometry.dispose(),this.connectionVisuals[this.connectionVisuals.length-1].geometry=new c.BufferGeometry().setFromPoints([this.controlPoints[this.controlPoints.length-2],this.controlPoints[this.controlPoints.length-1]])}recompute(){this.curve.setPoints(this.controlPoints),this.geometry&&this.geometry.dispose(),this.geometry=new c.TubeGeometry(this.curve,this.segments,this.radius,this.radialSegments,!1),this.mesh.geometry=this.geometry}}function an(){return`
    uniform sampler2D controlPointsTexture;
    uniform int controlPointsWidth;
    uniform int controlPointsHeight;
    uniform vec3 color;
    uniform int degree;
    uniform bool closedU;
    uniform bool closedV;

    varying vec3 vColor;
    varying vec3 vNormal;
    varying vec3 vPosition;
    varying vec2 vUV;
    varying vec3 vViewPosition;
    varying mat3 vTBN;
    varying vec3 vWorldNormal;

    float delta = 0.0001;

    float getUniformKnotValue(int index){
        return float(index);
    }

    float basis(int p, int i, float t) {
        float B[10]; //max degree 10
        
        for (int j = 0; j <= p; j++) {
            if (t >= getUniformKnotValue(i + j) && t < getUniformKnotValue(i + j + 1))
                B[j] = 1.0;
            else
                B[j] = 0.0;
        }
    
        for (int k = 1; k <= p; k++) {
            for (int j = 0; j <= p - k; j++) {
                float left = 0.0;
                float right = 0.0;
    
                float denomLeft = getUniformKnotValue(i + j + k) - getUniformKnotValue(i + j);
                if (denomLeft > delta)
                    left = ((t - getUniformKnotValue(i + j)) / denomLeft) * B[j];
    
                float denomRight = getUniformKnotValue(i + j + k + 1) - getUniformKnotValue(i + j + 1);
                if (denomRight > delta)
                    right = ((getUniformKnotValue(i + j + k + 1) - t) / denomRight) * B[j + 1];
    
                B[j] = left + right;
            }
        }
    
        return B[0];
    }

    float basisDerivative(int p, int i, float t) {
        if(p == 0) return 0.0;

        float left = 0.0;
        float right = 0.0;

        float denomLeft = getUniformKnotValue(i + p) - getUniformKnotValue(i);
        if(denomLeft > delta)
            left = (float(p) / denomLeft) * basis(p - 1, i, t);

        float denomRight = getUniformKnotValue(i + p + 1) - getUniformKnotValue(i + 1);
        if(denomRight > delta)
            right = (float(p) / denomRight) * basis(p - 1, i + 1, t);

        return left - right;
    }

    vec3 getControlPoint(int i, int j){
        int modI = i % controlPointsWidth;
        int modJ = j % controlPointsHeight;
        vec2 texCoord = vec2(float(modI) / float(controlPointsWidth - 1), float(modJ) / float(controlPointsHeight - 1));
        return texture2D(controlPointsTexture, texCoord).xyz;
    }

    void main(){
        vec2 uvClamped = clamp(uv, 0.0, 1.0);
        float u = uvClamped.x;
        float v = uvClamped.y;

        vec3 basisPoint = vec3(0.0);
        vec3 tangentU = vec3(0.0);
        vec3 tangentV = vec3(0.0);

        int closedAddU = closedU ? degree : 0;
        int closedAddV = closedV ? degree : 0;

        int knotsULength = controlPointsWidth - 1 + degree + 2 + closedAddU;
        int knotsVLength = controlPointsHeight - 1 + degree + 2 + closedAddV;

        for(int i = 0; i < controlPointsWidth + closedAddU; i++){
            float modU = getUniformKnotValue(degree) + u * (getUniformKnotValue(knotsULength - degree - 1) - getUniformKnotValue(degree));
            float basisU = basis(degree, i, modU);
            float basisUDerivative = basisDerivative(degree, i, modU);
            for(int j = 0; j < controlPointsHeight + closedAddV; j++){
                vec3 controlPoint = getControlPoint(i, j);
                float modV = getUniformKnotValue(degree) + v * (getUniformKnotValue(knotsVLength - degree - 1) - getUniformKnotValue(degree));
                float basisV = basis(degree, j, modV);
                float basisVDerivative = basisDerivative(degree, j, modV);
                basisPoint += controlPoint * basisU * basisV;
                tangentU += controlPoint * basisUDerivative * basisV;
                tangentV += controlPoint * basisU * basisVDerivative;
            }
        }

        vColor = color;
        vec3 normal = normalize(cross(tangentU, tangentV));
        vNormal = - normalize(normalMatrix * normal);
        vWorldNormal = normalize(mat3(modelMatrix) * normal);
        vPosition = (modelMatrix * vec4(basisPoint, 1.0)).xyz;
        vUV = uvClamped;
        vec4 mvPosition = modelViewMatrix * vec4(basisPoint, 1.0);
        vViewPosition = -mvPosition.xyz;
        gl_Position = projectionMatrix * mvPosition;

        mat3 TBN = mat3(
            normalize(normalMatrix * tangentU),
            normalize(normalMatrix * tangentV),
            vNormal
        );
        
        vTBN = TBN;
    }
`}function ue(o,t,e,i,n=!1,s=!1){const r=[],a=n?i:0,h=s?i:0,d=F(i,o.getWidth()-1+a),u=F(i,o.getHeight()-1+h);for(let m=0;m<e;m++){const p=m/(e-1);for(let g=0;g<t;g++){const f=g/(t-1);r.push(ln(o,f,p,i,d,u,n,s))}}return r}function ln(o,t,e,i,n,s,r=!1,a=!1){const h=new v(0,0,0),d=r?i:0,u=a?i:0;for(let m=0;m<o.getWidth()+d;m++){const p=n[i]+t*(n[n.length-i-1]-n[i]),g=at(i,m,p,n);for(let f=0;f<o.getHeight()+u;f++){const w=o.getPoint(f%o.getHeight(),m%o.getWidth()),P=s[i]+e*(s[s.length-i-1]-s[i]),b=at(i,f,P,s);h.add(w.clone().multiplyScalar(g*b))}}return h}function me(o,t,e,i,n=!1,s=!1){const r=[],a=n?i:0,h=s?i:0,d=F(i,o.getWidth()-1+a),u=F(i,o.getHeight()-1+h);for(let m=0;m<e;m++){const p=m/(e-1);for(let g=0;g<t;g++){const f=g/(t-1);r.push(cn(o,f,p,i,d,u,n,s))}}return r}function cn(o,t,e,i,n,s,r=!1,a=!1){const h=new v(0,0,0);var d=0;const u=r?i:0,m=a?i:0;for(let p=0;p<o.getWidth()+u;p++){const g=n[i]+t*(n[n.length-i-1]-n[i]),f=at(i,p,g,n);for(let w=0;w<o.getHeight()+m;w++){const P=o.getPoint(w%o.getHeight(),p%o.getWidth()),b=o.getPoint4(w%o.getHeight(),p%o.getWidth()).w,E=s[i]+e*(s[s.length-i-1]-s[i]),x=at(i,w,E,s),C=b*f*x;h.add(P.clone().multiplyScalar(C)),d+=C}}return h.divideScalar(d)}var si=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.SHADING=2]="SHADING",o[o.INFO=3]="INFO",o))(si||{});class Ot extends q{mode;controlPoints;degree;geometry;material;collisionGeometry;collisionMesh;radius=.1;closedU;closedV;reflectivity=0;constructor(t,e,i,n,s=2,r=new c.Color(0),a=new c.Vector3(0,0,0),h=1,d=new ee,u=!1,m=!1){if(u&&m)throw new Error("Cannot have both closedU and closedV set to true. Please set one of them to false.");const p=new Me(i,n);for(let E=0;E<i;E++)for(let x=0;x<n;x++){const C=E+x*i;p.setPoint(x,E,e[C])}const g=new c.PlaneGeometry(0,0,100,100),f=new Se(an(),p,r,d,{degree:{value:s},closedU:{value:u},closedV:{value:m}}),w=new c.Mesh(g,f.getMaterial());super(t,w,a),this.controlPoints=p,this.geometry=g,this.material=f,this.mode=h,this.color=r,this.degree=s,this.closedU=u,this.closedV=m,this.type="UniformBSplineSurfaceObject",this.export=this.exportMesh.bind(this);for(let E=0;E<i;E++)for(let x=0;x<n;x++){const C=E+x*i;this.createEditHandle(C,this.radius),this.setEditHandlePosition(C,e[C])}this.hideEditHandles(),this.controlPoints.addVisuals(this.mesh);const P=this.controlPoints.getWidth()+3,b=this.controlPoints.getHeight()+3;this.collisionGeometry=tt(ue(this.controlPoints,P,b,this.degree,this.closedU,this.closedV),P,b),this.collisionMesh=new c.Mesh(this.collisionGeometry,new c.MeshBasicMaterial({transparent:!0,opacity:0,visible:!1,side:c.DoubleSide})),this.collisionMesh.userData.collision=!0,this.collisionMesh.userData.object=this,this.mesh.add(this.collisionMesh)}getMode(){return this.mode}setMode(t){this.mode=t,this.mode===0?(this.hideEditHandles(),this.controlPoints.hideVisuals()):this.mode===1?(this.showEditHandles(),this.controlPoints.showVisuals()):this.mode===2?(this.hideEditHandles(),this.controlPoints.hideVisuals()):this.mode===3&&(this.hideEditHandles(),this.controlPoints.hideVisuals())}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.getPoints().map(t=>({x:t.x,y:t.y,z:t.z})),controlPointsWidth:this.controlPoints.getWidth(),controlPointsHeight:this.controlPoints.getHeight(),degree:this.degree,color:this.color.getHex(),mode:this.mode,closedU:this.closedU,closedV:this.closedV,shadingModel:{name:this.material.getShadingModelName(),params:this.material.getShadingModelJSON()},reflectivity:this.reflectivity}}static fromJSON(t){const e=t.controlPoints.map(d=>new c.Vector3(d.x,d.y,d.z)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(si[s]===void 0)throw new Error("Invalid UniformBSplineSurfaceObjectMode mode");const a=mt()[t.shadingModel.name??"Blinn-Phong"].create();a.fromJSON(t.shadingModel.params);const h=new Ot(t.name,e,t.controlPointsWidth,t.controlPointsHeight,t.degree??2,i,n,s,a,t.closedU??!1,t.closedV??!1);return h.setReflectivity(t.reflectivity??0),h}edit(){return this.collisionMesh.userData.collision=!1,this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint(t,e)}}unedit(){this.hideEditHandles(),this.controlPoints.hideVisuals(),this.collisionMesh.userData.collision=!0}updateColor(t){super.setColor(t),this.material.setColor(t)}getMaterial(){return this.material}dispose(){this.material.dispose()}addControlPoint(t,e){if(!this.hasEditHandle(t))return;const i=this.getEditHandlePosition(t);if(i===null)return;const n=Math.floor(t/this.controlPoints.getWidth()),s=t%this.controlPoints.getWidth(),r=i.clone().sub(e),a=new c.Vector3(0,r.y,r.z),h=new c.Vector3(r.x,r.y,0);n===0&&s===0?(this.addControlPointRowCol(n,-1,a),this.addControlPointRowCol(-1,s,h)):n===0&&s===this.controlPoints.getWidth()-1?(this.addControlPointRowCol(n,-1,a),this.addControlPointRowCol(-1,s,h)):n===this.controlPoints.getHeight()-1&&s===0?(this.addControlPointRowCol(-1,s,h),this.addControlPointRowCol(n,-1,a)):n===this.controlPoints.getHeight()-1&&s===this.controlPoints.getWidth()-1?(this.addControlPointRowCol(-1,s,h),this.addControlPointRowCol(n,-1,a)):this.addControlPointRowCol(n,s,r);for(let d=0;d<this.controlPoints.getWidth();d++)for(let u=0;u<this.controlPoints.getHeight();u++){const m=d+u*this.controlPoints.getWidth();this.setEditHandlePosition(m,this.controlPoints.getPoint(u,d))}this.material.updateControlPoints(),this.updateCollisionGeometry()}addControlPointRowCol(t,e,i){var n=0,s=0;t===0?(this.controlPoints.addRow(i,!0),n=this.controlPoints.getWidth(),s=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1)):t===this.controlPoints.getHeight()-1?(this.controlPoints.addRow(i,!1),n=this.controlPoints.getWidth(),s=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1)):e===0?(this.controlPoints.addColumn(i,!0),n=this.controlPoints.getHeight(),s=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight()):e===this.controlPoints.getWidth()-1&&(console.log("Adding column to the right"),this.controlPoints.addColumn(i,!1),n=this.controlPoints.getHeight(),s=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight());for(let r=0;r<n;r++)this.createEditHandle(s+r,this.radius)}removeControlPoint(t){if(this.controlPoints.getWidth()<=3||this.controlPoints.getHeight()<=3||!this.hasEditHandle(t))return;const e=Math.floor(t/this.controlPoints.getWidth()),i=t%this.controlPoints.getWidth();e===0||i===0||e===this.controlPoints.getHeight()-1||i===this.controlPoints.getWidth()-1?(this.removeControlPointRowCol(e,-1),this.removeControlPointRowCol(-1,i)):this.removeControlPointRowCol(e,i);for(let n=0;n<this.controlPoints.getWidth();n++)for(let s=0;s<this.controlPoints.getHeight();s++){const r=n+s*this.controlPoints.getWidth();this.setEditHandlePosition(r,this.controlPoints.getPoint(s,n))}this.getMaxDegree()<this.degree&&(this.degree=this.getMaxDegree()),this.material.updateControlPoints(),this.updateCollisionGeometry()}removeControlPointRowCol(t,e){var i=0,n=0;t===0?(i=this.controlPoints.getWidth(),n=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1),this.controlPoints.removeRow(!0)):t===this.controlPoints.getHeight()-1?(i=this.controlPoints.getWidth(),n=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1),this.controlPoints.removeRow(!1)):e===0?(i=this.controlPoints.getHeight(),n=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight(),this.controlPoints.removeColumn(!0)):e===this.controlPoints.getWidth()-1&&(i=this.controlPoints.getHeight(),n=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight(),this.controlPoints.removeColumn(!1));for(let s=0;s<i;s++)this.removeEditHandle(n+s)}updateControlPoint(t,e){const i=Math.floor(t/this.controlPoints.getWidth()),n=t%this.controlPoints.getWidth();this.controlPoints.setPoint(i,n,e),this.hasEditHandle(t)&&this.setEditHandlePosition(t,e),this.updateCollisionGeometry()}getControlPoint(t){const e=Math.floor(t/this.controlPoints.getWidth()),i=t%this.controlPoints.getWidth();return this.controlPoints.getPoint(e,i)}highlight(){this.material.setColor(it())}resetHighlight(){this.resetColor()}select(){this.resetColor()}resetSelect(){this.resetColor()}resetColor(){this.material.setColor(this.color)}setDegree(t){this.degree=t,this.material.setCustomUniform("degree",this.degree),this.updateCollisionGeometry()}getDegree(){return this.degree}getMaxDegree(){return Math.min(this.controlPoints.getWidth(),this.controlPoints.getHeight())-1}setClosedU(t){this.closedU=t,this.closedV=!1,this.material.setCustomUniform("closedU",this.closedU),this.material.setCustomUniform("closedV",this.closedV),this.updateCollisionGeometry()}setClosedV(t){this.closedV=t,this.closedU=!1,this.material.setCustomUniform("closedU",this.closedU),this.material.setCustomUniform("closedV",this.closedV),this.updateCollisionGeometry()}getClosedU(){return this.closedU}getClosedV(){return this.closedV}updateCollisionGeometry(){this.collisionGeometry.dispose();const t=this.controlPoints.getWidth()+3,e=this.controlPoints.getHeight()+3;this.collisionGeometry=tt(ue(this.controlPoints,t,e,this.degree,this.closedU,this.closedV),t,e),this.collisionMesh.geometry=this.collisionGeometry}exportMesh(){const t=ue(this.controlPoints,100,100,this.degree,this.closedU,this.closedV),e=tt(t,100,100),i=new c.MeshStandardMaterial({color:this.color,side:c.DoubleSide}),n=new c.Mesh(e,i);return n.position.copy(this.mesh.position),n.rotation.copy(this.mesh.rotation),n.scale.copy(this.mesh.scale),n}getReflectivity(){return this.reflectivity}setReflectivity(t){this.reflectivity=t}}function hn(){return`
    uniform sampler2D controlPointsTexture;
    uniform int controlPointsWidth;
    uniform int controlPointsHeight;
    uniform vec3 color;
    uniform int degree;
    uniform bool closedU;
    uniform bool closedV;

    varying vec3 vColor;
    varying vec3 vNormal;
    varying vec3 vPosition;
    varying vec2 vUV;
    varying vec3 vViewPosition;
    varying mat3 vTBN;
    varying vec3 vWorldNormal;

    float delta = 0.0001;

    float getUniformKnotValue(int index){
        return float(index);
    }

    float basis(int p, int i, float t) {
        float B[10]; //max degree 10
        
        for (int j = 0; j <= p; j++) {
            if (t >= getUniformKnotValue(i + j) && t < getUniformKnotValue(i + j + 1))
                B[j] = 1.0;
            else
                B[j] = 0.0;
        }
    
        for (int k = 1; k <= p; k++) {
            for (int j = 0; j <= p - k; j++) {
                float left = 0.0;
                float right = 0.0;
    
                float denomLeft = getUniformKnotValue(i + j + k) - getUniformKnotValue(i + j);
                if (denomLeft > delta)
                    left = ((t - getUniformKnotValue(i + j)) / denomLeft) * B[j];
    
                float denomRight = getUniformKnotValue(i + j + k + 1) - getUniformKnotValue(i + j + 1);
                if (denomRight > delta)
                    right = ((getUniformKnotValue(i + j + k + 1) - t) / denomRight) * B[j + 1];
    
                B[j] = left + right;
            }
        }
    
        return B[0];
    }

    float basisDerivative(int p, int i, float t) {
        if(p == 0) return 0.0;

        float left = 0.0;
        float right = 0.0;

        float denomLeft = getUniformKnotValue(i + p) - getUniformKnotValue(i);
        if(denomLeft > delta)
            left = (float(p) / denomLeft) * basis(p - 1, i, t);

        float denomRight = getUniformKnotValue(i + p + 1) - getUniformKnotValue(i + 1);
        if(denomRight > delta)
            right = (float(p) / denomRight) * basis(p - 1, i + 1, t);

        return left - right;
    }

    vec4 getControlPoint(int i, int j){
        int modI = i % controlPointsWidth;
        int modJ = j % controlPointsHeight;
        vec2 texCoord = vec2(float(modI) / float(controlPointsWidth - 1), float(modJ) / float(controlPointsHeight - 1));
        return texture2D(controlPointsTexture, texCoord);
    }

    void main(){
        vec2 uvClamped = clamp(uv, 0.0, 1.0);
        float u = uvClamped.x;
        float v = uvClamped.y;

        vec3 numerator = vec3(0.0);
        float denominator = 0.0;
        vec3 numeratorU = vec3(0.0);
        float denominatorU = 0.0;
        vec3 numeratorV = vec3(0.0);
        float denominatorV = 0.0;

        int closedAddU = closedU ? degree : 0;
        int closedAddV = closedV ? degree : 0;

        int knotsULength = controlPointsWidth - 1 + degree + 2 + closedAddU;
        int knotsVLength = controlPointsHeight - 1 + degree + 2 + closedAddV;

        for(int i = 0; i < controlPointsWidth + closedAddU; i++){
            float modU = getUniformKnotValue(degree) + u * (getUniformKnotValue(knotsULength - degree - 1) - getUniformKnotValue(degree));
            float basisU = basis(degree, i, modU);
            float basisUDerivative = basisDerivative(degree, i, modU);

            for(int j = 0; j < controlPointsHeight + closedAddV; j++){
                vec4 controlPoint = getControlPoint(i, j);
                float modV = getUniformKnotValue(degree) + v * (getUniformKnotValue(knotsVLength - degree - 1) - getUniformKnotValue(degree));
                float basisV = basis(degree, j, modV);
                float basisVDerivative = basisDerivative(degree, j, modV);

                float weightedBasis = controlPoint.w * basisU * basisV;
                float weightedBasisU = controlPoint.w * basisUDerivative * basisV;
                float weightedBasisV = controlPoint.w * basisU * basisVDerivative;

                numerator += controlPoint.xyz * weightedBasis;
                denominator += weightedBasis;

                numeratorU += controlPoint.xyz * weightedBasisU;
                denominatorU += weightedBasisU;

                numeratorV += controlPoint.xyz * weightedBasisV;
                denominatorV += weightedBasisV;
            }
        }

        vec3 basisPoint = numerator / denominator;
        vec3 tangentU = (numeratorU / denominator) - (numerator * denominatorU / (denominator * denominator));
        vec3 tangentV = (numeratorV / denominator) - (numerator * denominatorV / (denominator * denominator));

        vColor = color;
        vec3 normal = normalize(cross(tangentU, tangentV));
        vNormal = - normalize(normalMatrix * normal);
        vWorldNormal = normalize(mat3(modelMatrix) * normal);
        vPosition = (modelMatrix * vec4(basisPoint, 1.0)).xyz;
        vUV = uvClamped;
        vec4 mvPosition = modelViewMatrix * vec4(basisPoint, 1.0);
        vViewPosition = -mvPosition.xyz;
        gl_Position = projectionMatrix * mvPosition;

        mat3 TBN = mat3(
            normalize(normalMatrix * tangentU),
            normalize(normalMatrix * tangentV),
            vNormal
        );
        
        vTBN = TBN;
    }
`}var ri=(o=>(o[o.OBJECT=0]="OBJECT",o[o.CONTROL_POINTS=1]="CONTROL_POINTS",o[o.SHADING=2]="SHADING",o[o.INFO=3]="INFO",o))(ri||{});class Ht extends q{mode;controlPoints;degree;geometry;material;collisionGeometry;collisionMesh;radius=.1;weightEditIndex=-1;weightEditRing;closedU;closedV;reflectivity=0;constructor(t,e,i,n,s=2,r=new c.Color(0),a=new c.Vector3(0,0,0),h=1,d=new ee,u=!1,m=!1){if(u&&m)throw new Error("Cannot have both closedU and closedV set to true. Please set one of them to false.");const p=new Me(i,n);for(let C=0;C<i;C++)for(let S=0;S<n;S++){const H=C+S*i;p.setPoint4(S,C,e[H])}const g=new c.PlaneGeometry(0,0,100,100),f=new Se(hn(),p,r,d,{degree:{value:s},closedU:{value:u},closedV:{value:m}}),w=new c.Mesh(g,f.getMaterial());super(t,w,a),this.controlPoints=p,this.geometry=g,this.material=f,this.mode=h,this.color=r,this.degree=s,this.closedU=u,this.closedV=m,this.type="UniformRationalBSplineSurfaceObject",this.export=this.exportMesh.bind(this);for(let C=0;C<i;C++)for(let S=0;S<n;S++){const H=C+S*i;this.createEditHandle(H,this.radius),this.setEditHandlePosition(H,this.controlPoints.getPoint(S,C))}this.hideEditHandles(),this.controlPoints.addVisuals(this.mesh);const P=this.controlPoints.getWidth()+1,b=this.controlPoints.getHeight()+1;this.collisionGeometry=tt(me(this.controlPoints,P,b,this.degree,this.closedU,this.closedV),P,b),this.collisionMesh=new c.Mesh(this.collisionGeometry,new c.MeshBasicMaterial({transparent:!0,opacity:0,visible:!1,side:c.DoubleSide})),this.collisionMesh.userData.collision=!0,this.collisionMesh.userData.object=this,this.mesh.add(this.collisionMesh);const E=new c.RingGeometry(.05,.06,32),x=new c.MeshBasicMaterial({color:R(),depthTest:!1,side:c.DoubleSide});this.weightEditRing=new c.Mesh(E,x),w.add(this.weightEditRing),this.weightEditRing.visible=!1,l.onOrbitControlsChange(()=>{this.weightEditIndex!==-1&&this.weightEditRing.lookAt(l.getCamera().position)}),window.addEventListener("wheel",C=>{if(this.weightEditIndex!==-1){const S=this.getControlPoint(this.weightEditIndex);S.w+=C.deltaY*.01,S.w<1&&(S.w=1),S.w>10&&(S.w=10),this.updateControlPoint(this.weightEditIndex,S),M.notify("objectChanged",y.VIEWPORT,this)}})}getMode(){return this.mode}setMode(t){this.mode=t,this.mode===0?(this.hideEditHandles(),this.controlPoints.hideVisuals(),this.hideWeightEditRing()):this.mode===1?(this.showEditHandles(),this.controlPoints.showVisuals()):this.mode===2?(this.hideEditHandles(),this.controlPoints.hideVisuals(),this.hideWeightEditRing()):this.mode===3&&(this.hideEditHandles(),this.controlPoints.hideVisuals(),this.hideWeightEditRing())}toJSON(){return{name:this.name,type:this.type,position:{x:this.mesh.position.x,y:this.mesh.position.y,z:this.mesh.position.z},controlPoints:this.controlPoints.getPoints4().map(t=>({x:t.x,y:t.y,z:t.z,w:t.w})),controlPointsWidth:this.controlPoints.getWidth(),controlPointsHeight:this.controlPoints.getHeight(),degree:this.degree,color:this.color.getHex(),mode:this.mode,closedU:this.closedU,closedV:this.closedV,shadingModel:{name:this.material.getShadingModelName(),params:this.material.getShadingModelJSON()},reflectivity:this.reflectivity}}static fromJSON(t){const e=t.controlPoints.map(d=>new c.Vector4(d.x,d.y,d.z,d.w)),i=new c.Color(t.color),n=new c.Vector3(t.position.x,t.position.y,t.position.z),s=t.mode??1;if(ri[s]===void 0)throw new Error("Invalid UniformRationalBSplineSurfaceObjectMode mode");const a=mt()[t.shadingModel.name??"Blinn-Phong"].create();a.fromJSON(t.shadingModel.params);const h=new Ht(t.name,e,t.controlPointsWidth,t.controlPointsHeight,t.degree??2,i,n,s,a,t.closedU??!1,t.closedV??!1);return h.setReflectivity(t.reflectivity??0),h}edit(){return this.collisionMesh.userData.collision=!1,this.editUpdate.bind(this)}editUpdate(){if(this.mode===1){const t=l.getSelectionManager().getSelectedEditHandleIndex();if(t===null)return;const e=this.getEditHandlePosition(t);if(e===null)return;this.updateControlPoint3(t,e)}}unedit(){this.hideEditHandles(),this.controlPoints.hideVisuals(),this.hideWeightEditRing(),this.collisionMesh.userData.collision=!0}showWeightEditRing(t){this.weightEditIndex=t,this.updateWeightEditRing(),this.weightEditRing.visible=!0,l.noScroll()}hideWeightEditRing(){this.weightEditIndex=-1,this.weightEditRing.visible=!1,l.scroll()}updateWeightEditRing(){if(this.weightEditIndex===-1)return;const t=this.getControlPoint(this.weightEditIndex);this.weightEditRing.position.set(t.x,t.y,t.z);const e=Ye(t.w,1,10,8,20);this.weightEditRing.scale.set(e,e,e),this.weightEditRing.lookAt(l.getCamera().position)}updateColor(t){super.setColor(t),this.material.setColor(t)}getMaterial(){return this.material}dispose(){this.material.dispose()}addControlPoint(t,e){if(!this.hasEditHandle(t))return;const i=this.getEditHandlePosition(t);if(i===null)return;const n=Math.floor(t/this.controlPoints.getWidth()),s=t%this.controlPoints.getWidth(),r=i.clone().sub(e),a=new c.Vector3(0,r.y,r.z),h=new c.Vector3(r.x,r.y,0);n===0&&s===0?(this.addControlPointRowCol(n,-1,a),this.addControlPointRowCol(-1,s,h)):n===0&&s===this.controlPoints.getWidth()-1?(this.addControlPointRowCol(n,-1,a),this.addControlPointRowCol(-1,s,h)):n===this.controlPoints.getHeight()-1&&s===0?(this.addControlPointRowCol(-1,s,h),this.addControlPointRowCol(n,-1,a)):n===this.controlPoints.getHeight()-1&&s===this.controlPoints.getWidth()-1?(this.addControlPointRowCol(-1,s,h),this.addControlPointRowCol(n,-1,a)):this.addControlPointRowCol(n,s,r);for(let d=0;d<this.controlPoints.getWidth();d++)for(let u=0;u<this.controlPoints.getHeight();u++){const m=d+u*this.controlPoints.getWidth();this.setEditHandlePosition(m,this.controlPoints.getPoint(u,d))}this.material.updateControlPoints(),this.updateCollisionGeometry()}addControlPointRowCol(t,e,i){var n=0,s=0;t===0?(this.controlPoints.addRow(i,!0),n=this.controlPoints.getWidth(),s=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1)):t===this.controlPoints.getHeight()-1?(this.controlPoints.addRow(i,!1),n=this.controlPoints.getWidth(),s=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1)):e===0?(this.controlPoints.addColumn(i,!0),n=this.controlPoints.getHeight(),s=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight()):e===this.controlPoints.getWidth()-1&&(console.log("Adding column to the right"),this.controlPoints.addColumn(i,!1),n=this.controlPoints.getHeight(),s=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight());for(let r=0;r<n;r++)this.createEditHandle(s+r,this.radius)}removeControlPoint(t){if(this.controlPoints.getWidth()<=3||this.controlPoints.getHeight()<=3||!this.hasEditHandle(t))return;const e=Math.floor(t/this.controlPoints.getWidth()),i=t%this.controlPoints.getWidth();e===0||i===0||e===this.controlPoints.getHeight()-1||i===this.controlPoints.getWidth()-1?(this.removeControlPointRowCol(e,-1),this.removeControlPointRowCol(-1,i)):this.removeControlPointRowCol(e,i);for(let n=0;n<this.controlPoints.getWidth();n++)for(let s=0;s<this.controlPoints.getHeight();s++){const r=n+s*this.controlPoints.getWidth();this.setEditHandlePosition(r,this.controlPoints.getPoint(s,n))}this.getMaxDegree()<this.degree&&(this.degree=this.getMaxDegree()),this.material.updateControlPoints(),this.updateCollisionGeometry()}removeControlPointRowCol(t,e){var i=0,n=0;t===0?(i=this.controlPoints.getWidth(),n=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1),this.controlPoints.removeRow(!0)):t===this.controlPoints.getHeight()-1?(i=this.controlPoints.getWidth(),n=this.controlPoints.getWidth()*(this.controlPoints.getHeight()-1),this.controlPoints.removeRow(!1)):e===0?(i=this.controlPoints.getHeight(),n=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight(),this.controlPoints.removeColumn(!0)):e===this.controlPoints.getWidth()-1&&(i=this.controlPoints.getHeight(),n=(this.controlPoints.getWidth()-1)*this.controlPoints.getHeight(),this.controlPoints.removeColumn(!1));for(let s=0;s<i;s++)this.removeEditHandle(n+s)}updateControlPoint3(t,e){this.updateControlPoint(t,new c.Vector4(e.x,e.y,e.z,this.getControlPoint(t).w))}updateControlPoint(t,e){const i=Math.floor(t/this.controlPoints.getWidth()),n=t%this.controlPoints.getWidth();if(this.controlPoints.setPoint4(i,n,e),this.hasEditHandle(t)){const s=new c.Vector3(e.x,e.y,e.z);this.setEditHandlePosition(t,s)}this.updateCollisionGeometry(),this.weightEditIndex===t&&this.updateWeightEditRing()}getControlPoint(t){const e=Math.floor(t/this.controlPoints.getWidth()),i=t%this.controlPoints.getWidth();return this.controlPoints.getPoint4(e,i)}highlight(){this.material.setColor(it())}resetHighlight(){this.resetColor()}select(){this.resetColor()}resetSelect(){this.resetColor()}resetColor(){this.material.setColor(this.color)}setDegree(t){this.degree=t,this.material.setCustomUniform("degree",this.degree),this.updateCollisionGeometry()}getDegree(){return this.degree}getMaxDegree(){return Math.min(this.controlPoints.getWidth(),this.controlPoints.getHeight())-1}setClosedU(t){this.closedU=t,this.closedV=!1,this.material.setCustomUniform("closedU",this.closedU),this.material.setCustomUniform("closedV",this.closedV),this.updateCollisionGeometry()}setClosedV(t){this.closedV=t,this.closedU=!1,this.material.setCustomUniform("closedU",this.closedU),this.material.setCustomUniform("closedV",this.closedV),this.updateCollisionGeometry()}getClosedU(){return this.closedU}getClosedV(){return this.closedV}updateCollisionGeometry(){this.collisionGeometry.dispose();const t=this.controlPoints.getWidth()+1,e=this.controlPoints.getHeight()+1;this.collisionGeometry=tt(me(this.controlPoints,t,e,this.degree,this.closedU,this.closedV),t,e),this.collisionMesh.geometry=this.collisionGeometry}exportMesh(){const t=me(this.controlPoints,100,100,this.degree,this.closedU,this.closedV),e=tt(t,100,100),i=new c.MeshStandardMaterial({color:this.color,side:c.DoubleSide}),n=new c.Mesh(e,i);return n.position.copy(this.mesh.position),n.rotation.copy(this.mesh.rotation),n.scale.copy(this.mesh.scale),n}getReflectivity(){return this.reflectivity}setReflectivity(t){this.reflectivity=t}}class dn{constructor(){}createBasicLinearCurve(){const t=[new v(-5,0,0),new v(0,5,-5),new v(5,0,0)],e=new Bt("Linear Curve",t,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONLinearCurve(t){const e=Bt.fromJSON(t);return l.getObjectManager().addObject(e),e}createBasicBezierCurve(){const t=[new v(-5,0,0),new v(0,5,-5),new v(5,0,0)],e=new pt("Bezier Curve",t,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONBezierCurve(t){const e=pt.fromJSON(t);return l.getObjectManager().addObject(e),e}createBasicBezierSpline(){const t=[new v(-5,0,0),new v(-2,5,-5),new v(2,5,-5),new v(5,0,0)],e=new St("Bezier Spline",t,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONBezierSpline(t){const e=St.fromJSON(t);return l.getObjectManager().addObject(e),e}createBasicUniformBSpline(){const t=[new v(-5,0,0),new v(0,5,-5),new v(5,0,0)],e=new xt("Uniform B-Spline",t,2,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONUniformBSpline(t){const e=xt.fromJSON(t);return l.getObjectManager().addObject(e),e}createBasicURBS(){const t=[new k(-5,0,0,1),new k(0,5,-5,1),new k(5,0,0,1)],e=new Et("Uniform Rational B-Spline",t,2,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONURBS(t){const e=Et.fromJSON(t);return l.getObjectManager().addObject(e),e}createBasicBezierPatch(){const t=[new v(-5,0,-5),new v(0,0,-5),new v(5,0,-5),new v(-5,0,0),new v(0,5,0),new v(5,0,0),new v(-5,0,5),new v(0,0,5),new v(5,0,5)],e=new gt("Bezier Patch",t,3,3,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONBezierPatch(t){const e=gt.fromJSON(t);return l.getObjectManager().addObject(e),e}createBasicUniformBSplineSurface(){const t=[new v(-5,0,-5),new v(0,0,-5),new v(5,0,-5),new v(-5,0,0),new v(0,5,0),new v(5,0,0),new v(-5,0,5),new v(0,0,5),new v(5,0,5)],e=new Ot("Uniform B-Spline Surface",t,3,3,2,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONUniformBSplineSurface(t){const e=Ot.fromJSON(t);return l.getObjectManager().addObject(e),e}createBasicUniformRationalBSplineSurface(){const t=[new k(-5,0,-5,1),new k(0,0,-5,1),new k(5,0,-5,1),new k(-5,0,0,1),new k(0,5,0,1),new k(5,0,0,1),new k(-5,0,5,1),new k(0,0,5,1),new k(5,0,5,1)],e=new Ht("Uniform Rational B-Spline Surface",t,3,3,2,new V("#7f8c8d"));return l.getObjectManager().addObject(e),e}createJSONUniformRationalBSplineSurface(t){const e=Ht.fromJSON(t);return l.getObjectManager().addObject(e),e}}class un{raycaster;mouse;mouseDown;hoveredObject;hoveredEditHandle;selectedObject;selectedEditHandle;active;canEdit;constructor(){this.raycaster=new c.Raycaster,this.mouse=new c.Vector2,this.mouseDown=new c.Vector2,this.hoveredObject=null,this.hoveredEditHandle=null,this.selectedObject=null,this.selectedEditHandle=null,this.active=!1,this.canEdit=!0;const t=l.getRenderer().domElement;t.addEventListener("mousemove",e=>this.onMouseMove(e)),t.addEventListener("mousedown",e=>this.onMouseDown(e)),t.addEventListener("mouseup",e=>this.onMouseUp(e)),t.addEventListener("mouseenter",()=>this.active=!0),t.addEventListener("mouseleave",()=>{this.active=!1,this.resetHovered(),this.resetHoveredEditHandle()}),M.subscribe("objectRemoved",y.ALL,e=>{this.selectedObject&&this.selectedObject===e&&this.resetSelected(),this.hoveredObject&&this.hoveredObject===e&&this.resetHovered()})}isActive(){return this.active}getMouse(){return this.mouse}getSelectedObject(){return this.selectedObject}getSelectedEditHandleIndex(){return this.selectedEditHandle?this.selectedEditHandle.getIndex():null}onMouseMove(t){const e=l.getRenderer().domElement;this.mouse.x=t.clientX/e.clientWidth*2-1,this.mouse.y=-(t.clientY/e.clientHeight)*2+1;const i=l.getTooltip();i.style.left=t.clientX+10+"px",i.style.top=t.clientY+10+"px"}onMouseDown(t){this.mouseDown.x=t.clientX,this.mouseDown.y=t.clientY}onMouseUp(t){var e=!1;if(!(Math.abs(this.mouseDown.x-t.clientX)>=5||Math.abs(this.mouseDown.y-t.clientY)>=5)){if(this.hoveredEditHandle){this.selectEditHandle(this.hoveredEditHandle);return}else this.selectedEditHandle&&(this.resetSelectedEditHandle(),e=!0);this.hoveredObject?this.select(this.hoveredObject):e||this.resetSelected()}}update(){if(!this.active)return;this.raycaster.setFromCamera(this.mouse,l.getCamera());const t=this.raycaster.intersectObjects(l.getScene().children,!0),e=l.getObjectManager();if(t.length>0){const i=this.findMesh(t);if(i==null){this.resetHovered(),this.resetHoveredEditHandle();return}if(e.isEditHandle(i)){if(!this.canEdit)return;const s=e.getEditHandleByMesh(i);if(s==null){this.resetHoveredEditHandle();return}else if(this.selectedEditHandle&&this.selectedEditHandle===s)return;this.hoverEditHandle(s);return}else this.resetHoveredEditHandle();const n=e.getVisualObjectByMesh(i);if(n==null){this.resetHovered();return}else if(e.selectable(i)&&!l.isDragging()){if(this.selectedObject&&this.selectedObject===n)return;this.resetHovered(),this.hover(n)}else this.resetHovered()}else this.resetHovered(),this.resetHoveredEditHandle()}enableEditing(){this.canEdit=!0}disableEditing(){this.canEdit=!1,this.resetSelectedEditHandle()}hover(t){l.getHierarchy().viewportHover(t.getUUID()),this.doHover(t),this.showTooltip(t)}hoverEditHandle(t){this.doHoverEditHandle(t),this.showTooltip(t)}doHover(t){this.hoveredObject&&this.hoveredObject!==t&&this.hoveredObject.resetHighlight(),this.hoveredObject=t,this.hoveredObject.highlight()}doHoverEditHandle(t){this.hoveredEditHandle&&this.hoveredEditHandle!==t&&this.hoveredEditHandle.resetHighlight(),this.hoveredEditHandle=t,this.hoveredEditHandle.highlight()}resetHovered(){l.getHierarchy().viewportDehover(),this.doResetHovered(),this.hideTooltip()}resetHoveredEditHandle(){this.doResetHoveredEditHandle(),this.hideTooltip()}doResetHovered(){this.hoveredObject&&(this.hoveredObject.resetHighlight(),this.hoveredObject=null)}doResetHoveredEditHandle(){this.hoveredEditHandle&&(this.hoveredEditHandle.resetHighlight(),this.hoveredEditHandle=null)}select(t){l.getHierarchy().viewportSelect(t.getUUID()),this.doSelect(t)}selectEditHandle(t){this.doSelectEditHandle(t)}doSelect(t){this.selectedObject&&this.selectedObject!==t&&this.doResetSelected(),this.hoveredObject=null,this.selectedObject=t,this.selectedObject.select(),M.notify("objectSelected",y.VIEWPORT,this.selectedObject)}doSelectEditHandle(t){this.selectedEditHandle&&this.selectedEditHandle!==t&&this.doResetSelectedEditHandle(),this.hoveredEditHandle=null,this.selectedEditHandle=t,this.selectedEditHandle.select(),l.getTransformControls().attach(t.getMesh()),M.notify("editHandleSelected",y.VIEWPORT,this.selectedEditHandle)}resetSelected(){l.getHierarchy().viewportDeselect(),this.doResetSelected()}resetSelectedEditHandle(){this.doResetSelectedEditHandle()}doResetSelected(){this.selectedObject&&(this.selectedObject.resetSelect(),this.selectedObject=null,l.getTransformControls().detach(),M.notify("objectUnselected",y.ALL))}doResetSelectedEditHandle(){this.selectedEditHandle&&(this.selectedEditHandle.resetSelect(),this.selectedEditHandle=null,l.getTransformControls().detach(),M.notify("editHandleUnselected",y.ALL))}showTooltip(t){t instanceof q?(l.getTooltip().innerHTML="<b>"+t.getName()+"</b></br><i>Type:</i> "+t.getType(),l.getTooltip().style.display="block"):t instanceof _e&&(l.getTooltip().innerHTML="<b>Control Point - "+(t.getIndex()+1)+"</b></br><i>Object:</i> "+t.getParentObject().getName(),l.getTooltip().style.display="block")}hideTooltip(){l.getTooltip().style.display="none"}findMesh(t){for(const e of t)if(e.object instanceof c.Mesh&&(l.getObjectManager().selectable(e.object)||l.getObjectManager().isEditHandle(e.object)))return e.object;return null}}class mn{updateCallback;selectedObject;constructor(){this.updateCallback=null,this.selectedObject=null,M.subscribe("objectSelected",y.ALL,t=>this.selectObject(t)),M.subscribe("objectUnselected",y.ALL,()=>this.unselectObject()),M.subscribe("objectChanged",y.ALL,()=>this.update()),M.subscribe("transformMoved",y.VIEWPORT,()=>this.update())}update(){this.updateCallback&&this.updateCallback()}selectObject(t){if(!t){console.error("editManager:selectObject: Object is null!");return}this.selectedObject=t,this.updateCallback=this.selectedObject.edit()}unselectObject(){if(!this.selectedObject){console.error("editManager:unselectObject: Object is null!");return}this.updateCallback=null,this.selectedObject.unedit(),this.selectedObject=null}}class gn{controls=[];details;constructor(t){const e=document.createElement("div");e.className="controls",this.details=document.createElement("sl-details"),this.details.open=!l.getIOManager().getFlagCache("controlsClosed"),this.details.style.minWidth="120px",this.details.summary="Controls",e.appendChild(this.details),t.appendChild(e),this.initControls(),this.redraw(),M.subscribe("dimensionSwitched",y.ALL,i=>this.redraw()),this.details.addEventListener("sl-after-show",()=>l.getIOManager().setFlagCache("controlsClosed",!1)),this.details.addEventListener("sl-after-hide",()=>l.getIOManager().setFlagCache("controlsClosed",!0))}add(t){this.controls.includes(t)||(this.controls.push(t),this.redraw())}remove(t){const e=this.controls.indexOf(t);e!==-1&&(this.controls.splice(e,1),this.redraw())}redraw(){this.details.innerHTML="",this.controls.forEach(t=>{const e=document.createElement("div");e.innerHTML=t.getHTML(),this.details.appendChild(e)})}initControls(){const t=new I;t.add(new ai("Viewport Controls",!1)),t.add(new ge(l.dimension2D.bind(l),"Press <b>D</b> to switch to <b>2D</b>.","Press <b>D</b> to switch to <b>3D</b>.")),t.add(new ge(l.dimension2D.bind(l),"Hold the <b>LMB</b> to <b>orbit</b> around the scene.","Hold the <b>LMB / RMB</b> to pan the camera.")),t.add(new ge(l.dimension2D.bind(l),"Hold the <b>RMB</b> (or shift + LMB) to <b>pan</b> the camera.","")),t.add(new O("<b>Scroll</b> the mouse wheel to <b>zoom</b> in and out.")),t.add(new O("<b>Click</b> on an object to <b>select</b> it.")),this.add(t)}}class Rt{}class ai extends Rt{constructor(t,e=!0){super(),this.text=t,this.breakLine=e}getHTML(){return(this.breakLine?"<br>":"")+`<strong>${this.text}</strong>`}}class O extends Rt{constructor(t){super(),this.text=t,this.text=this.formatText(t)}getHTML(){return`<span>${this.text}</span>`}formatText(t){return t.replace(/\*([^\*]+)\*/g,"<b>$1</b>")}}class ge extends Rt{constructor(t,e,i){super(),this.bool=t,this.textFalse=e,this.textTrue=i}getHTML(){return this.bool()?`<span>${this.textTrue}</span>`:`<span>${this.textFalse}</span>`}}class B extends Rt{constructor(t,e){super(),this.key=t,this.value=e}getHTML(){return`<span><strong>${this.key}</strong>: <span>${this.value}</span></span>`}}class I extends Rt{controls=[];constructor(){super()}add(t){this.controls.push(t)}getHTML(){let t="<div>";return this.controls.forEach(e=>{t+=`<div>${e.getHTML()}</div>`}),t+="</div>",t}}class nt{constructor(t,e,i){this.name=t,this.lace=e,this.modes=i,this.currentObject=null,this.currentMode=-1,this.controls=new I,this.controls.add(new ai(t)),this.controls.add(new B("Q","Switch between modes.")),l.getControls().add(this.controls),l.getInteractionsManager().addKeydown("q",()=>{if(this.currentObject===null||this.currentMode===-1)return;const n=(this.currentMode+1)%this.modes.length;this.showTab(n),this.currentObject.setMode(n)}),this.tab=e.addTab({vertical:!0,onTabChange:()=>M.notify("inspectorTabChanged",y.INSPECTOR)}),i.forEach((n,s)=>{n.disableEditing&&n.objectMode&&console.error("Object mode cannot disable editing.");const r=this.tab.addTab(`Tab-${s}`,n.getIcon(),"lucide");n.build(r),r.registerOnSelected(()=>{this.modeSelected(s),this.resetControls(),l.getControls().add(n.getControls())}),r.registerOnDeSelected(()=>{this.modeDeselected(s),this.resetControls()})}),this.tab.onChange(()=>this.inspectorChanged()),this.hideInspector()}currentObject;currentMode;tab;controls;select(t){this.lace.hideAll(),this.currentObject=t,this.modes.forEach(i=>i.select(t)),this.objectChanged();const e=t.getMode();this.currentMode=e,this.modes[e].setActive(!0),this.showInspector(),this.showTab(e)}deselect(){this.hideInspector(),this.modes.forEach(t=>t.deselect()),this.modes[this.currentMode].setActive(!1),this.currentObject=null}objectChanged(){this.currentObject===null||this.currentMode===-1||(this.modes[this.currentMode].objectChanged(this.currentObject),this.updateTab())}inspectorChanged(){this.currentObject===null||this.currentMode===-1||(this.modes[this.currentMode].inspectorChanged(this.currentObject),M.notify("objectChanged",y.INSPECTOR))}modeSelected(t){this.currentObject===null||t>=this.modes.length||(this.modes[t].objectMode&&this.enableObjectMode(this.currentObject),this.modes[t].disableEditing?l.getSelectionManager().disableEditing():l.getSelectionManager().enableEditing(),this.currentObject.setMode(t),this.currentMode=t,this.modes[t].setActive(!0),this.objectChanged())}modeDeselected(t){t>=this.modes.length||(this.modes[t].objectMode&&this.disableObjectMode(),l.getSelectionManager().enableEditing(),this.modes[t].setActive(!1))}showTab(t){this.tab.show(`Tab-${t}`)}showInspector(){this.lace.show(this.tab),l.getControls().add(this.controls)}hideInspector(){this.lace.hide(this.tab),this.resetControls(),l.getControls().remove(this.controls)}updateTab(){this.tab.update()}resetControls(){this.modes.forEach(t=>l.getControls().remove(t.getControls()))}enableObjectMode(t){l.getTransformControls().attach(t.getMesh()),l.getSelectionManager().disableEditing()}disableObjectMode(){l.getTransformControls().detach(),l.getSelectionManager().enableEditing()}}class L{constructor(t,e,i,n=!1){this.icon=t,this.objectMode=e,this.controls=i,this.disableEditing=n}active=!1;getIcon(){return this.icon}getControls(){return this.controls}setActive(t){this.active=t}}class Nt extends Li{container;elements;changeCallback;addCallback;removeCallback;divElements=[];editorElements=[];constructor(t,e,i,n,s,r={}){const{scrollFix:a=!1}=r,h=document.createElement("div");h.style.display="flex",h.style.flexDirection="column",h.style.width="100%",h.style.alignItems="center",h.style.justifyContent="space-between",a&&(h.style.maxHeight="calc(50vh - 2rem)"),super(t,h),this.container=h,this.label=t,this.elements=e,this.changeCallback=i,this.addCallback=n,this.removeCallback=s,this.drawList()}drawList(){this.container.innerHTML="";const t=document.createElement("span");t.innerHTML=this.label,t.style.width="100%",t.style.textAlign="left",t.style.marginBottom="0.5em",t.style.fontSize="var(--sl-input-label-font-size-small)",this.container.appendChild(t),this.elements.forEach((s,r)=>{this.drawElement(r)});const e=document.createElement("sl-button-group");e.style.width="100%";const i=document.createElement("sl-button");i.innerText="Add",i.size="small",i.variant="success",i.outline=!0,i.style.width="50%",i.onclick=()=>this.addCallback();const n=document.createElement("sl-button");n.innerText="Remove",n.size="small",n.variant="danger",n.outline=!0,n.style.width="50%",n.onclick=()=>this.removeCallback(),e.appendChild(i),e.appendChild(n),this.container.appendChild(document.createElement("br")),this.container.appendChild(e),this.container.appendChild(document.createElement("br"))}changedIndex(t){this.changeCallback(t),this.changed()}updateIndex(t){this.editorElements[t].forEach(e=>e.update())}getObj(){return null}getKeys(){return[]}update(){this.drawNewElements(),this.removeOldElements(),this.editorElements.forEach((t,e)=>{t.forEach(i=>i.update())})}setSize(t){}drawNewElements(){const t=this.elements.length-this.divElements.length;for(let e=0;e<t;e++)this.drawElement(this.elements.length-t+e)}removeOldElements(){const t=this.divElements.length-this.elements.length;for(let e=0;e<t;e++)this.divElements.pop().remove()}drawElement(t){const e=document.createElement("div");e.classList.add("list-item"),e.style.width="100%",e.style.display="flex",e.style.flexDirection="row",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.padding="0.5em";const i=document.createElement("span");i.innerHTML="<i>"+(t+1).toString()+"</i>: ",i.style.width="20%",i.style.textAlign="center",i.style.marginRight="1em",e.appendChild(i);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.minWidth="0",n.style.flexGrow="1",this.editorElements[t]=[];var s=0;this.elements[t].getEditor().forEach(a=>{if(this.editorElements[t].push(a),a.registerUpdateCallback(()=>this.changedIndex(t)),a.setSize("small"),s>0){const h=document.createElement("br");n.appendChild(h)}n.appendChild(a.element),s++}),e.appendChild(n),this.divElements.push(e),this.container.appendChild(e)}}class zt{}class ht extends L{tab=null;info;constructor(t){const e=new I;super("info",!1,e,!0),this.info="",fetch(`infos/${t}.txt`).then(i=>i.text()).then(i=>{this.info=this.formatInfo(i),this.updateInfo()}).catch(()=>{this.info="No info loaded...",this.updateInfo()})}build(t){this.tab=t,this.updateInfo()}updateInfo(){this.tab&&this.info!=""&&(this.tab.add(new D(this.info,{block:!0})),MathJax.typeset())}formatInfo(t){let e=[];const i=t.split(`
`);for(const n in i){const s=this.formatLine(i[n]);e.push(s)}return e.join("<br/>")}formatLine(t){let e="";const i=t.split("");let n=!1,s=!1,r=!1;for(const a of i)a==="*"?(e+=n?"</b>":"<b>",n=!n):a==="#"?(e+=" \\( ",s=!0):a===" "?(e+=s?" \\) ":a,s=!1):a==="@"?(e+=r?" \\] ":" \\[ ",r=!r):e+=a;return e}select(t){}deselect(){}objectChanged(t){}inspectorChanged(t){}}class pn extends nt{constructor(t){const e=[new fn,new wn,new vn,new ht("beziercurve")];super("Bezier Curve",t,e)}}let fn=class extends L{params;constructor(){const t=new I;t.add(new O("*Move* the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,color:"#000000"}}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color"))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color))}},wn=class extends L{controlPoints;currentObject;laceList;atFront=!1;constructor(){const t=new I;t.add(new O("*Click* on a control point to *select* it.")),t.add(new O("*Move* the selected control point with the transform controls.")),t.add(new B("E/Insert","Insert a new control point at the last selected endpoint.")),t.add(new B("R/Delete","Remove the last control point.")),super("waypoints",!1,t),this.controlPoints=[],this.currentObject=null,this.laceList=new Nt("Control Points",this.controlPoints,this.listChanged.bind(this),this.listAdd.bind(this),this.listRemove.bind(this),{scrollFix:!0}),M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(e.getIndex()===0?this.atFront=!0:e.getIndex()===this.controlPoints.length-1&&(this.atFront=!1))}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.atFront?this.controlPoints[0].getPosition():this.controlPoints[this.controlPoints.length-1].getPosition(),s=new lt().setFromNormalAndCoplanarPoint(i,n),r=new v;e.ray.intersectPlane(s,r),r.x=Math.round(r.x*100)/100,r.y=Math.round(r.y*100)/100,r.z=Math.round(r.z*100)/100,this.addControlPoint(r.sub(this.currentObject.getPosition()),this.atFront)}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.removeControlPoint(this.atFront)}).bind(this))}build(t){t.add(this.laceList)}select(t){this.atFront=!1,this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){const e=t.getControlPoints();this.controlPoints.length=0,e.forEach((i,n)=>{this.controlPoints.push(new bn(i))}),this.laceList.update()}inspectorChanged(t){}listChanged(t){this.currentObject!==null&&this.currentObject.updateControlPoint(t,this.controlPoints[t].getPosition())}listAdd(){if(this.currentObject===null)return;const t=this.controlPoints[this.controlPoints.length-2].getPosition(),e=this.controlPoints[this.controlPoints.length-1].getPosition(),i=Dt(e,t);this.addControlPoint(i)}addControlPoint(t,e=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.addControlPoint(t,e),this.objectChanged(this.currentObject))}listRemove(){this.currentObject!==null&&(this.removeControlPoint(),this.objectChanged(this.currentObject))}removeControlPoint(t=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}};class bn extends zt{position;constructor(t){super(),this.position=t}setPosition(t){this.position.set(t.x,t.y,t.z)}getPosition(){const t=new v;return t.set(this.position.x,this.position.y,this.position.z),t}getEditor(){return[new A("Position",this.position,"x","y","z")]}}class vn extends L{params;currentObject;slider;constructor(){const t=new I;t.add(new O("*Hover* over the curve to adjust the t-value.")),super("spline",!1,t,!0),this.params={t:0},this.currentObject=null,this.slider=new j("T",this.params,"t",{min:0,max:1,step:.01}),window.addEventListener("mousemove",(e=>{if(!this.active||l.isOrbiting()||this.currentObject===null)return;const i=new et;i.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const n=i.intersectObject(this.currentObject.getCollisionMesh(),!1);if(n.length>0){const s=n[0].point.sub(this.currentObject.getPosition());this.currentObject.updateDeCasteljauFromNearestPoint(s),this.params.t=this.currentObject.getDeCasteljauT(),this.slider.update()}}).bind(this))}build(t){t.add(new D("De-Casteljau Visualization")),t.add(this.slider)}select(t){this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){this.params.t=t.getDeCasteljauT()}inspectorChanged(t){t.updateDeCasteljauT(this.params.t)}}class Pn extends nt{constructor(t){const e=[new Cn,new yn,new ht("linearcurve")];super("Linear Curve",t,e)}}let Cn=class extends L{params;constructor(){const t=new I;t.add(new O("<b>Move</b> the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,color:"#000000"}}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color"))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color))}},yn=class extends L{controlPoints;currentObject;laceList;atFront=!1;constructor(){const t=new I;t.add(new O("<b>Click</b> on a control point to <b>select</b> it.")),t.add(new O("<b>Move</b> the selected control point with the transform controls.")),t.add(new B("E/Insert","Insert a new control point at the last selected endpoint.")),t.add(new B("R/Delete","Remove the last control point.")),super("waypoints",!1,t),this.controlPoints=[],this.currentObject=null,this.laceList=new Nt("Control Points",this.controlPoints,this.listChanged.bind(this),this.listAdd.bind(this),this.listRemove.bind(this),{scrollFix:!0}),M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(e.getIndex()===0?this.atFront=!0:e.getIndex()===this.controlPoints.length-1&&(this.atFront=!1))}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.atFront?this.controlPoints[0].getPosition():this.controlPoints[this.controlPoints.length-1].getPosition(),s=new lt().setFromNormalAndCoplanarPoint(i,n),r=new v;e.ray.intersectPlane(s,r),r.x=Math.round(r.x*100)/100,r.y=Math.round(r.y*100)/100,r.z=Math.round(r.z*100)/100,this.addControlPoint(r.sub(this.currentObject.getPosition()),this.atFront)}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.removeControlPoint(this.atFront)}).bind(this))}build(t){t.add(this.laceList)}select(t){this.atFront=!1,this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){const e=t.getControlPoints();this.controlPoints.length=0,e.forEach((i,n)=>{this.controlPoints.push(new Mn(i))}),this.laceList.update()}inspectorChanged(t){}listChanged(t){this.currentObject!==null&&this.currentObject.updateControlPoint(t,this.controlPoints[t].getPosition())}listAdd(){if(this.currentObject===null)return;const t=this.controlPoints[this.controlPoints.length-2].getPosition(),e=this.controlPoints[this.controlPoints.length-1].getPosition(),i=Dt(e,t);this.addControlPoint(i)}addControlPoint(t,e=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.addControlPoint(t,e),this.objectChanged(this.currentObject))}listRemove(){this.currentObject!==null&&(this.removeControlPoint(),this.objectChanged(this.currentObject))}removeControlPoint(t=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}};class Mn extends zt{position;constructor(t){super(),this.position=t}setPosition(t){this.position.set(t.x,t.y,t.z)}getPosition(){const t=new v;return t.set(this.position.x,this.position.y,this.position.z),t}getEditor(){return[new A("Position",this.position,"x","y","z")]}}class xn extends nt{constructor(t){const e=[new En,new Sn,new ht("ubscurve")];super("Uniform B-Spline",t,e)}}let En=class extends L{params;degreeSlider;constructor(){const t=new I;t.add(new O("<b>Move</b> the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,degree:2,color:"#000000",closed:!1},this.degreeSlider=new j("Degree",this.params,"degree",{min:2,max:10,step:1})}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color")),t.add(this.degreeSlider),t.add(new Zt("Closed",this.params,"closed"))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString(),this.params.degree=t.getDegree(),this.degreeSlider.setMax(t.getControlPoints().length-1),this.params.closed=t.isClosed()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color)),t.setDegree(this.params.degree),t.setClosed(this.params.closed)}},Sn=class extends L{controlPoints;currentObject;laceList;atFront=!1;constructor(){const t=new I;t.add(new O("<b>Click</b> on a control point to <b>select</b> it.")),t.add(new O("<b>Move</b> the selected control point with the transform controls.")),t.add(new B("E/Insert","Insert a new control point at the last selected endpoint.")),t.add(new B("R/Delete","Remove the last control point.")),super("waypoints",!1,t),this.controlPoints=[],this.currentObject=null,this.laceList=new Nt("Control Points",this.controlPoints,this.listChanged.bind(this),this.listAdd.bind(this),this.listRemove.bind(this),{scrollFix:!0}),M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(e.getIndex()===0?this.atFront=!0:e.getIndex()===this.controlPoints.length-1&&(this.atFront=!1))}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.atFront?this.controlPoints[0].getPosition():this.controlPoints[this.controlPoints.length-1].getPosition(),s=new lt().setFromNormalAndCoplanarPoint(i,n),r=new v;e.ray.intersectPlane(s,r),r.x=Math.round(r.x*100)/100,r.y=Math.round(r.y*100)/100,r.z=Math.round(r.z*100)/100,this.addControlPoint(r.sub(this.currentObject.getPosition()),this.atFront)}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.removeControlPoint(this.atFront)}).bind(this))}build(t){t.add(this.laceList)}select(t){this.atFront=!1,this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){const e=t.getControlPoints();this.controlPoints.length=0,e.forEach((i,n)=>{this.controlPoints.push(new On(i))}),this.laceList.update()}inspectorChanged(t){}listChanged(t){this.currentObject!==null&&this.currentObject.updateControlPoint(t,this.controlPoints[t].getPosition())}listAdd(){if(this.currentObject===null)return;const t=this.controlPoints[this.controlPoints.length-2].getPosition(),e=this.controlPoints[this.controlPoints.length-1].getPosition(),i=Dt(e,t);this.addControlPoint(i)}addControlPoint(t,e=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.addControlPoint(t,e),this.objectChanged(this.currentObject))}listRemove(){this.currentObject!==null&&(this.removeControlPoint(),this.objectChanged(this.currentObject))}removeControlPoint(t=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}};class On extends zt{position;constructor(t){super(),this.position=t}setPosition(t){this.position.set(t.x,t.y,t.z)}getPosition(){const t=new v;return t.set(this.position.x,this.position.y,this.position.z),t}getEditor(){return[new A("Position",this.position,"x","y","z")]}}class Hn extends nt{constructor(t){const e=[new In,new jn,new ht("urbscurve")];super("Uniform Rational B-Spline",t,e)}}let In=class extends L{params;degreeSlider;constructor(){const t=new I;t.add(new O("<b>Move</b> the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,degree:2,color:"#000000",closed:!1},this.degreeSlider=new j("Degree",this.params,"degree",{min:2,max:10,step:1})}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color")),t.add(this.degreeSlider),t.add(new Zt("Closed",this.params,"closed"))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString(),this.params.degree=t.getDegree(),this.degreeSlider.setMax(t.getControlPoints().length-1),this.params.closed=t.isClosed()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color)),t.setDegree(this.params.degree),t.setClosed(this.params.closed)}},jn=class extends L{controlPoints;currentObject;laceList;atFront=!1;constructor(){const t=new I;t.add(new O("<b>Click</b> on a control point to <b>select</b> it.")),t.add(new O("<b>Move</b> the selected control point with the transform controls.")),t.add(new B("E/Insert","Insert a new control point at the last selected endpoint.")),t.add(new B("R/Delete","Remove the last control point.")),t.add(new O("When a control point is selected, <b>scroll</b> to change its weight.")),super("waypoints",!1,t),this.controlPoints=[],this.currentObject=null,this.laceList=new Nt("Control Points",this.controlPoints,this.listChanged.bind(this),this.listAdd.bind(this),this.listRemove.bind(this),{scrollFix:!0}),M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(e.getIndex()===0?this.atFront=!0:e.getIndex()===this.controlPoints.length-1&&(this.atFront=!1),this.currentObject.showWeightEditRing(e.getIndex()))}),M.subscribe("editHandleUnselected",y.ALL,()=>{this.currentObject&&this.currentObject.hideWeightEditRing()}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.atFront?this.controlPoints[0].getPosition():this.controlPoints[this.controlPoints.length-1].getPosition(),s=new lt().setFromNormalAndCoplanarPoint(i,n),r=new v;e.ray.intersectPlane(s,r),r.x=Math.round(r.x*100)/100,r.y=Math.round(r.y*100)/100,r.z=Math.round(r.z*100)/100,this.addControlPoint(r.sub(this.currentObject.getPosition()),this.atFront)}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.removeControlPoint(this.atFront)}).bind(this))}build(t){t.add(this.laceList)}select(t){this.atFront=!1,this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){const e=t.getControlPoints();this.controlPoints.length=0,e.forEach((i,n)=>{this.controlPoints.push(new Vn(i))}),this.laceList.update()}inspectorChanged(t){}listChanged(t){if(this.currentObject===null)return;const e=this.controlPoints[t].getPosition(),i=new k(e.x,e.y,e.z,this.controlPoints[t].getWeight());this.currentObject.updateControlPoint(t,i)}listAdd(){if(this.currentObject===null)return;const t=this.controlPoints[this.controlPoints.length-2].getPosition(),e=this.controlPoints[this.controlPoints.length-1].getPosition(),i=Dt(e,t);this.addControlPoint(i)}addControlPoint(t,e=!1){if(this.currentObject===null)return;l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle();const i=new k(t.x,t.y,t.z,1);this.currentObject.addControlPoint(i,e),this.objectChanged(this.currentObject)}listRemove(){this.currentObject!==null&&(this.removeControlPoint(),this.objectChanged(this.currentObject))}removeControlPoint(t=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}};class Vn extends zt{position;constructor(t){super(),this.position=t}setPosition(t){this.position.set(t.x,t.y,t.z,this.position.w)}getPosition(){const t=new v;return t.set(this.position.x,this.position.y,this.position.z),t}setWeight(t){this.position.set(this.position.x,this.position.y,this.position.z,t)}getWeight(){return this.position.w}getEditor(){const t=new A("Position",this.position,"x","y","z"),e=new j("Weight",this.position,"w",{min:1,max:10,step:.5});return[t,e]}}class Ln extends nt{constructor(t){const e=[new Tn,new Bn,new ht("bezierspline")];super("Bezier Spline",t,e)}}let Tn=class extends L{params;constructor(){const t=new I;t.add(new O("<b>Move</b> the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,color:"#000000"}}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color"))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color))}},Bn=class extends L{controlPoints;currentObject;laceList;atFront=!1;constructor(){const t=new I;t.add(new O("<b>Click</b> on a control point to <b>select</b> it.")),t.add(new O("<b>Move</b> the selected control point with the transform controls.")),t.add(new B("E/Insert","Insert a new control point at the last selected endpoint.")),t.add(new B("R/Delete","Remove the last control point.")),super("waypoints",!1,t),this.controlPoints=[],this.currentObject=null,this.laceList=new Nt("Control Points",this.controlPoints,this.listChanged.bind(this),this.listAdd.bind(this),this.listRemove.bind(this),{scrollFix:!0}),M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(e.getIndex()===0?this.atFront=!0:e.getIndex()===this.controlPoints.length-1&&(this.atFront=!1))}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.atFront?this.controlPoints[0].getPosition():this.controlPoints[this.controlPoints.length-1].getPosition(),s=new lt().setFromNormalAndCoplanarPoint(i,n),r=new v;e.ray.intersectPlane(s,r),r.x=Math.round(r.x*100)/100,r.y=Math.round(r.y*100)/100,r.z=Math.round(r.z*100)/100,this.addControlPoint(r.sub(this.currentObject.getPosition()),this.atFront)}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.removeControlPoint(this.atFront)}).bind(this))}build(t){t.add(new D("Control Points",{bold:!0})),t.add(new D("Work in progress!",{italic:!0}))}select(t){this.atFront=!1,this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){const e=t.getControlPoints();this.controlPoints.length=0,e.forEach((i,n)=>{this.controlPoints.push(new Un(i))}),this.laceList.update()}inspectorChanged(t){}listChanged(t){this.currentObject!==null&&(this.currentObject.updateControlPoint(t,this.controlPoints[t].getPosition()),this.objectChanged(this.currentObject))}listAdd(){if(this.currentObject===null)return;const t=this.controlPoints[this.controlPoints.length-2].getPosition(),e=this.controlPoints[this.controlPoints.length-1].getPosition(),i=Dt(e,t);this.addControlPoint(i)}addControlPoint(t,e=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.addControlPoint(t,e),this.objectChanged(this.currentObject))}listRemove(){this.currentObject!==null&&(this.removeControlPoint(),this.objectChanged(this.currentObject))}removeControlPoint(t=!1){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}};class Un extends zt{position;constructor(t){super(),this.position=t.clone()}setPosition(t){this.position.set(t.x,t.y,t.z)}getPosition(){const t=new v;return t.set(this.position.x,this.position.y,this.position.z),t}getEditor(){return[new A("Position",this.position,"x","y","z")]}}class Oe extends L{currentObject;group=void 0;params;constructor(){const t=new I;super("brick-wall",!1,t,!0),this.currentObject=null;const e=Object.keys(mt())[0],i=mt()[e];this.params={shadingModel:i.name,color:"#000000"}}build(t){t.add(new Ut("Shading Model",this.params,"shadingModel",this.getShadingModelsDropdown())),t.add(new J("Color",this.params,"color")),this.group=t.addGroup(),this.currentObject!==null&&this.currentObject.getMaterial().buildUI(this.group)}select(t){this.currentObject=t,this.group!==void 0&&(this.group.reset(),this.currentObject.getMaterial().buildUI(this.group))}deselect(){this.currentObject=null}objectChanged(t){this.params.color=t.getColor().getHexString(),this.params.shadingModel=t.getMaterial().getShadingModelName()}inspectorChanged(t){if(!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.updateColor(new V(this.params.color)),t.getMaterial().getShadingModelName()!==this.params.shadingModel){const i=this.createShadingModel(this.params.shadingModel);t.getMaterial().setShadingModel(i)}}createShadingModel(t){return mt()[t].create()}getShadingModelsDropdown(){const t=mt(),e={};for(const i in t)e[i]=t[i].name;return e}}class Dn extends nt{constructor(t){const e=[new Rn,new Nn,new Oe,new ht("bezierpatch")];super("Bezier Patch",t,e)}}let Rn=class extends L{params;constructor(){const t=new I;t.add(new O("<b>Move</b> the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,color:"#000000",reflectivity:0}}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color")),t.add(new Qt),t.add(new j("Reflectivity",this.params,"reflectivity",{min:0,max:1,step:.01}))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString(),this.params.reflectivity=t.getReflectivity()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color)),t.setReflectivity(this.params.reflectivity)}},Nn=class extends L{currentObject;lastIndex=null;constructor(){const t=new I;t.add(new O("<b>Click</b> on a control point to <b>select</b> it.")),t.add(new O("<b>Move</b> the selected control point with the transform controls.")),t.add(new O("<b>Once you have selected a control point</b> (at the edges):")),t.add(new B("E/Insert","Insert a new row and/or column at the mouse position.")),t.add(new B("R/Delete","Remove the last row and/or column.")),super("waypoints",!1,t),this.currentObject=null,M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(this.lastIndex=e.getIndex())}),M.subscribe("editHandleUnselected",y.ALL,()=>{this.lastIndex=null}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null||this.lastIndex===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.currentObject.getControlPoint(this.lastIndex),s=new lt().setFromNormalAndCoplanarPoint(i,n),r=new v;e.ray.intersectPlane(s,r),r.x=Math.round(r.x*100)/100,r.y=Math.round(r.y*100)/100,r.z=Math.round(r.z*100)/100,this.addControlPoint(this.lastIndex,r.sub(this.currentObject.getPosition()))}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.lastIndex!==null&&this.removeControlPoint(this.lastIndex)}).bind(this))}build(t){t.add(new D("Control Points",{bold:!0})),t.add(new D("Work in progress!",{italic:!0}))}select(t){this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){}inspectorChanged(t){}addControlPoint(t,e){this.currentObject&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.addControlPoint(t,e),this.objectChanged(this.currentObject))}removeControlPoint(t){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}};class zn extends nt{constructor(t){const e=[new kn,new Wn,new Oe,new ht("ubssurface")];super("Uniform B-Spline Surface",t,e)}}let kn=class extends L{params;degreeSlider;constructor(){const t=new I;t.add(new O("<b>Move</b> the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,color:"#000000",degree:0,closed:"none",reflectivity:0},this.degreeSlider=new j("Degree",this.params,"degree",{min:2,max:10,step:1})}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color")),t.add(this.degreeSlider),t.add(new Ut("Closed",this.params,"closed",{none:"None",u:"X",v:"Y"})),t.add(new Qt),t.add(new j("Reflectivity",this.params,"reflectivity",{min:0,max:1,step:.01}))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString(),this.params.degree=t.getDegree(),this.degreeSlider.setMax(t.getMaxDegree()),this.params.closed=t.getClosedU()?"u":t.getClosedV()?"v":"none",this.params.reflectivity=t.getReflectivity()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color)),t.setDegree(this.params.degree),this.params.closed==="u"?t.setClosedU(!0):this.params.closed==="v"?t.setClosedV(!0):(t.setClosedU(!1),t.setClosedV(!1)),t.setReflectivity(this.params.reflectivity)}},Wn=class extends L{currentObject;lastIndex=null;constructor(){const t=new I;t.add(new O("<b>Click</b> on a control point to <b>select</b> it.")),t.add(new O("<b>Move</b> the selected control point with the transform controls.")),t.add(new O("<b>Once you have selected a control point</b> (at the edges):")),t.add(new B("E/Insert","Insert a new row and/or column at the mouse position.")),t.add(new B("R/Delete","Remove the last row and/or column.")),super("waypoints",!1,t),this.currentObject=null,M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(this.lastIndex=e.getIndex())}),M.subscribe("editHandleUnselected",y.ALL,()=>{this.lastIndex=null}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null||this.lastIndex===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.currentObject.getControlPoint(this.lastIndex),s=new lt().setFromNormalAndCoplanarPoint(i,n),r=new v;e.ray.intersectPlane(s,r),r.x=Math.round(r.x*100)/100,r.y=Math.round(r.y*100)/100,r.z=Math.round(r.z*100)/100,this.addControlPoint(this.lastIndex,r.sub(this.currentObject.getPosition()))}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.lastIndex!==null&&this.removeControlPoint(this.lastIndex)}).bind(this))}build(t){t.add(new D("Control Points",{bold:!0})),t.add(new D("Work in progress!",{italic:!0}))}select(t){this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){}inspectorChanged(t){}addControlPoint(t,e){this.currentObject&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.addControlPoint(t,e),this.objectChanged(this.currentObject))}removeControlPoint(t){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}};class Fn extends nt{constructor(t){const e=[new An,new Gn,new Oe,new ht("urbssurface")];super("Uniform Rational B-Spline Surface",t,e)}}class An extends L{params;degreeSlider;constructor(){const t=new I;t.add(new O("<b>Move</b> the object with the transform control.")),super("box",!0,t),this.params={name:"",position:new v,color:"#000000",degree:0,closed:"none",reflectivity:0},this.degreeSlider=new j("Degree",this.params,"degree",{min:2,max:10,step:1})}build(t){t.add(new ct("",this.params,"name")),t.add(new A("Position",this.params.position,"x","y","z")),t.add(new J("Color",this.params,"color")),t.add(this.degreeSlider),t.add(new Ut("Closed",this.params,"closed",{none:"None",u:"X",v:"Y"})),t.add(new Qt),t.add(new j("Reflectivity",this.params,"reflectivity",{min:0,max:1,step:.01}))}select(t){}deselect(){}objectChanged(t){this.params.name=t.getName(),this.params.position.set(t.getPosition().x,t.getPosition().y,t.getPosition().z),this.params.color=t.getColor().getHexString(),this.params.degree=t.getDegree(),this.degreeSlider.setMax(t.getMaxDegree()),this.params.closed=t.getClosedU()?"u":t.getClosedV()?"v":"none",this.params.reflectivity=t.getReflectivity()}inspectorChanged(t){!this.params.color.startsWith("#")&&!this.params.color.startsWith("rgb")&&(this.params.color="#"+this.params.color),t.setName(this.params.name),t.setPosition(this.params.position),t.updateColor(new V(this.params.color)),t.setDegree(this.params.degree),this.params.closed==="u"?t.setClosedU(!0):this.params.closed==="v"?t.setClosedV(!0):(t.setClosedU(!1),t.setClosedV(!1)),t.setReflectivity(this.params.reflectivity)}}class Gn extends L{currentObject;lastIndex=null;constructor(){const t=new I;t.add(new O("<b>Click</b> on a control point to <b>select</b> it.")),t.add(new O("<b>Move</b> the selected control point with the transform controls.")),t.add(new O("When a control point is selected, <b>scroll</b> to change its weight.")),t.add(new O("<b>Once you have selected a control point</b> (at the edges):")),t.add(new B("E/Insert","Insert a new row and/or column at the mouse position.")),t.add(new B("R/Delete","Remove the last row and/or column.")),super("waypoints",!1,t),this.currentObject=null,M.subscribe("editHandleSelected",y.ALL,e=>{this.currentObject&&(this.lastIndex=e.getIndex(),this.currentObject.showWeightEditRing(e.getIndex()))}),M.subscribe("editHandleUnselected",y.ALL,()=>{this.lastIndex=null,this.currentObject&&this.currentObject.hideWeightEditRing()}),l.getInteractionsManager().addKeydowns(["e","insert"],(()=>{if(!this.active||this.currentObject===null||this.lastIndex===null)return;const e=new et;e.setFromCamera(l.getSelectionManager().getMouse(),l.getCamera());const i=new v;l.getCamera().getWorldDirection(i);const n=this.currentObject.getControlPoint(this.lastIndex),s=new v(n.x,n.y,n.z),r=new lt().setFromNormalAndCoplanarPoint(i,s),a=new v;e.ray.intersectPlane(r,a),a.x=Math.round(a.x*100)/100,a.y=Math.round(a.y*100)/100,a.z=Math.round(a.z*100)/100,this.addControlPoint(this.lastIndex,a.sub(this.currentObject.getPosition()))}).bind(this)),l.getInteractionsManager().addKeydowns(["r","delete"],(()=>{this.active&&this.currentObject!==null&&this.lastIndex!==null&&this.removeControlPoint(this.lastIndex)}).bind(this))}build(t){t.add(new D("Control Points",{bold:!0})),t.add(new D("Work in progress!",{italic:!0}))}select(t){this.currentObject=t}deselect(){this.currentObject=null}objectChanged(t){}inspectorChanged(t){}addControlPoint(t,e){this.currentObject&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.addControlPoint(t,e),this.objectChanged(this.currentObject))}removeControlPoint(t){this.currentObject!==null&&(l.getTransformControls().detach(),l.getSelectionManager().doResetSelectedEditHandle(),this.currentObject.removeControlPoint(t),this.objectChanged(this.currentObject))}}var li=(o=>(o[o.LOW=0]="LOW",o[o.MEDIUM=1]="MEDIUM",o[o.HIGH=2]="HIGH",o))(li||{}),z=(o=>(o[o.CUSTOM=0]="CUSTOM",o[o.LOW=1]="LOW",o[o.HD=2]="HD",o[o.FULL_HD=3]="FULL_HD",o[o.QHD=4]="QHD",o[o.UHD=5]="UHD",o))(z||{}),W=(o=>(o[o.NONE=0]="NONE",o[o.UVS=1]="UVS",o[o.NORMALS=2]="NORMALS",o[o.NR_STEPS=3]="NR_STEPS",o))(W||{}),st=(o=>(o[o.GRADIENT=0]="GRADIENT",o[o.BLACK=1]="BLACK",o[o.WHITE=2]="WHITE",o[o.TRANSPARENT=3]="TRANSPARENT",o))(st||{}),ut=(o=>(o[o.BezierPatch=0]="BezierPatch",o[o.Sphere=1]="Sphere",o[o.Cylinder=2]="Cylinder",o))(ut||{});class He{type;position;color;reflectivity;castShadow;layer;constructor(t,e,i,n=0,s=!0,r=0){this.type=t,this.position=e,this.color=i,this.reflectivity=n,this.castShadow=s,this.layer=r}}class pe extends He{controlPoints;data={};constructor(t,e,i,n=0){super(0,e,i,n),this.controlPoints=t}}class _t extends He{radius;constructor(t,e,i,n=0,s=!1,r=0){super(1,t,e,n,s,r),this.radius=i}}class Yt extends He{pointA;pointB;radius;constructor(t,e,i,n,s,r=0,a=!1,h=0){super(2,t,s,r,a,h),this.pointA=e,this.pointB=i,this.radius=n}}function re(o){return new c.Vector3(o.x/o.w,o.y/o.w,o.z/o.w)}class Jn{dialog;preview;previewContainer;console;consolePanel;progressBar;downloadButton;closeButton;tabGroup;constructor(){this.dialog=document.createElement("sl-dialog"),this.dialog.classList.add("raytracer-dialog"),this.dialog.noHeader=!0,this.dialog.style.setProperty("--width","80vw"),this.dialog.style.color="var(--sl-input-color)",this.dialog.style.fontFamily="var(--sl-font-sans)",this.dialog.addEventListener("sl-request-close",m=>{m.preventDefault()});const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.width="100%",t.style.height="70vh";const e=document.createElement("sl-tab-group");e.placement="start",e.style.width="100%",e.style.flex="1 1 0",e.style.minHeight="0",e.style.overflow="hidden",t.appendChild(e),e.addEventListener("sl-tab-show",m=>{this.scrollToBottom(),requestAnimationFrame(this.renderPreview.bind(this))}),this.tabGroup=e;const i=document.createElement("sl-tab");i.slot="nav",i.panel="preview";const n=document.createElement("sl-icon");n.name="eye",n.library="lucide",n.style.fontSize="1.3em",n.style.marginRight="5px",i.appendChild(n),i.appendChild(document.createTextNode("Preview")),e.appendChild(i);const s=document.createElement("sl-tab-panel");s.name="preview",e.appendChild(s),this.previewContainer=document.createElement("div"),this.previewContainer.style.display="flex",this.previewContainer.style.width="100%",this.previewContainer.style.height="100%",this.previewContainer.style.justifyContent="center",this.previewContainer.style.alignItems="center",s.appendChild(this.previewContainer),this.preview=document.createElement("canvas"),this.preview.style.borderRadius="var(--sl-border-radius-medium)",this.previewContainer.appendChild(this.preview);const r=document.createElement("sl-tab");r.slot="nav",r.panel="console";const a=document.createElement("sl-icon");a.name="square-terminal",a.library="lucide",a.style.fontSize="1.3em",a.style.marginRight="5px",r.appendChild(a),r.appendChild(document.createTextNode("Output")),e.appendChild(r),this.consolePanel=document.createElement("sl-tab-panel"),this.consolePanel.name="console",this.consolePanel.style.height="100%",this.consolePanel.style.overflowX="auto",e.appendChild(this.consolePanel),this.console=document.createElement("div"),this.console.style.height="100%",this.console.style.padding="10px",this.console.style.backgroundColor="var(--sl-color-neutral-200)",this.console.style.color="var(--sl-color-neutral-900)",this.console.style.fontFamily="var(--sl-font-mono)",this.console.style.fontSize="var(--sl-font-size-small)",this.console.style.fontWeight="var(--sl-font-weight-bold)",this.console.style.borderRadius="var(--sl-border-radius-medium)",this.console.style.overflow="auto",this.consolePanel.appendChild(this.console);const h=document.createElement("div");h.style.display="flex",h.style.flexDirection="row",h.style.alignContent="center",h.style.justifyContent="space-around",h.style.alignItems="center",h.style.marginTop="20px",t.appendChild(h),this.progressBar=document.createElement("sl-progress-bar"),this.progressBar.textContent="0%",this.progressBar.style.flex="1 1 0",this.progressBar.style.minWidth="0",this.progressBar.style.maxWidth="100%",h.appendChild(this.progressBar),this.progressBar.indeterminate=!0,this.downloadButton=document.createElement("sl-button"),this.downloadButton.variant="primary",this.downloadButton.outline=!0,this.downloadButton.style.marginLeft="10px";const d=document.createElement("sl-icon");d.slot="prefix",d.name="download",d.library="lucide",this.downloadButton.appendChild(d),this.downloadButton.appendChild(document.createTextNode("Download")),h.appendChild(this.downloadButton),this.downloadButton.loading=!0,this.closeButton=document.createElement("sl-button"),this.closeButton.variant="danger",this.closeButton.outline=!0,this.closeButton.style.marginLeft="10px";const u=document.createElement("sl-icon");u.slot="prefix",u.name="x",u.library="lucide",this.closeButton.appendChild(u),this.closeButton.appendChild(document.createTextNode("Close")),h.appendChild(this.closeButton),this.closeButton.disabled=!0,this.dialog.appendChild(t),l.getApp().appendChild(this.dialog)}show(){this.dialog.show()}hide(){this.dialog.hide(),this.console.innerHTML="",this.downloadButton.loading=!0,this.downloadButton.onclick=()=>{},this.closeButton.disabled=!0,this.closeButton.onclick=()=>{},this.progressBar.value=0,this.progressBar.textContent="0%",this.progressBar.indeterminate=!0}setProgress(t){this.progressBar.value=t,this.progressBar.textContent=t+"%",this.progressBar.indeterminate=!1}setProgressIndeterminate(){this.progressBar.indeterminate=!0}setPreview(t,e,i){const n=new ImageData(t,e,i);this.preview.width=e,this.preview.height=i;const s=this.preview.getContext("2d");s?s.putImageData(n,0,0):this.logError("Cannot show preview: no canvas context found"),requestAnimationFrame(this.renderPreview.bind(this))}renderPreview(){const t=this.preview.width/this.preview.height,e=this.previewContainer.clientWidth/this.tabGroup.clientHeight;t<e?(this.preview.style.width="auto",this.preview.style.height=this.tabGroup.clientHeight+"px"):(this.preview.style.width=this.previewContainer.clientWidth+"px",this.preview.style.height="auto")}allowDownload(t=()=>{}){this.downloadButton.onclick=t,this.downloadButton.loading=!1}allowClose(t=()=>{}){this.closeButton.onclick=t,this.closeButton.disabled=!1}log(t){this.addLog(t,"neutral-900")}logInfo(t){this.addLog(t,"primary-600")}logSuccess(t){this.addLog(t,"success-600")}logWarning(t){this.addLog(t,"warning-600")}logError(t){this.addLog(t,"danger-600")}addLog(t,e){const i=document.createElement("div"),n=document.createElement("span"),s=new Date().toLocaleTimeString();n.appendChild(document.createTextNode("["+s+"] ")),n.style.color="var(--sl-color-neutral-500)",n.style.fontWeight="var(--sl-font-weight-light)",i.appendChild(n),i.appendChild(document.createTextNode(t)),i.style.color="var(--sl-color-"+e+")",i.style.marginBottom="5px",i.style.whiteSpace="pre-wrap";const r=this.consolePanel.scrollTop+this.consolePanel.clientHeight>=this.consolePanel.scrollHeight-20;this.console.appendChild(i),r&&this.scrollToBottom()}scrollToBottom(){setTimeout(()=>{this.consolePanel.scrollTop=this.consolePanel.scrollHeight},0)}}function ze(o,t){const{newPoints:e,uKnots:i,vKnots:n}=Kn(o,t),s=[];for(let r=t;r<i.length-t-1;r++)if(i[r]!==i[r+1])for(let a=t;a<n.length-t-1;a++){if(n[a]===n[a+1])continue;const h=[];for(let d=0;d<=t;d++){const u=[];for(let m=0;m<=t;m++)u.push(e[r-t+d][a-t+m]);h.push(u)}s.push(h)}return s}function Kn(o,t){let e=F(t,o.length-1),i=F(t,o[0].length-1),n=[],s=[],r=[];for(const h of o){const{newPoints:d,newKnots:u}=ke(h,t,i);n.push(d),r=u}const a=n[0].map((h,d)=>n.map(u=>u[d]));n=[];for(const h of a){const{newPoints:d,newKnots:u}=ke(h,t,e);n.push(d),s=u}return n=n[0].map((h,d)=>n.map(u=>u[d])),{newPoints:n,uKnots:s,vKnots:r}}function ke(o,t,e){let i=o.slice(),n=e.slice();for(let s=t;s<=e.length-t-1;s++){const r=e[s];for(let a=0;a<t-1;a++)({newPoints:i,newKnots:n}=$n(i,t,n,r))}return{newPoints:i,newKnots:n}}function $n(o,t,e,i){const n=e[t],s=e[e.length-t-1];if(i<n||i>s)return console.error("knotInsertion1D: t is out of bounds",i,"not in range [",n,",",s,"]"),{newPoints:[],newKnots:[]};let r=0,a=!1,h=[];for(let u=0;u<e.length;u++)h.push(e[u]),e[u]<=i&&i<e[u+1]&&!a&&(r=u,h.push(i),a=!0);let d=[];for(let u=0;u<=r-t;u++)d.push(o[u]);for(let u=r-t+1;u<=r;u++){const m=(i-e[u])/(e[u+t]-e[u]);if(m===0)d.push(o[u-1]);else if(m===1)d.push(o[u]);else{const p=o[u-1].clone().lerp(o[u],m);d.push(p)}}for(let u=r;u<o.length;u++)d.push(o[u]);return{newPoints:d,newKnots:h}}const ci=new c.Color(12597547),ve=new c.Color(2899536);function _n(o=!1){const t=[],e=l.getObjectManager().getObjects();for(const i of e)if(i instanceof gt){const n=i.toJSON(),s=n.controlPointsWidth,r=n.controlPointsHeight,a=[];for(let d=0;d<r;d++){a[d]=[];for(let u=0;u<s;u++){const m=n.controlPoints[d*s+u];a[d][u]=new c.Vector4(m.x,m.y,m.z,1)}}const h=new pe(a,i.getPosition(),new c.Color(n.color),i.getReflectivity());t.push(h),o&&t.push(...fe(a,i.getPosition()))}else if(i instanceof Ot){const n=i.toJSON(),s=n.controlPointsWidth+(n.closedU?n.degree:0),r=n.controlPointsHeight+(n.closedV?n.degree:0),a=[];for(let d=0;d<r;d++){a[d]=[];for(let u=0;u<s;u++){const m=d%n.controlPointsHeight,p=u%n.controlPointsWidth,g=n.controlPoints[m*n.controlPointsWidth+p];a[d][u]=new c.Vector4(g.x,g.y,g.z,1)}}const h=ze(a,n.degree);for(const d of h){const u=new pe(d,i.getPosition(),new c.Color(n.color),n.reflectivity);t.push(u)}o&&t.push(...fe(a,i.getPosition()))}else if(i instanceof Ht){const n=i.toJSON(),s=n.controlPointsWidth+(n.closedU?n.degree:0),r=n.controlPointsHeight+(n.closedV?n.degree:0),a=[];for(let d=0;d<r;d++){a[d]=[];for(let u=0;u<s;u++){const m=d%n.controlPointsHeight,p=u%n.controlPointsWidth,g=n.controlPoints[m*n.controlPointsWidth+p];a[d][u]=new c.Vector4(g.x*g.w,g.y*g.w,g.z*g.w,g.w)}}const h=ze(a,n.degree);for(const d of h){const u=new pe(d,i.getPosition(),new c.Color(n.color),n.reflectivity);t.push(u)}o&&t.push(...fe(a,i.getPosition()))}else if(i instanceof pt){const n=i.getControlPoints(),s=new ie(n),r=i.toJSON(),a=s.getPoints(100),h=i.getPosition(),d=new c.Color(r.color),u=Kt(n,a,h,d,o);t.push(...u)}else if(i instanceof St){const n=i.getControlPoints(),s=new se(n),r=i.toJSON(),a=s.getPoints(100),h=i.getPosition(),d=new c.Color(r.color),u=Kt(n,a,h,d,o);t.push(...u)}else if(i instanceof xt){const n=i.getControlPoints(),s=i.toJSON(),a=new ne(n,s.degree,s.closed).getPoints(100),h=i.getPosition(),d=new c.Color(s.color),u=Kt(n,a,h,d,o);t.push(...u)}else if(i instanceof Et){const n=i.getControlPoints(),s=i.toJSON(),a=new oe(n,s.degree,s.closed).getPoints(100),h=i.getPosition(),d=new c.Color(s.color),u=n.map(p=>new c.Vector3(p.x,p.y,p.z)),m=Kt(u,a,h,d,o);t.push(...m)}return t}function Kt(o,t,e,i,n,s=1){const r=[];let h=1;const d=Math.floor(t.length/s);let u=i.clone();for(let p=0;p<t.length-1;p++){s>1&&d>0&&p%d===0&&h<=s&&(h++,u=new c.Color(Lt(h)));let g=t[p].clone(),f=t[p+1].clone();const w=new c.Vector3().subVectors(f,g).normalize(),P=.05*.8;g.addScaledVector(w,-.04000000000000001),f.addScaledVector(w,P),r.push(new Yt(e,g,f,.05,u,0))}if(r.push(new _t(t[0],i,.05,0)),r.push(new _t(t[t.length-1],i,.05,0)),!n)return r;var m=null;for(const p of o)r.push(new _t(p.clone().add(e),ci,.05*5,0,!1,2)),m&&r.push(new Yt(e,m,p,.05*.5,ve,0,!1,1)),m=p.clone();return r}function fe(o,t){const e=[],i=o.length,n=o[0].length;for(let s=0;s<i;s++)for(let r=0;r<n;r++){const a=o[s][r].w,h=new c.Vector3(o[s][r].x/a,o[s][r].y/a,o[s][r].z/a),d=.05;if(e.push(new _t(h.clone().add(t),ci,d*5,0,!1,2)),s<i-1){const u=o[s+1][r].w,m=new c.Vector3(o[s+1][r].x/u,o[s+1][r].y/u,o[s+1][r].z/u);e.push(new Yt(t,h,m,d*.5,ve,0,!1,1))}if(r<n-1){const u=o[s][r+1].w,m=new c.Vector3(o[s][r+1].x/u,o[s][r+1].y/u,o[s][r+1].z/u);e.push(new Yt(t,h,m,d*.5,ve,0,!1,1))}}return e}var Pe=(o=>(o.INFO="INFO",o.SUCCESS="SUCCESS",o))(Pe||{});const we=128;var rt=[],$t=0,hi=[],Mt=new Uint8ClampedArray(0);function Xn(o,t,e,i){const n=[],{width:s,height:r}=o;for(let a=0;a<r;a+=t)for(let h=0;h<s;h+=t){const d=Math.min(t,s-h),u=Math.min(t,r-a);n.push({started:!1,batch:{workerId:-1,task:o,xStart:h,yStart:a,width:d,height:u,supersamplingFactor:e,suppixelOffsets:i}})}return n}function Yn(o){const t=[],e=1/o;for(let i=0;i<o;i++)for(let n=0;n<o;n++)t.push({dx:(i+.5)*e-.5,dy:(n+.5)*e-.5});return t}function qn(o,t,e,i,n,s,r,a){for(let d=0;d<s;d++)for(let u=0;u<n;u++){const m=(d*n+u)*4,p=e+u,g=i+d;if(p>=r||g>=a)continue;const f=(g*r+p)*4;for(let w=0;w<4;w++)o[f+w]=t[m+w]}}self.onmessage=async o=>{const t=o.data;Mt=new Uint8ClampedArray(t.width*t.height*4);const e=Yn(t.supersamplingFactor),i={type:"INFO",messages:["Dimensions: "+t.width+"x"+t.height,"Found "+t.objects.length+" objects","Bounces: "+t.bounces,"Supersampling: "+t.supersamplingFactor*t.supersamplingFactor+"x","Starting to raytrace..."],progress:0,data:Mt,width:t.width,height:t.height,startTime:t.startTime};self.postMessage(i);var n=[];rt=Xn(t,we,t.supersamplingFactor,e),n.push("Created "+rt.length+" batches with size "+we+"x"+we+"!");const s=Math.min(Math.max(4,navigator.hardwareConcurrency-6),rt.length);n.push("Using "+s+" workers!");try{for(let a=0;a<s;a++){n.push("Creating Worker-"+a+" ...");const h=new Worker(t.workerURL,{type:"module"});hi.push(h),h.onmessage=Zn,n.push("Starting Worker-"+a+" ...");const d=rt[a];d.started=!0,d.batch.workerId=a,h.postMessage(d.batch)}}catch(a){n.push("Error creating workers: "+a)}const r={type:"INFO",messages:n,progress:0,data:Mt,width:t.width,height:t.height,startTime:t.startTime};self.postMessage(r)};function Zn(o){const t=o.data;qn(Mt,t.data,t.xStart,t.yStart,t.width,t.height,t.task.width,t.task.height),$t++;const e=Math.round($t/rt.length*100),i={type:"INFO",messages:["Batch "+$t+" of "+rt.length+" finished!"],progress:e,data:Mt,width:t.task.width,height:t.task.height,startTime:t.startTime};if(self.postMessage(i),$t<rt.length){const s=rt.filter(a=>!a.started)[0],r=hi[t.workerId];s&&(s.started=!0,s.batch.workerId=t.workerId,r.postMessage(s.batch));return}const n={type:"SUCCESS",messages:["All batches finished!","Raytracing finished!"],progress:100,data:Mt,width:t.task.width,height:t.task.height,startTime:t.startTime,objects:t.task.objects};self.postMessage(n)}const Qn="/assets/raytracerBatchWorker-DiDerXMv.js";function to(o,t,e,i){const n=t.clone().sub(o.position),s=new c.Ray(n,e.clone().normalize()),r=no(s),a=ao(o),h=di(a,r,7);if(h.length===0)return We();h[0];let d=[];for(const b of h){const x=lo(b).distanceToSquared(n);d.push({patch:b,distance:x})}d.sort((b,E)=>b.distance-E.distance);var u={u:0,v:0},m=!1,p=0;const g=10;for(const b of d){const E=b.patch,x=new c.Vector2((E.u.x+E.u.y)/2,(E.v.x+E.v.y)/2),C=uo(n,e,o.controlPoints,{u:x.x,v:x.y},g,Tt.EPSILON);if(C.converged){b.patch,u=C,m=!0,p=C.steps;break}}if(!m)return We();const f=ui(o.controlPoints,u.u,u.v),w=ho(f.du,f.dv),P=f.point.distanceTo(n);return io(P,u.u,u.v,w,p/g,i)}function eo(o,t,e,i,n,s,r){if(!t.hit)return{color:new c.Color(0,0,0),normal:new c.Vector3(0,0,0)};const a=e.clone().add(i.clone().normalize().multiplyScalar(t.distance)),h=t.normal.clone().normalize(),d=s.direction.clone().normalize(),u=e.clone().sub(a).normalize(),m=d.clone().add(u).normalize(),p=r?0:Math.max(0,h.dot(d))*s.intensity,f=r?0:Math.pow(Math.max(0,h.dot(m)),32)*s.intensity,w=s.color.clone().multiplyScalar(p),P=s.color.clone().multiplyScalar(f),E=n.color.clone().multiplyScalar(n.intensity).add(w).add(P),C=new c.Color(o.color.r,o.color.g,o.color.b).multiply(E);return t.visColor&&C.copy(t.visColor),{color:C,normal:h}}function We(o){return{hit:!1,distance:1e6,u:0,v:0,normal:new c.Vector3}}function io(o,t,e,i,n,s){const r={hit:!0,distance:o,u:t,v:e,normal:i};if(s==W.UVS)r.visColor=new c.Color(t,e,0);else if(s==W.NORMALS)r.visColor=new c.Color(i.x*.5+.5,i.y*.5+.5,i.z*.5+.5);else if(s==W.NR_STEPS){const a=new c.Color(n,0,0);r.visColor=a}return r}function no(o){const t=o.origin,e=o.direction.clone().normalize(),i=new c.Vector3;Math.abs(e.y)<.99?i.set(0,1,0):i.set(1,0,0);const n=new c.Vector3().crossVectors(e,i).normalize(),s=new c.Vector3().crossVectors(e,n).normalize(),r=new c.Matrix3;return r.set(n.x,s.x,e.x,n.y,s.y,e.y,n.z,s.z,e.z),r.transpose(),{origin:t,direction:e,projectionMatrix:r}}function oo(o,t){const i=re(o.position).clone().sub(t.origin);return i.applyMatrix3(t.projectionMatrix),new c.Vector2(i.x,i.y)}function so(o){const t=new c.Vector2(1/0,1/0),e=new c.Vector2(-1/0,-1/0);for(const i of o)t.min(i),e.max(i);return t.x<=0&&e.x>=0&&t.y<=0&&e.y>=0}function Fe(o,t=.5){const e=[o.map(s=>({position:s.position.clone(),uv:s.uv.clone()}))];for(let s=1;s<o.length;s++){const r=e[s-1],a=[];for(let h=0;h<r.length-1;h++){const d=r[h],u=r[h+1],m=d.position.clone().lerp(u.position,t),p=d.uv.clone().lerp(u.uv,t);a.push({position:m,uv:p})}e.push(a)}const i=e.map(s=>s[0]),n=e.map(s=>s[s.length-1]).reverse();return{left:i,right:n}}function ro(o,t=.5){const{controlPoints:e,u:i,v:n}=o,s=e.length,r=e[0].length,a=[],h=[];for(let H=0;H<r;H++){const U=e.map(ot=>ot[H]),{left:T,right:N}=Fe(U,t);a.push(T),h.push(N)}const d=Ae(a),u=Ae(h),m=H=>{const U=[],T=[];for(let N=0;N<s;N++){const ot=H[N],{left:K,right:$}=Fe(ot,t);U.push(K),T.push($)}return[U,T]},[p,g]=m(d),[f,w]=m(u),P=i.x+(i.y-i.x)*t,b=n.x+(n.y-n.x)*t,E={controlPoints:p,u:new c.Vector2(i.x,P),v:new c.Vector2(n.x,b),level:o.level+1},x={controlPoints:f,u:new c.Vector2(P,i.y),v:new c.Vector2(n.x,b),level:o.level+1},C={controlPoints:g,u:new c.Vector2(i.x,P),v:new c.Vector2(b,n.y),level:o.level+1},S={controlPoints:w,u:new c.Vector2(P,i.y),v:new c.Vector2(b,n.y),level:o.level+1};return[E,x,C,S]}function Ae(o){return o[0].map((t,e)=>o.map(i=>i[e]))}function ao(o){if(o.data.patch)return o.data.patch;const t=[];for(let i=0;i<o.controlPoints.length;i++){const n=[];for(let s=0;s<o.controlPoints[i].length;s++){const r=o.controlPoints[i][s],a=new c.Vector4(r.x,r.y,r.z,r.w);n.push({position:a,uv:new c.Vector2(i/(o.controlPoints.length-1),s/(o.controlPoints[i].length-1))})}t.push(n)}const e={controlPoints:t,u:new c.Vector2(0,1),v:new c.Vector2(0,1),level:0};return o.data.patch=e,e}function di(o,t,e){if(co(o,t))return[];const i=o.controlPoints.map(a=>a.map(h=>oo(h,t)));if(!so(i.flat()))return[];if(e<=0)return[o];const s=o.subdivisions?o.subdivisions:ro(o,.5);o.level<5&&(o.subdivisions=s);const r=[];for(const a of s){const h=di(a,t,e-1);r.push(...h)}return r}function lo(o){const t=o.controlPoints.length-1,e=o.controlPoints[0].length-1,i=new c.Vector3(0,0,0);var n=0;for(let s=0;s<=t;s++){const r=G(t,s,.5);for(let a=0;a<=e;a++){const h=re(o.controlPoints[s][a].position),d=o.controlPoints[s][a].position.w,u=G(e,a,.5),m=d*r*u;i.add(h.multiplyScalar(m)),n+=m}}return i.divideScalar(n)}function co(o,t){for(const e of o.controlPoints.flat())if(re(e.position).sub(t.origin).dot(t.direction)>0)return!1;return!0}function ui(o,t,e){const i=o.length-1,n=o[0].length-1,s=new c.Vector3(0,0,0);var r=0;const a=new c.Vector3(0,0,0);var h=0;const d=new c.Vector3(0,0,0);var u=0;for(let f=0;f<=i;f++){const w=G(i,f,t),P=Ne(i,f,t);for(let b=0;b<=n;b++){const E=re(o[f][b]),x=o[f][b].w,C=G(n,b,e),S=Ne(n,b,e),H=x*w*C,U=x*P*C,T=x*w*S;s.add(E.clone().multiplyScalar(H)),r+=H,a.add(E.clone().multiplyScalar(U)),h+=U,d.add(E.clone().multiplyScalar(T)),u+=T}}const m=s.clone().divideScalar(r),p=a.clone().divideScalar(r).sub(s.clone().multiplyScalar(h/(r*r))),g=d.clone().divideScalar(r).sub(s.clone().multiplyScalar(u/(r*r)));return{point:m,du:p,dv:g}}function ho(o,t){const e=new c.Vector3;return e.crossVectors(o,t),e.normalize(),e}function uo(o,t,e,i,n=10,s=Tt.EPSILON){let r=i.u,a=i.v;const h=t.clone().normalize(),d=new c.Vector3,u=new c.Vector3;for(let m=0;m<n;m++){const{point:p,du:g,dv:f}=ui(e,r,a);d.copy(p).sub(o);const w=d.dot(h);u.copy(h).multiplyScalar(w).add(o);const P=p.clone().sub(u),b=[P.dot(g),P.dot(f)],E=g.dot(h),x=f.dot(h),C=[[g.dot(g)-E*E,g.dot(f)-E*x],[f.dot(g)-x*E,f.dot(f)-x*x]],S=C[0][0]*C[1][1]-C[0][1]*C[1][0];if(!isFinite(S)||Math.abs(S)<s*s)break;const H=[[C[1][1]/S,-C[0][1]/S],[-C[1][0]/S,C[0][0]/S]],U=-(H[0][0]*b[0]+H[0][1]*b[1]),T=-(H[1][0]*b[0]+H[1][1]*b[1]);if(r+=U,a+=T,r=Math.max(0,Math.min(1,r)),a=Math.max(0,Math.min(1,a)),Math.sqrt(U*U+T*T)<s&&P.lengthSq()<s*s)return{converged:!0,u:r,v:a,steps:m+1}}return{converged:!1,u:r,v:a,steps:n}}function mo(o,t,e){const i=t.clone().sub(o.position),n=e.dot(e),s=2*i.dot(e),r=i.dot(i)-o.radius*o.radius,a=s*s-4*n*r;if(a<0)return{hit:!1,distance:1e6,u:0,v:0,normal:new c.Vector3};const h=Math.sqrt(a),d=(-s-h)/(2*n),u=(-s+h)/(2*n),m=Math.min(d,u);if(m<0)return{hit:!1,distance:1e6,u:0,v:0,normal:new c.Vector3};const g=t.clone().add(e.clone().multiplyScalar(m)).clone().sub(o.position).normalize(),f=.5+Math.atan2(g.z,g.x)/(2*Math.PI),w=.5-Math.asin(g.y)/Math.PI;return{hit:!0,distance:m,u:f,v:w,normal:g}}function go(o,t,e,i,n,s,r){return{color:o.color,normal:t.normal.clone()}}function po(o,t,e){const i=new c.Vector3().copy(o.pointA),n=new c.Vector3().copy(o.pointB),s=new c.Vector3().subVectors(n,i),r=s.length(),a=s.clone().normalize(),d=t.clone().sub(o.position),u=e.clone().normalize(),m=u.clone().sub(a.clone().multiplyScalar(u.dot(a))),p=d.clone().sub(i),g=p.clone().sub(a.clone().multiplyScalar(p.dot(a))),f=m.dot(m),w=2*m.dot(g),P=g.dot(g)-o.radius*o.radius,b=w*w-4*f*P;if(b<0||Math.abs(f)<1e-6)return{hit:!1,distance:1e6,u:0,v:0,normal:new c.Vector3};const E=Math.sqrt(b),x=(-w-E)/(2*f),C=(-w+E)/(2*f);let S=1/0,H=new c.Vector3,U=0,T=0;for(const N of[x,C]){if(N<0)continue;const ot=d.clone().add(u.clone().multiplyScalar(N)),K=ot.clone().sub(i).dot(a);if(!(K<0||K>r)&&N<S){S=N;const $=ot.clone().sub(i),kt=a.clone().multiplyScalar($.dot(a));H=$.clone().sub(kt).normalize();const Z=new c.Vector3(1,0,0);Math.abs(a.dot(Z))>.99&&Z.set(0,1,0);const ft=Z.clone().cross(a).normalize(),ae=a.clone().cross(ft).normalize(),wt=$.clone().sub(kt).normalize();U=(Math.atan2(wt.dot(ae),wt.dot(ft))/(2*Math.PI)+1)%1,T=K/r}}return S===1/0?{hit:!1,distance:1e6,u:0,v:0,normal:new c.Vector3}:{hit:!0,distance:S,u:U,v:T,normal:H}}function fo(o,t,e,i,n,s,r){return{color:o.color,normal:t.normal.clone()}}class Tt{static dialog=null;static EPSILON=1e-4;static prepareTask(t,e,i,n,s,r=!1,a=W.NONE,h=null){const d=l.getPerspectiveCamera(),u=l.getOrthographicCamera();console.log(u);const p=l.getDirectionalLight().position.clone().normalize(),g=_n(r);var f=[];return h!==null&&h.frames>0&&h.degreesPerFrame>0&&(f=this.generateOrbitingCameraFrames(d,l.getOrbitControls().target,h.degreesPerFrame,h.frames,h.direction)),{startTime:0,width:t,height:e,bounces:i,skybox:n,supersamplingFactor:s,quality:li.HIGH,objects:g,ambientLight:{color:l.getAmbientLight().color.clone(),intensity:l.getAmbientLight().intensity},directionalLight:{direction:p,color:l.getDirectionalLight().color.clone(),intensity:l.getDirectionalLight().intensity},dimension2D:l.dimension2D(),perspectiveCamera:{position:d.position.clone(),rotation:d.rotation.clone(),fov:d.fov,up:d.up.clone()},orthographicCamera:{position:u.position.clone(),rotation:u.rotation.clone(),left:u.left,right:u.right,top:u.top,bottom:u.bottom,near:u.near,far:u.far,up:u.up.clone(),zoom:u.zoom},workerURL:Qn,visualisation:a,videoData:f.length>0?{frames:f}:void 0}}static execute(t){this.dialog||(this.dialog=new Jn),this.dialog.show(),this.dialog.setProgress(0),this.dialog.log("Starting Raytracer..."),this.dialog.log("Creating Worker...");const e=new Worker(new URL("/assets/raytracerWorker-DYFjYFII.js",import.meta.url),{type:"module"});e.onmessage=this.onMessage.bind(this),this.dialog.log("Starting Worker..."),t.startTime=Date.now(),e.postMessage(t)}static onMessage(t){if(!this.dialog)return;const e=t.data.type;if(e===Pe.INFO)t.data.messages.forEach(i=>{this.dialog&&this.dialog.logInfo("Worker: "+i)}),this.dialog.setPreview(t.data.data,t.data.width,t.data.height),this.dialog.setProgress(t.data.progress);else if(e===Pe.SUCCESS){this.dialog.setProgress(100),this.dialog.logInfo("Worker: "+t.data.messages[0]),this.dialog.logSuccess("Worker finished!");const i=Date.now()-t.data.startTime,n=Math.floor(i/6e4),s=(i%6e4/1e3).toFixed(2);n>0?this.dialog.logSuccess(`Raytracing took ${n.toString()} minutes and ${s} seconds`):this.dialog.logSuccess(`Raytracing took ${s} seconds`),this.dialog.setPreview(t.data.data,t.data.width,t.data.height),this.dialog.allowDownload(()=>{this.dialog&&(this.dialog.logSuccess("Download started..."),this.downloadImage(t.data.data,t.data.width,t.data.height))}),this.dialog.allowClose(()=>{this.dialog&&this.dialog.hide()})}}static raytrace(t,e,i,n,s,r,a,h){if(i<0)return this.raytraceSkybox(e,new c.Color(.5,.7,1),n);var d=void 0,u=void 0,m=Number.MAX_VALUE,p=0;for(const g of s){if(p>g.layer)continue;const f=this.rayhitObject(g,t,e,h);if(p<g.layer&&f.hit){p=g.layer,m=f.distance,d=g,u=f;continue}f.hit&&f.distance<m&&(m=f.distance,d=g,u=f)}if(d&&u){const g=t.clone().add(e.clone().multiplyScalar(m)).add(u.normal.clone().multiplyScalar(.12)),f=this.shadowRay(g,s,d,a),w=this.raytraceObject(d,u,t,e,r,a,f);if(h==W.NONE&&d.reflectivity>0){const P=e.clone().reflect(u.normal).normalize(),b=s,E=this.raytrace(g,P,i-1,n,b,r,a,W.NONE);w.color.lerp(E.color,d.reflectivity)}return{color:w.color,hit:!0}}else return this.raytraceSkybox(e,new c.Color(.5,.7,1),n)}static raytraceObject(t,e,i,n,s,r,a){switch(t.type){case ut.BezierPatch:return eo(t,e,i,n,s,r,a);case ut.Sphere:return go(t,e);case ut.Cylinder:return fo(t,e)}return{color:new c.Color(0,0,0),normal:new c.Vector3(0,0,0)}}static rayhitObject(t,e,i,n,s=!1){switch(t.type){case ut.BezierPatch:return to(t,e,i,n);case ut.Sphere:return mo(t,e,i);case ut.Cylinder:return po(t,e,i)}return{hit:!1,distance:0,u:0,v:0,normal:new c.Vector3}}static shadowRay(t,e,i,n){const s=n.direction.clone().normalize(),r=t.clone();for(const a of e){if(!a.castShadow)continue;if(this.rayhitObject(a,r,s,W.NONE,!0).hit)return!0}return!1}static raytraceSkybox(t,e,i){if(i==st.BLACK)return{color:new c.Color(0,0,0),hit:!1};if(i==st.WHITE)return{color:new c.Color(1,1,1),hit:!1};const n=t.y,s=new c.Color(.5,.5,.5),r=new c.Color(.2,.2,.2),a=e.clone().multiplyScalar(.5),h=e.clone(),d=.5*(n+1);return n>0?{color:h.clone().lerp(a,d),hit:!1}:{color:r.clone().lerp(s,d),hit:!1}}static setPixel(t,e,i,n,s,r=1){const a=(n*e+i)*4;t[a]=Math.floor(Math.pow(s.r,1/2.2)*255),t[a+1]=Math.floor(Math.pow(s.g,1/2.2)*255),t[a+2]=Math.floor(Math.pow(s.b,1/2.2)*255),t[a+3]=Math.floor(r*255)}static downloadImage(t,e,i){const n=new ImageData(t,e,i),s=document.createElement("canvas");s.width=e,s.height=i;const r=s.getContext("2d");if(r){r.putImageData(n,0,0);const a=s.toDataURL("image/png"),h=document.createElement("a");h.href=a,h.download="raytrace.png",h.click()}else throw new Error("Failed to get canvas context")}static generateOrbitingCameraFrames(t,e=new c.Vector3(0,0,0),i=1,n=360,s="left"){const r=[],a=new c.Vector3().subVectors(t.position,e),h=a.length(),d=t.up.clone(),u=Math.atan2(a.z,a.x),m=Math.asin(a.y/h);for(let p=0;p<n;p++){const g=u+c.MathUtils.degToRad(i*p)*(s==="left"?1:-1),f=e.x+h*Math.cos(g)*Math.cos(m),w=e.z+h*Math.sin(g)*Math.cos(m),P=e.y+h*Math.sin(m),b=new c.Vector3(f,P,w),E=new c.Matrix4().lookAt(b,e,d),x=new c.Euler().setFromRotationMatrix(E);r.push({position:b.clone(),rotation:x.clone()})}return r}}class wo extends L{params;localRaytracerParams;visParams;raytraceButton;prepareButton;widthSlider;heightSlider;tab=null;constructor(){const t=new I;super("trending-up-down",!1,t,!0),this.params={resolution:z.CUSTOM,width:512,height:512,bounces:3,skybox:st.GRADIENT,supersampling:1},this.localRaytracerParams={frames:0,degreesPerFrame:1,direction:"left"},this.visParams={controlPoints:!1,type:W.NONE},this.raytraceButton=new Re("Raytrace",this.startRaytracer.bind(this),{variant:"primary",prefixIcon:"play",iconLibrary:"lucide"}),this.prepareButton=new Re("Download Task",this.downloadTask.bind(this),{variant:"warning",prefixIcon:"download",iconLibrary:"lucide"}),this.widthSlider=new j("Width",this.params,"width",{min:128,max:4096,step:128}),this.heightSlider=new j("Height",this.params,"height",{min:128,max:4096,step:128})}build(t){this.tab=t,t.add(new D("Raytracer",{bold:!0})),t.add(new Gt("Resolution",this.params,"resolution",{[z.CUSTOM]:"Custom",[z.LOW]:"Low (640x360)",[z.HD]:"HD (1280x720)",[z.FULL_HD]:"Full HD (1920x1080)",[z.QHD]:"QHD (2560x1440)",[z.UHD]:"UHD (3840x2160)"}).onChange(this.resolutionChanged.bind(this))),t.add(this.widthSlider),t.add(this.heightSlider),t.add(new j("Bounces",this.params,"bounces",{min:0,max:10,step:1})),t.add(new Gt("Supersampling",this.params,"supersampling",{1:"Off",2:"4x",3:"9x"})),t.add(new Gt("Skybox",this.params,"skybox",{[st.GRADIENT]:"Gradient",[st.WHITE]:"White",[st.BLACK]:"Black",[st.TRANSPARENT]:"Transparent"})),t.add(this.raytraceButton);const e=t.addFolder("Visualisations",{open:!1});e.add(new Zt("Control Polygon / Grid",this.visParams,"controlPoints",{help:"Raytrace the control polygon ot control grid?"})),e.add(new D("Choose from a variety of visualizations that should be raytraced.",{newLine:!1,block:!0})),e.add(new Gt("Type",this.visParams,"type",{[W.NONE]:"None",[W.UVS]:"UVs",[W.NORMALS]:"Normals",[W.NR_STEPS]:"Newton-Raphson Steps"}));const i=t.addFolder("Local Raytracer",{open:!1});i.add(new D("Download the Task to raytrace with the local CLI raytracer. This also allows for Videos. Available soon!",{newLine:!1,block:!0})),i.add(new j("Frames",this.localRaytracerParams,"frames",{min:0,max:360,step:1,help:"0 = single image"})),i.add(new j("Degrees per Frame",this.localRaytracerParams,"degreesPerFrame",{min:.5,max:10,step:.5})),i.add(new Ut("Rotation Direction",this.localRaytracerParams,"direction",{left:"Left",right:"Right"})),i.add(this.prepareButton)}startRaytracer(){try{const t=Tt.prepareTask(this.params.width,this.params.height,this.params.bounces,this.params.skybox,this.params.supersampling,this.visParams.controlPoints,this.visParams.type);Tt.execute(t)}catch(t){console.error("Raytracer error:",t)}}downloadTask(){const t=this.localRaytracerParams.frames>0?{frames:this.localRaytracerParams.frames,degreesPerFrame:this.localRaytracerParams.degreesPerFrame,direction:this.localRaytracerParams.direction}:null,e=Tt.prepareTask(this.params.width,this.params.height,this.params.bounces,this.params.skybox,this.params.supersampling,!1,W.NONE,t),i=new Blob([JSON.stringify(e)],{type:"application/json"}),n=URL.createObjectURL(i),s=document.createElement("a");s.href=n,s.download="raytracer_task.svisrtt",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}resolutionChanged(){if(this.tab!==null){if(this.params.resolution==z.CUSTOM){this.widthSlider.update(),this.heightSlider.update(),this.tab.show(this.widthSlider),this.tab.show(this.heightSlider);return}this.params.resolution==z.LOW?(this.params.width=640,this.params.height=360):this.params.resolution==z.HD?(this.params.width=1280,this.params.height=720):this.params.resolution==z.FULL_HD?(this.params.width=1920,this.params.height=1080):this.params.resolution==z.QHD?(this.params.width=2560,this.params.height=1440):this.params.resolution==z.UHD&&(this.params.width=3840,this.params.height=2160),this.tab.hide(this.widthSlider),this.tab.hide(this.heightSlider)}}select(t){}deselect(){}objectChanged(t){}inspectorChanged(t){}}class bo extends nt{constructor(t){const e=[new vo,new Po,new wo];super("Scene",t,e)}}class vo extends L{dirParams;ambParams;constructor(){const t=new I;super("sun",!1,t,!0),this.dirParams={dirLightRotation:0,dirLightIntensity:1,dirLightColor:"#ffffff"},this.ambParams={ambLightIntensity:.2,ambLightColor:"#f0f0f0"}}build(t){t.add(new D("Directional Light",{bold:!0})),t.add(new j("Rotation",this.dirParams,"dirLightRotation",{min:0,max:360,step:1}).onChange(this.updateDirectionalLight.bind(this))),t.add(new j("Intensity",this.dirParams,"dirLightIntensity",{min:.5,max:3,step:.1}).onChange(this.updateDirectionalLight.bind(this))),t.add(new J("Color",this.dirParams,"dirLightColor").onChange(this.updateDirectionalLight.bind(this))),t.add(new Qt),t.add(new D("Ambient Light",{bold:!0})),t.add(new j("Intensity",this.ambParams,"ambLightIntensity",{min:0,max:1,step:.1}).onChange(this.updateAmbientLight.bind(this))),t.add(new J("Color",this.ambParams,"ambLightColor").onChange(this.updateAmbientLight.bind(this)))}updateDirectionalLight(){const e=Math.PI/180*this.dirParams.dirLightRotation,i=15*Math.cos(e),n=15*Math.sin(e);l.getDirectionalLight().position.set(i,20,n),l.getDirectionalLight().intensity=this.dirParams.dirLightIntensity,l.getDirectionalLight().color.set(this.dirParams.dirLightColor)}updateAmbientLight(){l.getAmbientLight().intensity=this.ambParams.ambLightIntensity,l.getAmbientLight().color.set(this.ambParams.ambLightColor)}select(t){this.objectChanged(t)}deselect(){}objectChanged(t){this.dirParams.dirLightRotation=t.dirRotation,this.dirParams.dirLightIntensity=t.dirIntensity,this.dirParams.dirLightColor=t.dirColor,this.ambParams.ambLightIntensity=t.ambIntensity,this.ambParams.ambLightColor=t.ambColor,this.updateDirectionalLight(),this.updateAmbientLight()}inspectorChanged(t){t.dirRotation=this.dirParams.dirLightRotation,t.dirIntensity=this.dirParams.dirLightIntensity,t.dirColor=this.dirParams.dirLightColor,t.ambIntensity=this.ambParams.ambLightIntensity,t.ambColor=this.ambParams.ambLightColor}}class Po extends L{params;exrLoader;constructor(){const t=new I;super("tent-tree",!1,t,!0),this.params={exrName:"outdoor",exrIntensity:1,showBackground:!1},this.exrLoader=new Ei,M.subscribe("dimensionSwitched",y.ALL,()=>{this.updateBackground()})}build(t){t.add(new D("Scene Enviroment",{bold:!0})),t.add(new Ut("Map",this.params,"exrName",{outdoor:"Outdoor",indoor:"Indoor",space:"Space",northernLights:"Northern Lights"}).onChange(this.updateEnviroment.bind(this))),t.add(new j("Intensity",this.params,"exrIntensity",{min:0,max:5,step:.1}).onChange(this.updateEnviromentIntensity.bind(this))),t.add(new Zt("Show Background",this.params,"showBackground",{help:"Background will only be shown in 3D Mode."}).onChange(this.updateBackground.bind(this)))}updateEnviroment(){this.exrLoader.load(`/exrs/${this.params.exrName}.exr`,t=>{t.mapping=Pi,t.minFilter=t.magFilter=Ci,t.flipY=!1,l.getScene().environment=t,l.getScene().environmentIntensity=this.params.exrIntensity,this.params.showBackground&&!l.dimension2D()?(l.getScene().background=t,l.getScene().backgroundIntensity=this.params.exrIntensity):(l.getScene().background=new V(be()),l.getScene().backgroundIntensity=1),t.dispose(),M.notify("enviromentChanged",y.ALL)})}updateEnviromentIntensity(){l.getScene().environmentIntensity=this.params.exrIntensity,this.params.showBackground&&(l.getScene().backgroundIntensity=this.params.exrIntensity),M.notify("enviromentIntensityChanged",y.ALL)}updateBackground(){this.params.showBackground&&!l.dimension2D()?(l.getScene().background=l.getScene().environment,l.getScene().backgroundIntensity=this.params.exrIntensity):(l.getScene().background=new V(be()),l.getScene().backgroundIntensity=1)}select(t){l.getScene().environment===null&&this.updateEnviroment(),this.objectChanged(t)}deselect(){}objectChanged(t){t.envMap!==this.params.exrName?(this.params.exrName=t.envMap,this.params.exrIntensity=t.envIntensity,this.updateEnviroment()):t.envIntensity!==this.params.exrIntensity&&(this.params.exrIntensity=t.envIntensity,this.updateEnviromentIntensity())}inspectorChanged(t){t.envMap=this.params.exrName,t.envIntensity=this.params.exrIntensity}}class Co{lace;currentInspector;objectInspectors;constructor(t){this.currentInspector=null,this.lace=new Ti(t),this.objectInspectors=new Map,this.objectInspectors.set("scene",new bo(this.lace)),this.objectInspectors.set("linearCurve",new Pn(this.lace)),this.objectInspectors.set("bezierCurve",new pn(this.lace)),this.objectInspectors.set("bezierSpline",new Ln(this.lace)),this.objectInspectors.set("uniformBSplineCurve",new xn(this.lace)),this.objectInspectors.set("urbsCurve",new Hn(this.lace)),this.objectInspectors.set("bezierPatch",new Dn(this.lace)),this.objectInspectors.set("uniformBSplineSurface",new zn(this.lace)),this.objectInspectors.set("uniformRationalBSplineSurface",new Fn(this.lace)),M.subscribe("start",y.ALL,()=>this.updateInspector(null)),M.subscribe("objectSelected",y.ALL,e=>this.updateInspector(e)),M.subscribe("objectUnselected",y.ALL,()=>this.updateInspector(null)),M.subscribe("objectRemoved",y.ALL,()=>this.updateInspector(null)),M.subscribe("objectChanged",y.VIEWPORT,()=>this.objectChanged()),M.subscribe("transformMoved",y.VIEWPORT,()=>this.objectChanged()),M.subscribe("sceneReset",y.ALL,()=>this.updateInspector(null))}updateInspector(t){if(!t){this.lace.hideAll(),this.currentInspector?.deselect();const i=this.objectInspectors.get("scene");if(i!==void 0){i.select(l.getSceneProxy()),this.currentInspector=i;return}this.currentInspector=null;return}var e=void 0;t instanceof Bt?e=this.objectInspectors.get("linearCurve"):t instanceof pt?e=this.objectInspectors.get("bezierCurve"):t instanceof St?e=this.objectInspectors.get("bezierSpline"):t instanceof xt?e=this.objectInspectors.get("uniformBSplineCurve"):t instanceof Et?e=this.objectInspectors.get("urbsCurve"):t instanceof gt?e=this.objectInspectors.get("bezierPatch"):t instanceof Ot?e=this.objectInspectors.get("uniformBSplineSurface"):t instanceof Ht&&(e=this.objectInspectors.get("uniformRationalBSplineSurface")),e?(e.select(t),this.currentInspector=e):(this.lace.hideAll(),this.currentInspector=null)}objectChanged(){this.currentInspector&&this.currentInspector.objectChanged()}}class yo{selectionChanged;constructor(t,e,i){this.selectionChanged=e;const n=document.createElement("div"),s=document.createElement("sl-button-group");s.style.width="100%";const r=document.createElement("sl-dropdown");r.style.width="100%",r.hoist=!0,r.placement="bottom",s.appendChild(r);const a=document.createElement("sl-button");a.size="small",a.variant="danger",a.addEventListener("mousedown",i);const h=document.createElement("sl-icon");h.style.fontSize="1.3em",h.name="x-lg",h.slot="prefix";const d=document.createElement("span");d.textContent="Remove",a.appendChild(h),a.appendChild(d),s.appendChild(a),n.appendChild(s);const u=document.createElement("sl-button");u.slot="trigger",u.caret=!0,u.size="small",u.style.width="100%",u.variant="neutral";const m=document.createElement("sl-icon");m.style.fontSize="1.3em",m.name="plus-lg",m.slot="prefix";const p=document.createElement("span");p.textContent="Add",u.appendChild(m),u.appendChild(p),r.appendChild(u);const g=document.createElement("sl-menu");r.appendChild(g);const f=document.createElement("sl-menu-label");f.textContent="Curves",g.appendChild(f),g.appendChild(this.addNewObject("Linear Curve","LinearCurveObject",this.addLinearCurve.bind(this))),g.appendChild(this.addNewObject("Bezier Curve","BezierCurveObject",this.addBezierCurve.bind(this))),g.appendChild(this.addNewObject("Bezier Spline","BezierSplineObject",this.addBezierSpline.bind(this))),g.appendChild(this.addNewObject("Uniform B-Spline","UniformBSplineObject",this.addUniformBSplineCurve.bind(this))),g.appendChild(this.addNewObject("Uniform Rational B-Spline","UniformRationBSplineObject",this.addURBSCurve.bind(this)));const w=document.createElement("sl-menu-label");w.textContent="Surfaces",g.appendChild(w),g.appendChild(this.addNewObject("Bezier Patch","BezierPatchObject",this.addBezierPatch.bind(this))),g.appendChild(this.addNewObject("Uniform B-Spline Surface","UniformBSplineSurfaceObject",this.addUniformBSplineSurface.bind(this))),g.appendChild(this.addNewObject("Uniform Rational B-Spline Surface","UniformRationalBSplineSurfaceObject",this.addUniformRationalBSplineSurface.bind(this))),t.appendChild(n)}addNewObject(t,e,i){const n=document.createElement("sl-menu-item");n.classList.add("menu-item"),n.onclick=i;const{name:s,lucide:r}=Qe(e),a=document.createElement("sl-icon");a.name=s,r&&(a.library="lucide"),a.slot="prefix";const h=document.createElement("span");return h.textContent=t,n.appendChild(a),n.appendChild(h),n}addLinearCurve(){const t=l.getCreationManager().createBasicLinearCurve();this.selectionChanged(t.getUUID())}addBezierCurve(){const t=l.getCreationManager().createBasicBezierCurve();this.selectionChanged(t.getUUID())}addBezierSpline(){const t=l.getCreationManager().createBasicBezierSpline();this.selectionChanged(t.getUUID())}addUniformBSplineCurve(){const t=l.getCreationManager().createBasicUniformBSpline();this.selectionChanged(t.getUUID())}addURBSCurve(){const t=l.getCreationManager().createBasicURBS();this.selectionChanged(t.getUUID())}addBezierPatch(){const t=l.getCreationManager().createBasicBezierPatch();this.selectionChanged(t.getUUID())}addUniformBSplineSurface(){const t=l.getCreationManager().createBasicUniformBSplineSurface();this.selectionChanged(t.getUUID())}addUniformRationalBSplineSurface(){const t=l.getCreationManager().createBasicUniformRationalBSplineSurface();this.selectionChanged(t.getUUID())}}class Mo{container;menu;tree;items;hoveredItem;selectedItem;constructor(t,e={}){const{darkMode:i=!1}=e;this.items=new Map,this.hoveredItem=null,this.selectedItem=null;const n=document.createElement("div");n.className="hierarchy",n.style.border="solid 1px var(--sl-color-neutral-300)",n.style.borderRadius="var(--sl-border-radius-small)",n.style.backgroundColor="var(--sl-color-neutral-0)",n.style.height="100%",n.style.overflow="auto",n.style.color="var(--sl-input-color) !important",i&&n.classList.add("sl-theme-dark"),this.menu=new yo(n,this.selectionChangedUUID.bind(this),this.removeSelected.bind(this)),this.tree=document.createElement("sl-tree"),this.tree.selection="leaf",n.appendChild(this.tree),t.appendChild(n),this.container=n,this.tree.addEventListener("sl-selection-change",s=>this.selectionChanged(s)),this.container.addEventListener("mouseup",()=>this.deselect()),M.subscribe("objectAdded",y.GENERAL,s=>this.addObject(s)),M.subscribe("objectRemoved",y.GENERAL,s=>this.removeObject(s)),M.subscribe("objectChanged",y.INSPECTOR,()=>this.updateHierarchy()),M.subscribe("objectNameChanged",y.ALL,()=>this.updateHierarchy()),M.subscribe("inspectorTabChanged",y.INSPECTOR,()=>this.updateHierarchy())}updateHierarchy(){this.items.clear(),this.tree.innerHTML="",l.getObjectManager().getObjects().forEach(t=>{this.addObject(t),t.getUUID()===this.hoveredItem&&this.viewportHover(t.getUUID()),t.getUUID()===this.selectedItem?.dataset.uuid&&this.viewportSelect(t.getUUID())})}addObject(t){const e=document.createElement("sl-tree-item");e.dataset.uuid=t.getUUID(),e.classList.add("hierarchy-item");const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const{name:n,lucide:s}=Qe(t.getType()),r=document.createElement("sl-icon");r.name=n,s&&(r.library="lucide"),i.appendChild(r);const a=document.createElement("span");a.textContent=t.getName(),i.appendChild(a),e.appendChild(i);const h=document.createElement("div");h.style.display="flex",h.style.flexDirection="row",h.style.marginRight="20px",e.appendChild(h);const d=document.createElement("div");d.style.marginRight="10px",d.style.display="none",t instanceof pt&&t.getMode()===2&&(d.style.display="");const u=document.createElement("sl-icon");u.name="spline",u.library="lucide",d.appendChild(u),h.appendChild(d);const m=document.createElement("div");m.style.color="#"+t.getColor().getHexString();const p=document.createElement("sl-icon");p.name="circle-fill",m.appendChild(p),h.appendChild(m),e.addEventListener("mouseenter",()=>this.hovered(t.getUUID())),e.addEventListener("mouseleave",()=>this.dehovered(t.getUUID())),e.addEventListener("sl-expand",()=>this.selectionChangedUUID(t.getUUID())),e.addEventListener("sl-collapse",()=>this.selectionChangedUUID(t.getUUID())),this.items.set(t.getUUID(),e),this.tree.appendChild(e)}removeObject(t){const e=this.items.get(t.getUUID());e&&(this.tree.removeChild(e),this.items.delete(t.getUUID()),this.selectedItem=null)}hovered(t){const e=l.getObjectManager().getObjectByUUID(t);e&&(this.hoveredItem=t,l.getSelectionManager().doHover(e))}viewportHover(t){const e=this.items.get(t);e&&(this.hoveredItem=t,e.classList.add("hover"))}dehovered(t){l.getObjectManager().getObjectByUUID(t)&&(this.hoveredItem=null,l.getSelectionManager().doResetHovered())}viewportDehover(){const t=this.hoveredItem;if(!t)return;const e=this.items.get(t);e&&(this.hoveredItem=null,e.classList.remove("hover"))}selectionChangedUUID(t){const e=this.items.get(t);e&&(this.viewportSelect(t),this.selectionChanged(new CustomEvent("sl-selection-change",{detail:{selection:[e]}})))}selectionChanged(t){const e=t.detail.selection[0];if(!e)return;this.selectedItem=e;const i=e.dataset.uuid;if(!i)return;const n=l.getObjectManager().getObjectByUUID(i);n&&l.getSelectionManager().doSelect(n)}removeSelected(){if(!this.selectedItem)return;const t=this.selectedItem.dataset.uuid;if(!t)return;const e=l.getObjectManager().getObjectByUUID(t);e&&(this.selectedItem=null,l.getTransformControls().detach(),this.removeObject(e),l.getObjectManager().removeObject(t))}viewportSelect(t){const e=this.items.get(t);e&&(this.selectedItem&&(this.selectedItem.selected=!1),this.selectedItem=e,e.selected=!0)}deselect(){if(!this.selectedItem)return;this.selectedItem.selected=!1;const t=this.selectedItem.dataset.uuid;if(!t)return;l.getObjectManager().getObjectByUUID(t)&&l.getSelectionManager().doResetSelected(),this.selectedItem=null}viewportDeselect(){this.selectedItem&&(this.selectedItem.selected=!1,this.selectedItem=null)}}class xo{constructor(){const t=new Si(l.getRenderer());l.setEffectComposer(t),this.setupRenderPass()}setupRenderPass(){l.getEffectComposer().addPass(new Oi(l.getScene(),l.getCamera())),l.getEffectComposer().addPass(new Hi)}}class Eo{constructor(){}saveSceneToFile(t){const e=new Blob([this.objectsToJSON()],{type:"application/json"}),i=document.createElement("a");i.href=URL.createObjectURL(e),i.download=t,i.click(),URL.revokeObjectURL(i.href),l.getInteractionsManager().toast("Scene saved","Scene saved successfully!","success")}saveSceneToCache(){localStorage.setItem("scene",this.objectsToJSON())}loadSceneFromFile(){const t=document.createElement("input");t.type="file",t.accept=".svis",t.onchange=e=>{try{const n=e.target.files?.item(0);if(n){const s=new FileReader;s.onload=r=>{const a=r.target;this.objectsFromJSON(a.result)},s.readAsText(n)}}catch(i){console.warn("Error while loading JSON file: ",i)}},t.click()}loadSceneFromCache(){const t=localStorage.getItem("scene");t&&this.objectsFromJSON(t,!0)}clearSceneCache(){localStorage.removeItem("scene")}setFlagCache(t,e){localStorage.setItem(t,e.toString())}getFlagCache(t){const e=localStorage.getItem(t);return e?e==="true":!1}objectsToJSON(){return JSON.stringify({"2d":l.dimension2D(),scene:l.getSceneProxy().toJSON(),objects:l.getObjectManager().getObjects().map(t=>t.toJSON())},null,1)}objectsFromJSON(t,e=!1){try{const i=JSON.parse(t);if(i["2d"]==null||i["2d"]==null)throw new Error("Could not find the 2d flag in the JSON file!");if(i.scene==null||i.scene==null)throw new Error("Could not find the scene object in the JSON file!");if(i.objects==null||i.objects==null)throw new Error("Could not find the objects array in the JSON file!");(i["2d"]&&!l.dimension2D()||!i["2d"]&&l.dimension2D())&&l.switchDimension(),l.getSceneProxy().fromJSON(i.scene);for(const n of i.objects)So.createVisualObject(n);e?i.objects&&i.objects.length>0&&l.getInteractionsManager().toast("Last Session restored","The Last Session was restored successfully!","success"):l.getInteractionsManager().toast("Scene loaded","Scene loaded successfully!","success")}catch(i){console.error("Error while loading JSON file: ",i),l.getInteractionsManager().toast("Error","Error while loading JSON file: <br />"+i,"error")}}}class So{static createVisualObject(t){const e=t.type;if(!e){console.warn("Object type not found!");return}switch(e){case"LinearCurveObject":l.getCreationManager().createJSONLinearCurve(t);break;case"BezierCurveObject":l.getCreationManager().createJSONBezierCurve(t);break;case"BezierSplineObject":l.getCreationManager().createJSONBezierSpline(t);break;case"UniformBSplineObject":l.getCreationManager().createJSONUniformBSpline(t);break;case"UniformRationBSplineObject":l.getCreationManager().createJSONURBS(t);break;case"BezierPatchObject":l.getCreationManager().createJSONBezierPatch(t);break;case"UniformBSplineSurfaceObject":l.getCreationManager().createJSONUniformBSplineSurface(t);break;case"UniformRationalBSplineSurfaceObject":l.getCreationManager().createJSONUniformRationalBSplineSurface(t);break;default:console.warn(`Unknown object type: ${e}`);break}}}var Xt=(o=>(o.OBJ="OBJ",o.STL="STL",o.GLTF="GLTF",o))(Xt||{});class Oo{constructor(){}isExportable(t){return t.getExport()!==null}export(t){this.exportDialog(t)}exportDialog(t){const e=document.createElement("sl-dialog");e.label="Export to "+t,e.classList.add("export-dialog");const i=document.createElement("div");i.innerHTML="",e.appendChild(i);const n=l.getSelectionManager().getSelectedObject();if(n!=null)if(this.isExportable(n)){i.innerHTML+=`Selected object <b> ${n.getName()} </b> can be exported to <b> ${t} </b>.<br>`;const d=document.createElement("sl-button");d.variant="primary",d.innerText="Export Object",d.slot="footer",d.onclick=()=>{this.exportObject(n,t),e.hide()},e.appendChild(d)}else i.innerHTML+=`Selected object <b> ${n.getName()} </b> cannot be exported.<br>`;if(this.exportableObjectExists()){i.innerHTML+="Export all objects that can be exported.";const h=document.createElement("sl-button");h.variant="success",h.innerText="Export All",h.slot="footer",h.onclick=()=>{this.exportAll(t),e.hide()},e.appendChild(h)}else i.innerHTML+="No exportable objects available.";const a=document.createElement("sl-button");a.variant="danger",a.innerText="Cancel",a.slot="footer",a.onclick=()=>{e.hide()},e.appendChild(a),document.body.appendChild(e),e.show()}exportableObjectExists(){const t=l.getObjectManager().getObjects();for(const e of t)if(this.isExportable(e))return!0;return!1}exportAll(t){const e=new yi,i=l.getObjectManager().getObjects();for(const n of i)if(this.isExportable(n)){const s=n.getExport();if(s!==null){const r=s();r!==null&&(r.updateMatrixWorld(!0),e.add(r))}}e.children.length>0?this.exportToType(e,"exported_objects",t):console.warn("No exportable objects found.")}exportObject(t,e){const i=t.getExport();if(i===null){console.warn("Export function not available for this object.");return}const n=i();if(n===null){console.warn("Export function returned null mesh.");return}this.exportToType(n,t.getName(),e)}exportToType(t,e,i){switch(i){case"OBJ":this.exportToOBJ(t,e);break;case"STL":this.exportToSTL(t,e);break;case"GLTF":this.exportToGLTF(t,e);break;default:console.warn("Export type not supported.");break}}exportToOBJ(t,e){const n=new Ii().parse(t);this.downloadFile(n,e.replaceAll(" ","_")+".obj")}exportToSTL(t,e){const n=new ji().parse(t,{binary:!1});this.downloadFile(n,e.replaceAll(" ","_")+".stl")}exportToGLTF(t,e){new Vi().parse(t,n=>{const s=JSON.stringify(n);this.downloadFile(s,e.replaceAll(" ","_")+".gltf")},n=>{console.error("Error exporting to GLTF:",n)})}downloadFile(t,e){const i=new Blob([t],{type:"text/plain"}),n=URL.createObjectURL(i),s=document.createElement("a");s.href=n,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}}class Ho{closed=!1;constructor(t){const e=document.createElement("div");e.className="toolbar";const i=document.createElement("div");i.style.display=l.getIOManager().getFlagCache("toolbarClosed")?"none":"flex",i.style.flexDirection="row",i.style.flexWrap="wrap",e.appendChild(i);const n=document.createElement("sl-button-group");n.label="Scene Management",i.appendChild(n);const s=document.createElement("sl-dropdown");n.appendChild(s);const r=document.createElement("sl-button");r.textContent="File",r.slot="trigger",r.size="medium",r.caret=!0,s.appendChild(r);const a=document.createElement("sl-menu");s.appendChild(a);const h=document.createElement("sl-menu-item"),d=document.createElement("sl-icon");d.library="lucide",d.name="save",d.slot="prefix",h.appendChild(d);const u=document.createTextNode("Save");h.appendChild(u),h.value="save",a.appendChild(h);const m=document.createElement("sl-menu-item"),p=document.createElement("sl-icon");p.library="lucide",p.name="file-up",p.slot="prefix",m.appendChild(p);const g=document.createTextNode("Load");m.appendChild(g),m.value="load",a.appendChild(m);const f=document.createElement("sl-menu-item"),w=document.createElement("sl-icon");w.library="lucide",w.name="folder-pen",w.slot="prefix",f.appendChild(w);const P=document.createTextNode("Examples");f.appendChild(P);const b=document.createElement("sl-menu");b.slot="submenu",f.appendChild(b);const E=document.createElement("sl-menu-item"),x=document.createElement("sl-icon");x.name="cup-hot",x.slot="prefix",E.appendChild(x);const C=document.createTextNode("Utah Teapot");E.appendChild(C),E.value="teapot",b.appendChild(E);const S=document.createElement("sl-menu-item"),H=document.createElement("sl-icon");H.name="cup-hot",H.slot="prefix",S.appendChild(H);const U=document.createTextNode("Utah Teapot (Colorful)");S.appendChild(U),S.value="teapotColor",b.appendChild(S);const T=document.createElement("sl-menu-item"),N=document.createElement("sl-icon");N.name="cup-hot",N.slot="prefix",T.appendChild(N);const ot=document.createTextNode("Utah Teapot (Reflective)");T.appendChild(ot),T.value="shinyTeapotColor",b.appendChild(T),a.appendChild(f);const K=document.createElement("sl-menu-item"),$=document.createElement("sl-icon");$.library="lucide",$.name="folder-output",$.slot="prefix",K.appendChild($);const kt=document.createTextNode("Export");K.appendChild(kt);const Z=document.createElement("sl-menu");Z.slot="submenu",K.appendChild(Z);const ft=document.createElement("sl-menu-item"),ae=document.createTextNode("OBJ");ft.appendChild(ae),ft.value="exportOBJ",Z.appendChild(ft);const wt=document.createElement("sl-menu-item"),je=document.createTextNode("STL");wt.appendChild(je),wt.value="exportSTL",Z.appendChild(wt);const le=document.createElement("sl-menu-item"),gi=document.createTextNode("GLTF");le.appendChild(gi),le.value="exportGLTF",Z.appendChild(le),a.appendChild(K),a.addEventListener("sl-select",fi=>{switch(fi.detail.item.value){case"save":this.save();break;case"load":this.load();break;case"teapot":this.loadTeapot();break;case"teapotColor":this.loadTeapotColor();break;case"shinyTeapotColor":this.loadShinyTeapotColor();break;case"exportOBJ":this.exportOBJ();break;case"exportSTL":this.exportSTL();break;case"exportGLTF":this.exportGLTF();break;default:console.warn("Unknown menu item selected!");break}});const It=document.createElement("sl-button"),Wt=document.createElement("sl-icon");Wt.library="lucide",Wt.name="list-restart",Wt.slot="prefix",It.appendChild(Wt);const pi=document.createTextNode("Reset Scene");It.appendChild(pi),It.size="medium",It.onclick=()=>this.resetScene(),n.appendChild(It);const bt=document.createElement("sl-button");bt.textContent=l.dimension2D()?"3D":"2D",bt.size="medium",bt.style.marginLeft="0.5rem",bt.onclick=()=>{l.switchDimension(),bt.textContent=l.dimension2D()?"3D":"2D"},i.appendChild(bt);const vt=document.createElement("sl-button"),Pt=document.createElement("sl-icon");Pt.library="lucide",Pt.name="sun",Pt.slot="prefix",Pt.style.display=l.darkMode()?"block":"none",vt.appendChild(Pt);const Ct=document.createElement("sl-icon");Ct.library="lucide",Ct.name="moon",Ct.slot="prefix",Ct.style.display=l.darkMode()?"none":"block",vt.appendChild(Ct),vt.size="medium",vt.style.marginLeft="0.5rem",vt.onclick=()=>{l.setMode(!l.darkMode()),Pt.style.display=l.darkMode()?"block":"none",Ct.style.display=l.darkMode()?"none":"block"},i.appendChild(vt);const jt=document.createElement("sl-button"),Ft=document.createElement("sl-icon");Ft.library="lucide",Ft.name="chevron-left",Ft.slot="prefix",jt.appendChild(Ft),jt.size="medium",jt.style.marginLeft="0.5rem",jt.onclick=()=>{this.closed=!0,i.style.display="none",dt.style.display="flex",l.getIOManager().setFlagCache("toolbarClosed",!0)},i.appendChild(jt);const dt=document.createElement("sl-button"),At=document.createElement("sl-icon");At.library="lucide",At.name="chevron-right",At.slot="prefix",dt.appendChild(At),dt.size="medium",dt.style.display=l.getIOManager().getFlagCache("toolbarClosed")?"":"none",dt.onclick=()=>{this.closed=!1,i.style.display="flex",dt.style.display="none",l.getIOManager().setFlagCache("toolbarClosed",!1)},e.appendChild(dt),t.appendChild(e)}save(){const e=new Date().toISOString().split(".")[0].replaceAll("-","_").replace("T","-").replaceAll(":","_");l.getIOManager().saveSceneToFile("SplineVis_"+e+".svis")}load(){l.getIOManager().loadSceneFromFile()}loadTeapot(){de(2,!1)}loadTeapotColor(){de(2,!0)}loadShinyTeapotColor(){de(2,!1,1)}exportOBJ(){l.getExportManager().export(Xt.OBJ)}exportSTL(){l.getExportManager().export(Xt.STL)}exportGLTF(){l.getExportManager().export(Xt.GLTF)}resetScene(){l.getInteractionsManager().confirm("Reset Scene","Are you sure you want to reset the scene?",t=>{t&&(l.getTransformControls().detach(),l.getObjectManager().removeObjects(),l.getIOManager().clearSceneCache(),l.getSceneProxy().reset(),M.notify("sceneReset",y.ALL))})}}class Ie{keydowns;static blockedTags=["SL-INPUT","SL-COLOR-PICKER"];dialog;constructor(){this.keydowns=new Map,this.dialog=document.createElement("sl-dialog"),window.addEventListener("keydown",t=>{const e=t.key,i=t.target;Ie.blockedTags.includes(i.tagName)||this.keydowns.has(e)&&this.keydowns.get(e)?.forEach(n=>n())}),this.addKeydown("d",()=>{l.switchDimension()})}addKeydown(t,e){this.keydowns.has(t)?this.keydowns.get(t)?.push(e):this.keydowns.set(t,[e])}addKeydowns(t,e){t.forEach(i=>this.addKeydown(i,e))}toast(t,e,i){const n=i==="setting"?"neutral":i==="info"?"primary":i==="error"?"danger":i,s=i==="info"?"info":i==="success"?"circle-check-big":i==="setting"?"settings":i==="warning"?"triangle-alert":i==="error"?"circle-x":"message-circle-warning",r=document.createElement("sl-alert");r.variant=n,r.closable=!1,r.duration=1e3;const a=document.createElement("sl-icon");a.name=s,a.library="lucide",a.slot="icon",r.appendChild(a);const h=document.createElement("span");h.innerHTML="<strong>"+t+"</strong><br />"+e,r.appendChild(h);const d=Object.assign(r);document.body.appendChild(d),r.toast()}confirm(t,e,i){this.dialog.innerHTML="",this.dialog.label=t,this.dialog.classList.add("confirm-dialog"),this.dialog.style.color="var(--sl-input-color)",this.dialog.addEventListener("sl-request-close",a=>{i(!1)});const n=document.createElement("div");n.innerHTML=e,this.dialog.appendChild(n);const s=document.createElement("sl-button");s.variant="success",s.innerText="Confirm",s.slot="footer",s.onclick=()=>{i(!0),this.dialog.hide()},this.dialog.appendChild(s);const r=document.createElement("sl-button");r.variant="danger",r.innerText="Cancel",r.slot="footer",r.onclick=()=>{i(!1),this.dialog.hide()},this.dialog.appendChild(r),l.getApp().appendChild(this.dialog),this.dialog.show()}}class Io extends q{mode;dirRotation;dirIntensity;dirColor;ambIntensity;ambColor;envMap;envIntensity;constructor(){const t=new Ke(new Ge(0),new Je);t.visible=!1,super("SceneProxyObject",t),this.type="SceneProxyObject",this.mode=0,this.dirRotation=0,this.dirIntensity=1,this.dirColor="#ffffff",this.ambIntensity=.2,this.ambColor="#f0f0f0",this.envMap="outdoor",this.envIntensity=1}reset(){this.dirRotation=0,this.dirIntensity=1,this.dirColor="#ffffff",this.ambIntensity=.2,this.ambColor="#f0f0f0",this.envMap="outdoor",this.envIntensity=1}getMode(){return this.mode}setMode(t){this.mode=t}toJSON(){return{name:this.name,type:this.type,position:this.getPosition(),color:this.color.getHex(),mode:this.mode,dirRotation:this.dirRotation,dirIntensity:this.dirIntensity,dirColor:this.dirColor,ambIntensity:this.ambIntensity,ambColor:this.ambColor,envMap:this.envMap,envIntensity:this.envIntensity}}fromJSON(t){this.mode=t.mode??0,this.dirRotation=t.dirRotation??0,this.dirIntensity=t.dirIntensity??1,this.dirColor=t.dirColor??"#ffffff",this.ambIntensity=t.ambIntensity??.3,this.ambColor=t.ambColor??"#f0f0f0",this.envMap=t.envMap??"outdoor",this.envIntensity=t.envIntensity??1}highlight(){}resetHighlight(){}select(){}resetSelect(){}updateColor(t){}dispose(){}}function jo(){Bi("lucide",{resolver:b=>`https://cdn.jsdelivr.net/npm/lucide-static@0.482.0/icons/${b}.svg`});const o=document.getElementById("app");if(!o)return;const t=document.getElementById("viewport");if(!t)return;const e=document.getElementById("inspector");if(!e)return;const i=document.getElementById("hierarchy");if(!i)return;l.setApp(o),Xi(t),Yi(),qi(t);const n=new tn;l.setObjectManager(n);const s=new dn;l.setCreationManager(s);const r=new un;l.setSelectionManager(r);const a=new mn;l.setEditManager(a);const h=new xo;l.setEffectManager(h);const d=new Eo;l.setIOManager(d),Zi();const u=new Ie;l.setInteractionsManager(u);const m=new Oo;l.setExportManager(m);const p=new gn(t);l.setControls(p);const g=new Mo(i);l.setHierarchy(g);const f=new Co(e);l.setInspector(f);const w=new Ho(t);l.setToolbar(w);const P=new Io;l.setSceneProxy(P),l.getIOManager().loadSceneFromCache(),document.addEventListener("DOMContentLoaded",()=>{M.notify("start",y.ALL)}),mi()}function mi(){requestAnimationFrame(mi),l.getEffectComposer().render(),l.getOrbitControls().update(),l.getSelectionManager().update()}jo();
